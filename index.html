<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArchaeoPoint - От раскопа до карты в один клик</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#8B4513">
    <style>
        /* Основные стили */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #8B4513;
            --secondary-color: #D2691E;
            --accent-color: #F4A460;
            --dark-color: #3E2723;
            --light-color: #FAF3E0;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
            transition: var(--transition);
        }

        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }

        .container {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Уведомление о работе в офлайн-режиме */
        #offline-notification {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #f39c12;
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 2000;
            display: none;
        }

        #offline-notification.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        /* Прогресс бар загрузки */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background-color: var(--primary-color);
            width: 0%;
            z-index: 2001;
            transition: width 0.3s ease;
        }

        /* Шапка */
        header {
            background: linear-gradient(135deg, var(--dark-color), var(--primary-color));
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            z-index: 1000;
        }

        .dark-mode header {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .logo .tagline {
            font-size: 0.9rem;
            opacity: 0.9;
            font-style: italic;
        }

        .logo-icon {
            font-size: 2rem;
            color: var(--accent-color);
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 1rem;
        }

        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        nav a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            padding: 0.3rem 0.8rem;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .sync-status.syncing {
            color: #f39c12;
        }

        .sync-status.synced {
            color: #27ae60;
        }

        .sync-status.offline {
            color: #e74c3c;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .avatar {
            width: 40px;
            height: 40px;
            background-color: var(--accent-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Основной контент */
        main {
            flex: 1;
            padding: 2rem;
        }

        .dark-mode main {
            background-color: #121212;
        }

        /* Стили для страниц */
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Защитный шлюз / Вход */
        .gatekeeper {
            max-width: 500px;
            margin: 4rem auto;
            padding: 3rem;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .dark-mode .gatekeeper {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }

        .gatekeeper h2 {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .gatekeeper p {
            margin-bottom: 2rem;
            color: #666;
            line-height: 1.6;
        }

        .dark-mode .gatekeeper p {
            color: #aaa;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark-color);
        }

        .dark-mode .form-group label {
            color: #e0e0e0;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background-color: white;
            color: #333;
        }

        .dark-mode .form-control {
            background-color: #2d2d2d;
            border-color: #444;
            color: #e0e0e0;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon .form-control {
            padding-left: 3rem;
        }

        .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        /* 2FA стили */
        .two-factor-form {
            display: none;
        }

        .two-factor-code {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .two-factor-code input {
            width: 100%;
            height: 50px;
            text-align: center;
            font-size: 1.5rem;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
        }

        .two-factor-code input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .btn {
            display: inline-block;
            padding: 0.75rem 2rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
        }

        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-warning {
            background-color: var(--warning-color);
        }

        .btn-info {
            background-color: var(--info-color);
        }

        .btn-block {
            width: 100%;
        }

        .btn-sm {
            padding: 0.4rem 1rem;
            font-size: 0.9rem;
        }

        .link-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.9rem;
        }

        .dark-mode .link-btn {
            color: var(--accent-color);
        }

        .alert {
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .dark-mode .alert-success {
            background-color: #155724;
            color: #d4edda;
        }

        .dark-mode .alert-info {
            background-color: #0c5460;
            color: #d1ecf1;
        }

        /* Добро пожаловать */
        .welcome-hero {
            text-align: center;
            padding: 3rem 2rem;
            background: linear-gradient(135deg, var(--light-color), #fff);
            border-radius: var(--border-radius);
            margin-bottom: 3rem;
            box-shadow: var(--shadow);
        }

        .dark-mode .welcome-hero {
            background: linear-gradient(135deg, #2d2d2d, #1e1e1e);
        }

        .welcome-hero h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .welcome-hero p {
            font-size: 1.2rem;
            color: #555;
            max-width: 800px;
            margin: 0 auto 2rem;
            line-height: 1.6;
        }

        .dark-mode .welcome-hero p {
            color: #aaa;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 3rem;
        }

        .feature-card {
            background-color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .dark-mode .feature-card {
            background-color: #1e1e1e;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .feature-card h3 {
            margin-bottom: 1rem;
            color: var(--dark-color);
        }

        .dark-mode .feature-card h3 {
            color: #e0e0e0;
        }

        /* Интерактивная карта */
        #map-container {
            height: 600px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 300px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .dark-mode .map-controls {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }

        .map-controls h3 {
            margin-bottom: 1rem;
            color: var(--primary-color);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .map-controls-section {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .dark-mode .map-controls-section {
            border-bottom-color: #444;
        }

        .map-controls-section h4 {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }

        .dark-mode .map-controls-section h4 {
            color: #aaa;
        }

        .layer-control, .artifact-control {
            margin-bottom: 0.5rem;
        }

        .layer-control label, .artifact-control label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .color-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            border: 1px solid #ddd;
        }

        .artifact-gold { background-color: #FFD700; }
        .artifact-ceramic { background-color: #8B4513; }
        .artifact-bones { background-color: #F5F5DC; }
        .artifact-metal { background-color: #C0C0C0; }
        .artifact-stone { background-color: #808080; }
        .artifact-other { background-color: #9370DB; }

        .map-tools {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .map-tool-btn {
            padding: 0.5rem 1rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
        }

        .map-tool-btn:hover {
            background-color: var(--secondary-color);
        }

        .map-tool-btn.active {
            background-color: var(--secondary-color);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .map-measurement-result {
            position: absolute;
            background-color: white;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1000;
            display: none;
        }

        .dark-mode .map-measurement-result {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }

        /* Панель управления */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .dashboard-card {
            background-color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .dark-mode .dashboard-card {
            background-color: #1e1e1e;
        }

        .dashboard-card h3 {
            margin-bottom: 1.5rem;
            color: var(--primary-color);
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light-color);
        }

        .dark-mode .dashboard-card h3 {
            border-bottom-color: #333;
        }

        .statistics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
        }

        .dark-mode .stat-item {
            background-color: #2d2d2d;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .dark-mode .stat-label {
            color: #aaa;
        }

        .user-list {
            list-style: none;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .dark-mode .user-item {
            border-bottom-color: #333;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-role {
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .role-admin { background-color: #d4edda; color: #155724; }
        .role-archaeologist { background-color: #d1ecf1; color: #0c5460; }
        .role-assistant { background-color: #fff3cd; color: #856404; }

        .dark-mode .role-admin { background-color: #155724; color: #d4edda; }
        .dark-mode .role-archaeologist { background-color: #0c5460; color: #d1ecf1; }
        .dark-mode .role-assistant { background-color: #856404; color: #fff3cd; }

        /* Карточка артефакта */
        .artifact-form {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .dark-mode .artifact-form {
            background-color: #1e1e1e;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .form-full {
            grid-column: 1 / -1;
        }

        .coordinate-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        .coordinate-inputs .form-control {
            text-align: center;
            font-family: monospace;
        }

        .gps-accuracy {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .dark-mode .gps-accuracy {
            color: #aaa;
        }

        .photo-upload {
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .photo-upload:hover {
            border-color: var(--primary-color);
        }

        .photo-upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .batch-upload-btn {
            margin-top: 1rem;
        }

        .photo-preview {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .photo-preview img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: var(--border-radius);
            position: relative;
        }

        .photo-preview .remove-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-suggestion {
            background-color: #e8f4fd;
            border-left: 4px solid #3498db;
            padding: 0.75rem;
            margin-top: 0.5rem;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        .dark-mode .ai-suggestion {
            background-color: #0c3a5c;
        }

        .ai-suggestion p {
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }

        .dark-mode .ai-suggestion p {
            color: #e0e0e0;
        }

        .ai-confidence {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .voice-input-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .voice-input-btn.listening {
            color: #e74c3c;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Личный кабинет */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid #eee;
        }

        .dark-mode .profile-header {
            border-bottom-color: #333;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            background-color: var(--accent-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            font-weight: bold;
        }

        .profile-info h2 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Таблицы */
        .table-container {
            overflow-x: auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .dark-mode .table-container {
            background-color: #1e1e1e;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .dark-mode th, .dark-mode td {
            border-bottom-color: #333;
        }

        th {
            background-color: var(--light-color);
            color: var(--primary-color);
            font-weight: 600;
        }

        .dark-mode th {
            background-color: #2d2d2d;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .dark-mode tr:hover {
            background-color: #2d2d2d;
        }

        /* Подвал */
        footer {
            background-color: var(--dark-color);
            color: white;
            padding: 2rem;
            text-align: center;
            margin-top: 3rem;
        }

        .dark-mode footer {
            background-color: #1a1a1a;
        }

        footer p {
            margin-bottom: 1rem;
            opacity: 0.8;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .footer-links a {
            color: white;
            text-decoration: none;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .footer-links a:hover {
            opacity: 1;
        }

        /* Мобильная адаптация */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            nav ul {
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem;
            }

            .header-controls {
                flex-wrap: wrap;
                justify-content: center;
            }

            .map-controls {
                position: relative;
                top: 0;
                right: 0;
                width: 100%;
                margin-bottom: 1rem;
                max-height: 300px;
            }

            #map-container {
                height: 400px;
            }

            .welcome-hero h1 {
                font-size: 1.8rem;
            }

            .welcome-hero p {
                font-size: 1rem;
            }

            .gatekeeper {
                margin: 2rem auto;
                padding: 2rem 1.5rem;
            }

            .coordinate-inputs {
                grid-template-columns: 1fr;
            }
        }

        /* Стили для модальных окон */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
        }

        .dark-mode .modal-content {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .dark-mode .modal-header {
            border-bottom-color: #333;
        }

        .modal-header h3 {
            color: var(--primary-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        /* Конструктор отчетов */
        .report-builder {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        .report-fields {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: var(--border-radius);
        }

        .dark-mode .report-fields {
            background-color: #2d2d2d;
        }

        .report-preview {
            padding: 1.5rem;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            min-height: 500px;
        }

        .dark-mode .report-preview {
            background-color: #1e1e1e;
        }

        .field-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        /* Стратиграфия */
        .stratigraphy-visualization {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .stratigraphy-layers {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            max-height: 500px;
            overflow-y: auto;
        }

        .dark-mode .stratigraphy-layers {
            background-color: #2d2d2d;
        }

        .stratigraphy-canvas {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
            min-height: 500px;
        }

        .dark-mode .stratigraphy-canvas {
            background-color: #1e1e1e;
        }

        .layer-item {
            padding: 1rem;
            background-color: white;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            cursor: move;
            border-left: 4px solid #8B4513;
        }

        .dark-mode .layer-item {
            background-color: #2d2d2d;
        }

        /* Пакетная загрузка */
        .batch-upload {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .batch-files {
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .batch-preview {
            max-height: 400px;
            overflow-y: auto;
        }

        .batch-file-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
        }

        .dark-mode .batch-file-item {
            border-bottom-color: #333;
        }

        /* 3D визуализация */
        .visualization-3d {
            height: 500px;
            border-radius: var(--border-radius);
            overflow: hidden;
            background-color: #f0f0f0;
            position: relative;
        }

        .dark-mode .visualization-3d {
            background-color: #2d2d2d;
        }

        .visualization-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }

        /* Тепловая карта */
        .heatmap-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1000;
        }

        .dark-mode .heatmap-legend {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }

        .heatmap-gradient {
            width: 200px;
            height: 20px;
            background: linear-gradient(to right, blue, cyan, green, yellow, red);
            border-radius: 4px;
            margin: 0.5rem 0;
        }

        /* QR-код стили */
        .qr-code-container {
            text-align: center;
            padding: 1.5rem;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .dark-mode .qr-code-container {
            background-color: #1e1e1e;
        }

        .qr-code {
            width: 200px;
            height: 200px;
            margin: 1rem auto;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #666;
            border: 1px dashed #ddd;
        }

        .dark-mode .qr-code {
            background-color: #2d2d2d;
            color: #aaa;
        }

        /* Стили для Leaflet */
        .leaflet-control-zoom {
            margin-top: 10px !important;
            margin-right: 10px !important;
        }

        .leaflet-control-layers {
            margin-top: 10px !important;
            margin-right: 10px !important;
        }

        .measurement-line {
            stroke: #ff0000;
            stroke-width: 3;
            stroke-dasharray: 10, 10;
        }

        .measurement-label {
            background-color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }

        .dark-mode .measurement-label {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <!-- Прогресс бар загрузки -->
    <div class="progress-bar" id="progress-bar"></div>
    
    <!-- Уведомление о работе в офлайн-режиме -->
    <div id="offline-notification">
        <i class="fas fa-wifi-slash"></i> Вы работаете в офлайн-режиме. Данные будут синхронизированы при восстановлении соединения.
        <span id="pending-changes">0 изменений ожидают синхронизации</span>
    </div>
    
    <div class="container">
        <!-- Защитный шлюз (Gatekeeper) - первая страница -->
        <div id="gatekeeper-page" class="page active">
            <div class="gatekeeper">
                <div class="logo" style="justify-content: center; margin-bottom: 2rem;">
                    <div class="logo-icon">
                        <i class="fas fa-map-marked-alt"></i>
                    </div>
                    <div>
                        <h1>ArchaeoPoint</h1>
                        <div class="tagline">От раскопа до карты в один клик</div>
                    </div>
                </div>
                
                <h2>Защищенный доступ к данным</h2>
                <p>Введите токен экспедиции или данные для входа в систему. Доступ предоставляется только авторизованным участникам археологических исследований.</p>
                
                <div id="login-form">
                    <div class="form-group">
                        <label for="login-token">Токен экспедиции / Email</label>
                        <div class="input-with-icon">
                            <i class="fas fa-user input-icon"></i>
                            <input type="text" id="login-token" class="form-control" placeholder="Введите токен или email">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="login-password">Пароль</label>
                        <div class="input-with-icon">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="login-password" class="form-control" placeholder="Введите пароль">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="field-checkbox">
                            <input type="checkbox" id="remember-me">
                            <label for="remember-me">Запомнить меня</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button id="login-btn" class="btn btn-block">
                            <i class="fas fa-sign-in-alt"></i> Войти в систему
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <button id="enable-2fa" class="btn btn-secondary btn-block">
                            <i class="fas fa-shield-alt"></i> Войти с двухфакторной аутентификацией
                        </button>
                    </div>
                    
                    <div class="form-group" style="text-align: center;">
                        <button id="show-register" class="link-btn">Запросить доступ</button>
                    </div>
                </div>
                
                <!-- Форма двухфакторной аутентификации -->
                <div id="two-factor-form" class="two-factor-form">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> На ваш телефон отправлен код подтверждения. Введите 6-значный код для входа.
                    </div>
                    
                    <div class="form-group">
                        <label>Код подтверждения</label>
                        <div class="two-factor-code">
                            <input type="text" maxlength="1" pattern="[0-9]">
                            <input type="text" maxlength="1" pattern="[0-9]">
                            <input type="text" maxlength="1" pattern="[0-9]">
                            <input type="text" maxlength="1" pattern="[0-9]">
                            <input type="text" maxlength="1" pattern="[0-9]">
                            <input type="text" maxlength="1" pattern="[0-9]">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button id="verify-2fa-btn" class="btn btn-success btn-block">
                            <i class="fas fa-check"></i> Подтвердить
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <button id="resend-code-btn" class="btn btn-secondary btn-block">
                            <i class="fas fa-redo"></i> Отправить код повторно
                        </button>
                    </div>
                    
                    <div class="form-group" style="text-align: center;">
                        <button id="back-to-login" class="link-btn">Вернуться к обычному входу</button>
                    </div>
                </div>
                
                <!-- Форма регистрации -->
                <div id="register-form" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Запрос доступа отправляется начальнику экспедиции. После подтверждения вам будет предоставлен доступ.
                    </div>
                    
                    <div class="form-group">
                        <label for="register-name">ФИО</label>
                        <input type="text" id="register-name" class="form-control" placeholder="Введите ваше полное имя">
                    </div>
                    
                    <div class="form-group">
                        <label for="register-email">Email</label>
                        <input type="email" id="register-email" class="form-control" placeholder="Введите ваш email">
                    </div>
                    
                    <div class="form-group">
                        <label for="register-phone">Телефон</label>
                        <input type="tel" id="register-phone" class="form-control" placeholder="+7 (XXX) XXX-XX-XX">
                    </div>
                    
                    <div class="form-group">
                        <label for="register-expedition">Название экспедиции</label>
                        <input type="text" id="register-expedition" class="form-control" placeholder="Введите название экспедиции">
                    </div>
                    
                    <div class="form-group">
                        <label for="register-role">Роль в экспедиции</label>
                        <select id="register-role" class="form-control">
                            <option value="archaeologist">Археолог</option>
                            <option value="assistant">Помощник</option>
                            <option value="student">Студент</option>
                            <option value="researcher">Исследователь</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="register-message">Дополнительная информация</label>
                        <textarea id="register-message" class="form-control" rows="3" placeholder="Расскажите о себе и причинах запроса доступа"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <div class="field-checkbox">
                            <input type="checkbox" id="enable-2fa-register">
                            <label for="enable-2fa-register">Включить двухфакторную аутентификацию для моего аккаунта</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button id="register-btn" class="btn btn-block btn-success">
                            <i class="fas fa-paper-plane"></i> Отправить запрос
                        </button>
                    </div>
                    
                    <div class="form-group" style="text-align: center;">
                        <button id="show-login" class="link-btn">Вернуться ко входу</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Шапка сайта (видна только после авторизации) -->
        <header id="site-header" style="display: none;">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-map-marked-alt"></i>
                </div>
                <div>
                    <h1>ArchaeoPoint</h1>
                    <div class="tagline">От раскопа до карты в один клик</div>
                </div>
            </div>
            
            <nav>
                <ul>
                    <li><a href="#" id="nav-welcome">Главная</a></li>
                    <li><a href="#" id="nav-map">Карта раскопок</a></li>
                    <li><a href="#" id="nav-artifacts">Артефакты</a></li>
                    <li><a href="#" id="nav-dashboard">Панель управления</a></li>
                    <li><a href="#" id="nav-profile">Личный кабинет</a></li>
                </ul>
            </nav>
            
            <div class="header-controls">
                <div class="sync-status" id="sync-status">
                    <i class="fas fa-sync"></i>
                    <span>Синхронизировано</span>
                </div>
                
                <button class="theme-toggle" id="theme-toggle" title="Сменить тему">
                    <i class="fas fa-moon"></i>
                </button>
                
                <div class="user-info">
                    <div class="avatar" id="user-avatar">ИИ</div>
                    <div>
                        <div id="user-name">Иван Археологов</div>
                        <div id="user-role" style="font-size: 0.8rem; opacity: 0.8;">Археолог</div>
                    </div>
                    <button id="logout-btn" class="btn btn-secondary" style="padding: 0.5rem 1rem; margin-left: 1rem;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Основной контент (виден только после авторизации) -->
        <main id="main-content" style="display: none;">
            <!-- Главная страница -->
            <div id="welcome-page" class="page active">
                <div class="welcome-hero">
                    <h1>Добро пожаловать в ArchaeoPoint</h1>
                    <p>Профессиональная платформа для цифровой фиксации и управления археологическими данными с точной ГИС-привязкой.</p>
                    <div class="map-tools" style="justify-content: center; margin-top: 2rem;">
                        <button id="goto-map-btn" class="btn">
                            <i class="fas fa-map-marked-alt"></i> Перейти к карте раскопок
                        </button>
                        <button id="quick-add-artifact" class="btn btn-success">
                            <i class="fas fa-plus-circle"></i> Быстро добавить артефакт
                        </button>
                    </div>
                </div>
                
                <div class="features">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-wifi-slash"></i>
                        </div>
                        <h3>Офлайн-режим</h3>
                        <p>Работайте без интернета. Данные сохраняются локально и автоматически синхронизируются при появлении соединения.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h3>AI распознавание</h3>
                        <p>Нейросеть анализирует фотографии и предлагает тип артефакта с указанием вероятности.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-microphone"></i>
                        </div>
                        <h3>Голосовой ввод</h3>
                        <p>Диктуйте описания голосом, когда руки заняты инструментами или испачканы землей.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <h3>3D фиксация</h3>
                        <p>Запись координат X, Y, Z для построения трехмерных моделей культурных слоев.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <h3>Тепловые карты</h3>
                        <p>Визуализация плотности находок для определения наиболее перспективных участков раскопа.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h3>Двухфакторная аутентификация</h3>
                        <p>Защита от неавторизованного доступа через SMS или приложение-аутентификатор.</p>
                    </div>
                </div>
            </div>

            <!-- Карта раскопок -->
            <div id="map-page" class="page">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="color: var(--primary-color);">
                        <i class="fas fa-map-marked-alt"></i> Интерактивная карта раскопок
                    </h2>
                    <div class="map-tools">
                        <button id="toggle-heatmap" class="map-tool-btn">
                            <i class="fas fa-fire"></i> Тепловая карта
                        </button>
                        <button id="toggle-3d" class="map-tool-btn">
                            <i class="fas fa-cube"></i> 3D вид
                        </button>
                        <button id="measure-distance" class="map-tool-btn">
                            <i class="fas fa-ruler"></i> Измерить
                        </button>
                    </div>
                </div>
                
                <p style="margin-bottom: 1.5rem; color: #666;">Используйте карту для визуализации находок, добавления новых артефактов и анализа расположения объектов.</p>
                
                <div id="map-container">
                    <div id="map"></div>
                    
                    <div class="map-controls">
                        <h3><i class="fas fa-layer-group"></i> Управление картой</h3>
                        
                        <div class="map-controls-section">
                            <h4>Слои карты:</h4>
                            <div class="layer-control">
                                <label>
                                    <input type="radio" name="map-layer" value="osm" checked> 
                                    <span>Спутниковая карта</span>
                                </label>
                            </div>
                            <div class="layer-control">
                                <label>
                                    <input type="radio" name="map-layer" value="topo"> 
                                    <span>Топографическая карта</span>
                                </label>
                            </div>
                            <div class="layer-control">
                                <label>
                                    <input type="radio" name="map-layer" value="scheme"> 
                                    <span>Схема раскопа</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="map-controls-section">
                            <h4>Типы артефактов:</h4>
                            <div class="artifact-control">
                                <label>
                                    <input type="checkbox" name="artifact-type" value="gold" checked> 
                                    <span class="color-indicator artifact-gold"></span>
                                    <span>Золотые изделия</span>
                                </label>
                            </div>
                            <div class="artifact-control">
                                <label>
                                    <input type="checkbox" name="artifact-type" value="ceramic" checked> 
                                    <span class="color-indicator artifact-ceramic"></span>
                                    <span>Керамика</span>
                                </label>
                            </div>
                            <div class="artifact-control">
                                <label>
                                    <input type="checkbox" name="artifact-type" value="bones" checked> 
                                    <span class="color-indicator artifact-bones"></span>
                                    <span>Костные останки</span>
                                </label>
                            </div>
                            <div class="artifact-control">
                                <label>
                                    <input type="checkbox" name="artifact-type" value="metal" checked> 
                                    <span class="color-indicator artifact-metal"></span>
                                    <span>Металлические изделия</span>
                                </label>
                            </div>
                            <div class="artifact-control">
                                <label>
                                    <input type="checkbox" name="artifact-type" value="stone" checked> 
                                    <span class="color-indicator artifact-stone"></span>
                                    <span>Каменные изделия</span>
                                </label>
                            </div>
                            <div class="artifact-control">
                                <label>
                                    <input type="checkbox" name="artifact-type" value="other" checked> 
                                    <span class="color-indicator artifact-other"></span>
                                    <span>Прочие находки</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="map-controls-section">
                            <h4>Инструменты:</h4>
                            <div class="map-tools">
                                <button id="add-artifact-btn" class="map-tool-btn">
                                    <i class="fas fa-plus"></i> Добавить находку
                                </button>
                                <button id="center-map-btn" class="map-tool-btn">
                                    <i class="fas fa-crosshairs"></i> Центрировать
                                </button>
                                <button id="show-legend-btn" class="map-tool-btn">
                                    <i class="fas fa-info-circle"></i> Легенда
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="map-measurement-result" id="measurement-result"></div>
                    <div class="heatmap-legend" id="heatmap-legend" style="display: none;">
                        <h4>Плотность находок</h4>
                        <div class="heatmap-gradient"></div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                            <span>Низкая</span>
                            <span>Высокая</span>
                        </div>
                    </div>
                </div>
                
                <!-- 3D визуализация -->
                <div class="visualization-3d" id="visualization-3d" style="display: none; margin-top: 2rem;">
                    <div style="position: absolute; top: 20px; left: 20px; color: #333; background-color: rgba(255,255,255,0.9); padding: 1rem; border-radius: var(--border-radius);">
                        <h4>3D визуализация культурных слоев</h4>
                        <p>Глубина отображена в метрах. Каждый цвет представляет разные типы артефактов.</p>
                    </div>
                    <div class="visualization-controls">
                        <button id="rotate-3d" class="btn btn-sm">
                            <i class="fas fa-sync"></i> Вращать
                        </button>
                        <button id="zoom-3d" class="btn btn-sm">
                            <i class="fas fa-search"></i> Приблизить
                        </button>
                        <button id="reset-3d" class="btn btn-sm">
                            <i class="fas fa-home"></i> Сброс
                        </button>
                    </div>
                </div>
            </div>

            <!-- Список артефактов -->
            <div id="artifacts-page" class="page">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="color: var(--primary-color);">
                        <i class="fas fa-history"></i> База артефактов
                    </h2>
                    <div class="map-tools">
                        <button id="new-artifact-btn" class="btn">
                            <i class="fas fa-plus"></i> Добавить артефакт
                        </button>
                        <button id="batch-upload-btn" class="btn btn-info">
                            <i class="fas fa-folder-plus"></i> Пакетная загрузка
                        </button>
                        <button id="export-artifacts-btn" class="btn btn-success">
                            <i class="fas fa-file-export"></i> Экспорт
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="artifacts-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Название</th>
                                <th>Тип</th>
                                <th>Дата находки</th>
                                <th>Координаты (X, Y, Z)</th>
                                <th>Нашедший</th>
                                <th>Слой</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="artifacts-table-body">
                            <!-- Данные загружаются через JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Стратиграфия -->
                <div class="stratigraphy-visualization">
                    <div class="stratigraphy-layers">
                        <h3>Стратиграфические слои</h3>
                        <div id="layers-list">
                            <!-- Слои загружаются через JavaScript -->
                        </div>
                        <button id="add-layer-btn" class="btn btn-block" style="margin-top: 1rem;">
                            <i class="fas fa-plus"></i> Добавить слой
                        </button>
                    </div>
                    <div class="stratigraphy-canvas" id="stratigraphy-canvas">
                        <div style="position: absolute; top: 20px; left: 20px; color: #333; background-color: rgba(255,255,255,0.9); padding: 1rem; border-radius: var(--border-radius);">
                            <h4>Визуализация стратиграфии</h4>
                            <p>Перетащите артефакты на слои для привязки</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Панель управления -->
            <div id="dashboard-page" class="page">
                <h2 style="margin-bottom: 1.5rem; color: var(--primary-color);">
                    <i class="fas fa-tachometer-alt"></i> Панель управления экспедицией
                </h2>
                
                <div class="dashboard">
                    <div class="dashboard-card">
                        <h3>Статистика экспедиции</h3>
                        <div class="statistics">
                            <div class="stat-item">
                                <div class="stat-value" id="total-artifacts">0</div>
                                <div class="stat-label">Всего артефактов</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="total-users">0</div>
                                <div class="stat-label">Участников</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="today-artifacts">0</div>
                                <div class="stat-label">Находок сегодня</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="last-week">0</div>
                                <div class="stat-label">За 7 дней</div>
                            </div>
                        </div>
                        
                        <h4 style="margin-top: 1.5rem;">Офлайн-данные</h4>
                        <div style="margin-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Ожидающие синхронизации:</span>
                                <span id="pending-sync-count">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Локальное хранилище:</span>
                                <span id="storage-usage">0 MB</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Конструктор отчетов</h3>
                        <p style="margin-bottom: 1.5rem;">Сформируйте отчет для сдачи в институт археологии:</p>
                        
                        <div class="report-builder">
                            <div class="report-fields">
                                <h4>Поля отчета:</h4>
                                <div class="field-checkbox">
                                    <input type="checkbox" id="field-id" checked>
                                    <label for="field-id">ID артефакта</label>
                                </div>
                                <div class="field-checkbox">
                                    <input type="checkbox" id="field-name" checked>
                                    <label for="field-name">Название</label>
                                </div>
                                <div class="field-checkbox">
                                    <input type="checkbox" id="field-type" checked>
                                    <label for="field-type">Тип</label>
                                </div>
                                <div class="field-checkbox">
                                    <input type="checkbox" id="field-coords" checked>
                                    <label for="field-coords">Координаты</label>
                                </div>
                                <div class="field-checkbox">
                                    <input type="checkbox" id="field-depth" checked>
                                    <label for="field-depth">Глубина</label>
                                </div>
                                <div class="field-checkbox">
                                    <input type="checkbox" id="field-context">
                                    <label for="field-context">Контекст</label>
                                </div>
                                <div class="field-checkbox">
                                    <input type="checkbox" id="field-photos">
                                    <label for="field-photos">Фотографии</label>
                                </div>
                                <div class="field-checkbox">
                                    <input type="checkbox" id="field-layer">
                                    <label for="field-layer">Стратиграфический слой</label>
                                </div>
                                
                                <div style="margin-top: 1.5rem;">
                                    <label for="report-format">Формат:</label>
                                    <select id="report-format" class="form-control" style="margin-top: 0.5rem;">
                                        <option value="pdf">PDF</option>
                                        <option value="excel">Excel</option>
                                        <option value="shapefile">Shapefile</option>
                                        <option value="kml">KML (Google Earth)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="report-preview">
                                <h4>Предварительный просмотр</h4>
                                <div id="report-preview-content" style="margin-top: 1rem;">
                                    <!-- Предпросмотр отчета -->
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                            <button id="generate-report-btn" class="btn btn-success">
                                <i class="fas fa-file-export"></i> Создать отчет
                            </button>
                            <button id="preview-report-btn" class="btn">
                                <i class="fas fa-eye"></i> Предпросмотр
                            </button>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Участники экспедиции</h3>
                        <ul class="user-list" id="expedition-users">
                            <!-- Список пользователей загружается через JavaScript -->
                        </ul>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button id="add-user-btn" class="btn">
                                <i class="fas fa-user-plus"></i> Добавить участника
                            </button>
                            <button id="manage-2fa-btn" class="btn btn-secondary">
                                <i class="fas fa-shield-alt"></i> Управление 2FA
                            </button>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Журнал изменений</h3>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Дата</th>
                                        <th>Действие</th>
                                        <th>Пользователь</th>
                                    </tr>
                                </thead>
                                <tbody id="change-log">
                                    <!-- Журнал загружается через JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 1.5rem;">
                            <h4>Синхронизация данных</h4>
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button id="force-sync-btn" class="btn btn-success">
                                    <i class="fas fa-sync"></i> Принудительная синхронизация
                                </button>
                                <button id="clear-cache-btn" class="btn btn-danger">
                                    <i class="fas fa-trash"></i> Очистить кеш
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Личный кабинет -->
            <div id="profile-page" class="page">
                <div class="profile-header">
                    <div class="profile-avatar" id="profile-avatar">ИИ</div>
                    <div class="profile-info">
                        <h2 id="profile-name">Иван Археологов</h2>
                        <div id="profile-role" style="margin-bottom: 0.5rem; color: var(--secondary-color); font-weight: 500;">Археолог</div>
                        <div id="profile-expedition" style="color: #666;">Экспедиция "Крым-2023"</div>
                    </div>
                </div>
                
                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="user-artifacts">0</div>
                        <div class="stat-label">Найденных артефактов</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="user-days">0</div>
                        <div class="stat-label">Дней в экспедиции</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="user-last">-</div>
                        <div class="stat-label">Последняя находка</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="user-joined">01.06.2023</div>
                        <div class="stat-label">Дата присоединения</div>
                    </div>
                </div>
                
                <div class="dashboard-card" style="margin-bottom: 2rem;">
                    <h3>Мои последние находки</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Артефакт</th>
                                    <th>Тип</th>
                                    <th>Дата</th>
                                    <th>Координаты</th>
                                </tr>
                            </thead>
                            <tbody id="user-artifacts-list">
                                <!-- Данные загружаются через JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h3>Настройки профиля</h3>
                    <div class="form-group">
                        <label for="profile-email">Email</label>
                        <input type="email" id="profile-email" class="form-control" value="ivan@example.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="profile-phone">Телефон (для 2FA)</label>
                        <input type="tel" id="profile-phone" class="form-control" placeholder="+7 (XXX) XXX-XX-XX">
                    </div>
                    
                    <div class="form-group">
                        <label for="profile-notifications">Уведомления</label>
                        <select id="profile-notifications" class="form-control">
                            <option value="all">Все уведомления</option>
                            <option value="important">Только важные</option>
                            <option value="none">Не получать</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <div class="field-checkbox">
                            <input type="checkbox" id="enable-dark-mode" checked>
                            <label for="enable-dark-mode">Темная тема (экономия заряда)</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="field-checkbox">
                            <input type="checkbox" id="enable-voice-input" checked>
                            <label for="enable-voice-input">Включить голосовой ввод</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="field-checkbox">
                            <input type="checkbox" id="enable-ai-recognition" checked>
                            <label for="enable-ai-recognition">Включить AI распознавание</label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button id="save-profile-btn" class="btn">
                            <i class="fas fa-save"></i> Сохранить изменения
                        </button>
                        <button id="setup-2fa-btn" class="btn btn-secondary">
                            <i class="fas fa-shield-alt"></i> Настроить 2FA
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Подвал сайта (виден только после авторизации) -->
        <footer id="site-footer" style="display: none;">
            <p>&copy; 2023 ArchaeoPoint. Все права защищены.</p>
            <p>Система защиты археологических данных с точной ГИС-привязкой</p>
            <div class="footer-links">
                <a href="#"><i class="fas fa-shield-alt"></i> Политика конфиденциальности</a>
                <a href="#"><i class="fas fa-file-contract"></i> Пользовательское соглашение</a>
                <a href="#"><i class="fas fa-envelope"></i> Контакты</a>
                <a href="#" id="install-app-btn"><i class="fas fa-download"></i> Установить приложение</a>
            </div>
        </footer>
    </div>

    <!-- Модальное окно для добавления артефакта -->
    <div id="artifact-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Добавление нового артефакта</h3>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="artifact-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="artifact-name">Название артефакта *</label>
                        <div class="input-with-icon">
                            <input type="text" id="artifact-name" class="form-control" placeholder="Например: Бронзовое зеркало">
                            <button class="voice-input-btn" type="button" title="Голосовой ввод">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="artifact-type">Тип артефакта *</label>
                        <select id="artifact-type" class="form-control">
                            <option value="">-- Выберите тип --</option>
                            <option value="gold">Золотые изделия</option>
                            <option value="ceramic">Керамика</option>
                            <option value="bones">Костные останки</option>
                            <option value="metal">Металлические изделия</option>
                            <option value="stone">Каменные изделия</option>
                            <option value="other">Прочие находки</option>
                        </select>
                        <div class="ai-suggestion" id="ai-suggestion" style="display: none;">
                            <p>AI предлагает: <strong id="ai-suggested-type">Керамика</strong></p>
                            <div class="ai-confidence">Доверие: <span id="ai-confidence">85%</span></div>
                            <button id="apply-ai-suggestion" class="btn btn-sm" style="margin-top: 0.5rem;">Применить предложение</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="artifact-date">Дата находки *</label>
                        <input type="date" id="artifact-date" class="form-control" value="2023-06-15">
                    </div>
                    
                    <div class="form-group">
                        <label for="artifact-layer">Стратиграфический слой</label>
                        <select id="artifact-layer" class="form-control">
                            <option value="">-- Выберите слой --</option>
                            <option value="layer1">Слой I (современный)</option>
                            <option value="layer2">Слой II (средневековый)</option>
                            <option value="layer3">Слой III (античный)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Координаты (WGS84) *</label>
                        <div class="coordinate-inputs">
                            <div>
                                <input type="text" id="artifact-coords-lat" class="form-control" placeholder="Широта" value="44.948237">
                                <div class="gps-accuracy" id="gps-accuracy-lat">Точность: ±0.000001°</div>
                            </div>
                            <div>
                                <input type="text" id="artifact-coords-lng" class="form-control" placeholder="Долгота" value="34.100318">
                                <div class="gps-accuracy" id="gps-accuracy-lng">Точность: ±0.000001°</div>
                            </div>
                            <div>
                                <input type="text" id="artifact-coords-alt" class="form-control" placeholder="Высота (Z)" value="125.5">
                                <div class="gps-accuracy" id="gps-accuracy-alt">Точность: ±0.1м</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="artifact-depth">Глубина (см)</label>
                        <input type="number" id="artifact-depth" class="form-control" placeholder="Например: 45" value="45">
                    </div>
                    
                    <div class="form-group">
                        <button id="get-gps-location" class="btn btn-block" style="margin-top: 1.5rem;">
                            <i class="fas fa-location-arrow"></i> Определить текущие координаты
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="artifact-context">Контекст находки *</label>
                    <div class="input-with-icon">
                        <textarea id="artifact-context" class="form-control" rows="3" placeholder="Описание слоя, квадрата раскопа, связанные находки..."></textarea>
                        <button class="voice-input-btn" type="button" title="Голосовой ввод">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="artifact-description">Описание артефакта</label>
                    <div class="input-with-icon">
                        <textarea id="artifact-description" class="form-control" rows="3" placeholder="Подробное описание находки..."></textarea>
                        <button class="voice-input-btn" type="button" title="Голосовой ввод">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Фотографии артефакта</label>
                    <div class="photo-upload" id="photo-upload-area">
                        <div class="photo-upload-area">
                            <i class="fas fa-camera" style="font-size: 2rem; color: #ccc; margin-bottom: 1rem;"></i>
                            <p>Нажмите для загрузки фотографий</p>
                            <p style="font-size: 0.8rem; color: #999;">Можно загрузить фото in situ и после очистки</p>
                            <button class="btn btn-secondary batch-upload-btn">
                                <i class="fas fa-folder-plus"></i> Пакетная загрузка
                            </button>
                        </div>
                    </div>
                    <div class="photo-preview" id="photo-preview"></div>
                    <input type="file" id="photo-input" accept="image/*" multiple style="display: none;">
                    <input type="file" id="batch-photo-input" accept="image/*" multiple style="display: none;">
                </div>
                
                <div class="form-group" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button id="save-artifact-btn" class="btn btn-success">
                        <i class="fas fa-save"></i> Сохранить артефакт
                    </button>
                    <button id="save-offline-btn" class="btn btn-warning">
                        <i class="fas fa-wifi-slash"></i> Сохранить локально
                    </button>
                    <button id="cancel-artifact-btn" class="btn btn-secondary">Отмена</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для пакетной загрузки -->
    <div id="batch-upload-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-folder-plus"></i> Пакетная загрузка артефактов</h3>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="batch-upload">
                <div class="batch-files" id="batch-drop-area">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
                    <p>Перетащите сюда фотографии или нажмите для выбора</p>
                    <p style="font-size: 0.8rem; color: #999; margin-top: 1rem;">Поддерживаются JPG, PNG, HEIC</p>
                    <p style="font-size: 0.8rem; color: #999;">Максимум 100 файлов за раз</p>
                </div>
                
                <div class="batch-preview" id="batch-preview">
                    <h4>Выбранные файлы (0)</h4>
                    <div id="batch-files-list"></div>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 2rem;">
                <label>Настройки пакетной обработки:</label>
                <div class="form-row">
                    <div class="form-group">
                        <label for="batch-artifact-type">Тип по умолчанию</label>
                        <select id="batch-artifact-type" class="form-control">
                            <option value="other">Прочие находки</option>
                            <option value="ceramic">Керамика</option>
                            <option value="stone">Каменные изделия</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="batch-layer">Слой по умолчанию</label>
                        <select id="batch-layer" class="form-control">
                            <option value="">-- Выберите слой --</option>
                            <option value="layer1">Слой I (современный)</option>
                            <option value="layer2">Слой II (средневековый)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button id="process-batch-btn" class="btn btn-success">
                    <i class="fas fa-play"></i> Начать обработку
                </button>
                <button id="cancel-batch-btn" class="btn btn-secondary">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для двухфакторной аутентификации -->
    <div id="twofa-setup-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-shield-alt"></i> Настройка двухфакторной аутентификации</h3>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="artifact-form">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Двухфакторная аутентификация добавляет дополнительный уровень безопасности к вашему аккаунту.
                </div>
                
                <div class="form-group">
                    <label>Способ аутентификации:</label>
                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="twofa-method" value="sms" checked>
                            <span>SMS</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="twofa-method" value="app">
                            <span>Приложение (Google Authenticator)</span>
                        </label>
                    </div>
                </div>
                
                <div id="twofa-sms-section">
                    <div class="form-group">
                        <label for="twofa-phone">Номер телефона</label>
                        <input type="tel" id="twofa-phone" class="form-control" placeholder="+7 (XXX) XXX-XX-XX">
                    </div>
                    
                    <div class="form-group">
                        <button id="send-sms-code-btn" class="btn">
                            <i class="fas fa-sms"></i> Отправить код подтверждения
                        </button>
                    </div>
                </div>
                
                <div id="twofa-app-section" style="display: none;">
                    <div class="alert alert-info">
                        <p>1. Установите приложение Google Authenticator на ваш телефон</p>
                        <p>2. Отсканируйте QR-код ниже или введите код вручную</p>
                    </div>
                    
                    <div class="qr-code-container">
                        <div class="qr-code" id="twofa-qr-code">
                            <!-- QR код для приложения -->
                        </div>
                        <p style="margin-top: 1rem;">Секретный ключ: <code id="twofa-secret">JBSWY3DPEHPK3PXP</code></p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Код подтверждения</label>
                    <div class="two-factor-code">
                        <input type="text" maxlength="1" pattern="[0-9]">
                        <input type="text" maxlength="1" pattern="[0-9]">
                        <input type="text" maxlength="1" pattern="[0-9]">
                        <input type="text" maxlength="1" pattern="[0-9]">
                        <input type="text" maxlength="1" pattern="[0-9]">
                        <input type="text" maxlength="1" pattern="[0-9]">
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button id="verify-twofa-btn" class="btn btn-success">
                        <i class="fas fa-check"></i> Подтвердить и включить
                    </button>
                    <button id="disable-twofa-btn" class="btn btn-danger">
                        <i class="fas fa-ban"></i> Отключить 2FA
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для QR-кода артефакта -->
    <div id="qr-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-qrcode"></i> QR-код артефакта</h3>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="qr-code-container">
                <p>QR-код для маркировки артефакта. Распечатайте и приклейте к бирке находки.</p>
                <div class="qr-code" id="qr-code-display">
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; color: #333;">QR</div>
                        <div style="font-size: 0.8rem;">ArchaeoPoint</div>
                    </div>
                </div>
                <p id="qr-artifact-name" style="font-weight: bold; margin-top: 1rem;">Бронзовое зеркало</p>
                <p id="qr-artifact-id" style="font-size: 0.9rem; color: #666;">ID: AP-2023-001</p>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: center;">
                    <button id="print-qr-btn" class="btn">
                        <i class="fas fa-print"></i> Распечатать
                    </button>
                    <button id="download-qr-btn" class="btn btn-success">
                        <i class="fas fa-download"></i> Скачать
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для добавления пользователя -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Добавление участника экспедиции</h3>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="artifact-form">
                <div class="form-group">
                    <label for="new-user-name">ФИО *</label>
                    <input type="text" id="new-user-name" class="form-control" placeholder="Введите полное имя">
                </div>
                
                <div class="form-group">
                    <label for="new-user-email">Email *</label>
                    <input type="email" id="new-user-email" class="form-control" placeholder="Введите email">
                </div>
                
                <div class="form-group">
                    <label for="new-user-phone">Телефон</label>
                    <input type="tel" id="new-user-phone" class="form-control" placeholder="+7 (XXX) XXX-XX-XX">
                </div>
                
                <div class="form-group">
                    <label for="new-user-role">Роль *</label>
                    <select id="new-user-role" class="form-control">
                        <option value="archaeologist">Археолог</option>
                        <option value="assistant">Помощник</option>
                        <option value="student">Студент</option>
                        <option value="admin">Администратор</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="new-user-expedition">Экспедиция *</label>
                    <input type="text" id="new-user-expedition" class="form-control" placeholder="Название экспедиции">
                </div>
                
                <div class="form-group">
                    <div class="field-checkbox">
                        <input type="checkbox" id="new-user-enable-2fa">
                        <label for="new-user-enable-2fa">Включить двухфакторную аутентификацию</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <button id="save-user-btn" class="btn btn-success">Добавить участника</button>
                    <button id="cancel-user-btn" class="btn btn-secondary">Отмена</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script>
        // Глобальные переменные и константы
        let currentUser = null;
        let map = null;
        let markersCluster = null;
        let heatmapLayer = null;
        let artifactMarkers = [];
        let artifacts = [];
        let pendingSync = [];
        let users = [];
        let expeditions = [];
        let isOnline = navigator.onLine;
        let isMeasuring = false;
        let measurementPoints = [];
        let isListening = false;
        let recognition = null;
        
        // Конфигурация
        const CONFIG = {
            OFFLINE_STORAGE_KEY: 'archaeopoint_offline_data',
            SYNC_INTERVAL: 30000, // 30 секунд
            MAX_OFFLINE_STORAGE: 50 * 1024 * 1024, // 50MB
            GPS_ACCURACY_THRESHOLD: 10, // метров
            AI_CONFIDENCE_THRESHOLD: 70 // %
        };
        
        // Симуляция AI распознавания
        const AI_RECOGNITION = {
            recognizeImage: function(imageData) {
                // В реальном приложении здесь был бы вызов к нейросети
                // Для демо используем случайные результаты
                const types = ['ceramic', 'metal', 'stone', 'bones', 'gold', 'other'];
                const probabilities = {
                    ceramic: 85,
                    metal: 75,
                    stone: 90,
                    bones: 80,
                    gold: 40,
                    other: 60
                };
                
                const randomType = types[Math.floor(Math.random() * types.length)];
                return {
                    type: randomType,
                    confidence: probabilities[randomType],
                    suggestions: [
                        `Похоже на ${this.getTypeName(randomType)}`,
                        'Рекомендуется провести дополнительный анализ',
                        'Проверьте контекст находки'
                    ]
                };
            },
            
            getTypeName: function(type) {
                const typeNames = {
                    gold: "золотые изделия",
                    ceramic: "керамику",
                    bones: "костные останки",
                    metal: "металлические изделия",
                    stone: "каменные изделия",
                    other: "прочие находки"
                };
                return typeNames[type] || "неизвестный тип";
            }
        };
        
        // Симуляция голосового ввода
        const VOICE_RECOGNITION = {
            isSupported: 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window,
            
            init: function() {
                if (!this.isSupported) return null;
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'ru-RU';
                
                return recognition;
            },
            
            start: function(onResult, onError) {
                if (!recognition) {
                    recognition = this.init();
                    if (!recognition) {
                        onError('Голосовой ввод не поддерживается вашим браузером');
                        return;
                    }
                }
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    onResult(transcript);
                };
                
                recognition.onerror = function(event) {
                    onError(event.error);
                };
                
                recognition.start();
                isListening = true;
            },
            
            stop: function() {
                if (recognition && isListening) {
                    recognition.stop();
                    isListening = false;
                }
            }
        };
        
        // Офлайн-хранилище
        const OFFLINE_STORAGE = {
            save: function(key, data) {
                try {
                    const item = {
                        data: data,
                        timestamp: new Date().toISOString(),
                        synced: false
                    };
                    localStorage.setItem(key, JSON.stringify(item));
                    this.updatePendingSync();
                    return true;
                } catch (e) {
                    console.error('Ошибка сохранения в локальное хранилище:', e);
                    return false;
                }
            },
            
            load: function(key) {
                try {
                    const item = JSON.parse(localStorage.getItem(key));
                    return item ? item.data : null;
                } catch (e) {
                    console.error('Ошибка загрузки из локального хранилища:', e);
                    return null;
                }
            },
            
            remove: function(key) {
                localStorage.removeItem(key);
                this.updatePendingSync();
            },
            
            getAll: function() {
                const items = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('artifact_') || key.startsWith('pending_')) {
                        const item = JSON.parse(localStorage.getItem(key));
                        items.push({ key, ...item });
                    }
                }
                return items;
            },
            
            updatePendingSync: function() {
                const pending = this.getAll().filter(item => !item.synced);
                pendingSync = pending;
                
                // Обновляем UI
                const pendingCount = pending.length;
                document.getElementById('pending-changes').textContent = `${pendingCount} изменений ожидают синхронизации`;
                document.getElementById('pending-sync-count').textContent = pendingCount;
                
                if (pendingCount > 0) {
                    document.getElementById('sync-status').className = 'sync-status syncing';
                    document.getElementById('sync-status').innerHTML = `<i class="fas fa-sync fa-spin"></i> ${pendingCount} ожидают`;
                } else {
                    document.getElementById('sync-status').className = 'sync-status synced';
                    document.getElementById('sync-status').innerHTML = `<i class="fas fa-check"></i> Синхронизировано`;
                }
            },
            
            getStorageUsage: function() {
                let total = 0;
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    total += key.length + value.length;
                }
                return (total / 1024 / 1024).toFixed(2); // MB
            }
        };
        
        // Инициализация карты
        function initMap() {
            // Центр карты - Крым (пример раскопок)
            const mapCenter = [44.948237, 34.100318];
            
            // Инициализация карты
            map = L.map('map').setView(mapCenter, 16);
            
            // Базовый слой OSM
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Дополнительные слои
            const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a>',
                maxZoom: 17
            });
            
            const schemeLayer = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
                attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',
                maxZoom: 20
            });
            
            // Добавление контроля слоев
            const baseLayers = {
                "Спутниковая карта": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
                "Топографическая карта": topoLayer,
                "Схема раскопа": schemeLayer
            };
            
            L.control.layers(baseLayers).addTo(map);
            
            // Кластеризация маркеров
            markersCluster = L.markerClusterGroup({
                maxClusterRadius: 50,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = 'small';
                    if (count > 20) size = 'large';
                    else if (count > 10) size = 'medium';
                    
                    return L.divIcon({
                        html: `<div><span>${count}</span></div>`,
                        className: `marker-cluster marker-cluster-${size}`,
                        iconSize: L.point(40, 40)
                    });
                }
            });
            
            map.addLayer(markersCluster);
            
            // Добавление тестовых данных
            addSampleArtifacts();
            
            // Инициализация инструментов карты
            initMapTools();
        }
        
        // Инициализация инструментов карты
        function initMapTools() {
            // Обработчик для измерения расстояний
            map.on('click', function(e) {
                if (isMeasuring) {
                    measurementPoints.push(e.latlng);
                    
                    if (measurementPoints.length === 1) {
                        // Первая точка
                        L.marker(e.latlng, {
                            icon: L.divIcon({
                                html: '<div style="background-color: red; width: 10px; height: 10px; border-radius: 50%;"></div>',
                                iconSize: [10, 10]
                            })
                        }).addTo(map);
                    } else if (measurementPoints.length === 2) {
                        // Вторая точка - рисуем линию и вычисляем расстояние
                        const p1 = measurementPoints[0];
                        const p2 = measurementPoints[1];
                        
                        // Линия
                        const line = L.polyline([p1, p2], {
                            color: 'red',
                            dashArray: '10, 10',
                            weight: 3
                        }).addTo(map);
                        
                        // Расстояние
                        const distance = map.distance(p1, p2);
                        const midpoint = L.latLng(
                            (p1.lat + p2.lat) / 2,
                            (p1.lng + p2.lng) / 2
                        );
                        
                        // Метка с расстоянием
                        L.marker(midpoint, {
                            icon: L.divIcon({
                                html: `<div class="measurement-label">${distance.toFixed(2)} м</div>`,
                                iconSize: [100, 30],
                                className: 'measurement-label'
                            })
                        }).addTo(map);
                        
                        // Показываем результат
                        document.getElementById('measurement-result').innerHTML = 
                            `Расстояние: <strong>${distance.toFixed(2)} метров</strong>`;
                        document.getElementById('measurement-result').style.display = 'block';
                        
                        // Сбрасываем режим измерения
                        isMeasuring = false;
                        measurementPoints = [];
                        
                        // Скрываем результат через 5 секунд
                        setTimeout(() => {
                            document.getElementById('measurement-result').style.display = 'none';
                            map.removeLayer(line);
                        }, 5000);
                    }
                }
            });
        }
        
        // Добавление тестовых артефактов
        function addSampleArtifacts() {
            const sampleArtifacts = [
                {
                    id: 1,
                    name: "Бронзовое зеркало",
                    type: "metal",
                    lat: 44.948237,
                    lng: 34.100318,
                    alt: 125.5,
                    date: "2023-06-10",
                    depth: 45,
                    context: "Квадрат 5А, культурный слой III",
                    description: "Бронзовое зеркало с орнаментом по краю",
                    discoveredBy: "Иван Археологов",
                    layer: "layer3",
                    photos: [],
                    synced: true
                },
                {
                    id: 2,
                    name: "Золотая подвеска",
                    type: "gold",
                    lat: 44.948537,
                    lng: 34.100618,
                    alt: 126.2,
                    date: "2023-06-12",
                    depth: 32,
                    context: "Квадрат 5Б, погребение №3",
                    description: "Золотая подвеска с изображением орла",
                    discoveredBy: "Мария Петрова",
                    layer: "layer2",
                    photos: [],
                    synced: true
                },
                {
                    id: 3,
                    name: "Керамический сосуд",
                    type: "ceramic",
                    lat: 44.947937,
                    lng: 34.100018,
                    alt: 124.8,
                    date: "2023-06-08",
                    depth: 58,
                    context: "Квадрат 4В, жилой слой",
                    description: "Фрагменты керамического сосуда",
                    discoveredBy: "Алексей Смирнов",
                    layer: "layer3",
                    photos: [],
                    synced: true
                },
                {
                    id: 4,
                    name: "Каменный топор",
                    type: "stone",
                    lat: 44.948037,
                    lng: 34.100918,
                    alt: 125.0,
                    date: "2023-06-14",
                    depth: 40,
                    context: "Квадрат 6А, хозяйственная яма",
                    description: "Каменный топор с отверстием для рукояти",
                    discoveredBy: "Иван Археологов",
                    layer: "layer1",
                    photos: [],
                    synced: true
                },
                {
                    id: 5,
                    name: "Костные останки",
                    type: "bones",
                    lat: 44.948737,
                    lng: 34.099918,
                    alt: 124.5,
                    date: "2023-06-11",
                    depth: 62,
                    context: "Квадрат 5Г, погребение №5",
                    description: "Фрагменты костей животных",
                    discoveredBy: "Мария Петрова",
                    layer: "layer3",
                    photos: [],
                    synced: true
                }
            ];
            
            artifacts = sampleArtifacts;
            updateArtifactsOnMap();
            updateArtifactsTable();
            updateStatistics();
            
            // Сохраняем в локальное хранилище для демонстрации офлайн-работы
            artifacts.forEach(artifact => {
                OFFLINE_STORAGE.save(`artifact_${artifact.id}`, artifact);
            });
            
            // Обновляем статус синхронизации
            OFFLINE_STORAGE.updatePendingSync();
        }
        
        // Обновление артефактов на карте
        function updateArtifactsOnMap() {
            // Очистка существующих маркеров
            markersCluster.clearLayers();
            artifactMarkers = [];
            
            // Получение выбранных типов артефактов
            const selectedTypes = [];
            document.querySelectorAll('input[name="artifact-type"]:checked').forEach(checkbox => {
                selectedTypes.push(checkbox.value);
            });
            
            // Цвета для типов артефактов
            const artifactColors = {
                gold: '#FFD700',
                ceramic: '#8B4513',
                bones: '#F5F5DC',
                metal: '#C0C0C0',
                stone: '#808080',
                other: '#9370DB'
            };
            
            // Добавление маркеров для каждого артефакта
            artifacts.forEach(artifact => {
                if (selectedTypes.includes(artifact.type)) {
                    const icon = L.divIcon({
                        html: `<div style="background-color: ${artifactColors[artifact.type]}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`,
                        className: 'artifact-marker',
                        iconSize: [24, 24]
                    });
                    
                    const marker = L.marker([artifact.lat, artifact.lng], { icon });
                    
                    // Добавление попапа с информацией
                    const popupContent = `
                        <div class="artifact-popup">
                            <h3>${artifact.name}</h3>
                            <div style="background-color: ${artifactColors[artifact.type]}; display: inline-block; padding: 0.2rem 0.5rem; border-radius: 12px; color: ${artifact.type === 'bones' || artifact.type === 'metal' ? '#333' : 'white'}; font-size: 0.8rem;">
                                ${getArtifactTypeName(artifact.type)}
                            </div>
                            <p><strong>Дата:</strong> ${artifact.date}</p>
                            <p><strong>Глубина:</strong> ${artifact.depth} см</p>
                            <p><strong>Высота (Z):</strong> ${artifact.alt} м</p>
                            <p><strong>Нашел:</strong> ${artifact.discoveredBy}</p>
                            <p>${artifact.context}</p>
                            <button onclick="showArtifactDetails(${artifact.id})" class="btn" style="width: 100%; padding: 0.25rem; font-size: 0.8rem;">
                                <i class="fas fa-info-circle"></i> Подробнее
                            </button>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    artifactMarkers.push(marker);
                    markersCluster.addLayer(marker);
                }
            });
            
            // Обновление кластера на карте
            map.addLayer(markersCluster);
            
            // Обновление тепловой карты, если включена
            if (document.getElementById('toggle-heatmap').classList.contains('active')) {
                updateHeatmap();
            }
        }
        
        // Обновление тепловой карты
        function updateHeatmap() {
            // Удаляем существующий слой тепловой карты
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
            }
            
            // Создаем точки для тепловой карты
            const heatPoints = artifacts.map(artifact => [artifact.lat, artifact.lng, 1]);
            
            // Создаем тепловую карту
            heatmapLayer = L.heatLayer(heatPoints, {
                radius: 25,
                blur: 15,
                maxZoom: 17,
                gradient: {0.4: 'blue', 0.6: 'cyan', 0.7: 'lime', 0.8: 'yellow', 1.0: 'red'}
            });
            
            map.addLayer(heatmapLayer);
            
            // Показываем легенду
            document.getElementById('heatmap-legend').style.display = 'block';
        }
        
        // Получение названия типа артефакта
        function getArtifactTypeName(type) {
            const typeNames = {
                gold: "Золотые изделия",
                ceramic: "Керамика",
                bones: "Костные останки",
                metal: "Металлические изделия",
                stone: "Каменные изделия",
                other: "Прочие находки"
            };
            return typeNames[type] || "Неизвестный тип";
        }
        
        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            // Проверка авторизации
            checkAuth();
            
            // Инициализация отслеживания сетевого соединения
            initNetworkMonitoring();
            
            // Инициализация PWA
            initPWA();
            
            // Инициализация обработчиков событий
            initEventHandlers();
            
            // Инициализация тестовых данных
            initTestData();
            
            // Запуск синхронизации
            startSyncService();
        });
        
        // Инициализация отслеживания сетевого соединения
        function initNetworkMonitoring() {
            // Проверка начального состояния
            updateOnlineStatus();
            
            // Слушатели событий сети
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
        }
        
        // Обновление статуса сети
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            
            if (isOnline) {
                document.getElementById('offline-notification').classList.remove('show');
                document.getElementById('sync-status').classList.remove('offline');
                
                // Пытаемся синхронизировать накопленные данные
                syncPendingData();
            } else {
                document.getElementById('offline-notification').classList.add('show');
                document.getElementById('sync-status').className = 'sync-status offline';
                document.getElementById('sync-status').innerHTML = `<i class="fas fa-wifi-slash"></i> Офлайн`;
            }
        }
        
        // Инициализация PWA
        function initPWA() {
            // Проверка поддержки Service Worker
            if ('serviceWorker' in navigator) {
                // Регистрация Service Worker
                navigator.serviceWorker.register('/sw.js').catch(error => {
                    console.log('Ошибка регистрации Service Worker:', error);
                });
                
                // Обработчик события beforeinstallprompt
                let deferredPrompt;
                
                window.addEventListener('beforeinstallprompt', (e) => {
                    // Предотвращаем автоматическое отображение prompt
                    e.preventDefault();
                    deferredPrompt = e;
                    
                    // Показываем кнопку установки
                    document.getElementById('install-app-btn').style.display = 'inline-block';
                    
                    // Обработчик для кнопки установки
                    document.getElementById('install-app-btn').addEventListener('click', () => {
                        // Показываем prompt установки
                        deferredPrompt.prompt();
                        
                        // Ожидаем ответа пользователя
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('Пользователь установил приложение');
                            }
                            deferredPrompt = null;
                        });
                    });
                });
                
                // Обработчик события appinstalled
                window.addEventListener('appinstalled', () => {
                    console.log('Приложение установлено');
                    document.getElementById('install-app-btn').style.display = 'none';
                });
            }
            
            // Проверка, запущено ли приложение в standalone режиме
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                console.log('Приложение запущено в standalone режиме');
            }
        }
        
        // Инициализация обработчиков событий
        function initEventHandlers() {
            // Обработчики для страницы входа
            document.getElementById('show-register').addEventListener('click', function() {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
            });
            
            document.getElementById('show-login').addEventListener('click', function() {
                document.getElementById('register-form').style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
            });
            
            document.getElementById('enable-2fa').addEventListener('click', function() {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('two-factor-form').style.display = 'block';
            });
            
            document.getElementById('back-to-login').addEventListener('click', function() {
                document.getElementById('two-factor-form').style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
            });
            
            document.getElementById('login-btn').addEventListener('click', function() {
                const token = document.getElementById('login-token').value;
                const password = document.getElementById('login-password').value;
                
                if (token && password) {
                    loginUser(token, password);
                } else {
                    showAlert('Заполните все поля для входа', 'danger');
                }
            });
            
            document.getElementById('verify-2fa-btn').addEventListener('click', function() {
                // Проверка кода двухфакторной аутентификации
                const code = Array.from(document.querySelectorAll('.two-factor-code input'))
                    .map(input => input.value)
                    .join('');
                
                if (code.length === 6) {
                    loginUser('admin@archaeopoint.ru', 'admin123', true);
                } else {
                    showAlert('Введите полный 6-значный код', 'danger');
                }
            });
            
            document.getElementById('register-btn').addEventListener('click', function() {
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const expedition = document.getElementById('register-expedition').value;
                
                if (name && email && expedition) {
                    showAlert('Запрос доступа отправлен начальнику экспедиции. Вы получите уведомление на email после подтверждения.', 'success');
                    document.getElementById('register-form').style.display = 'none';
                    document.getElementById('login-form').style.display = 'block';
                    
                    // Очистка полей
                    document.getElementById('register-name').value = '';
                    document.getElementById('register-email').value = '';
                    document.getElementById('register-expedition').value = '';
                    document.getElementById('register-message').value = '';
                } else {
                    showAlert('Заполните обязательные поля: ФИО, Email и Название экспедиции', 'danger');
                }
            });
            
            // Переключение темы
            document.getElementById('theme-toggle').addEventListener('click', function() {
                const isDarkMode = document.body.classList.toggle('dark-mode');
                const icon = this.querySelector('i');
                
                if (isDarkMode) {
                    icon.className = 'fas fa-sun';
                    localStorage.setItem('archaeopoint_theme', 'dark');
                } else {
                    icon.className = 'fas fa-moon';
                    localStorage.setItem('archaeopoint_theme', 'light');
                }
            });
            
            // Переключение темной темы в настройках
            document.getElementById('enable-dark-mode').addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    document.getElementById('theme-toggle').querySelector('i').className = 'fas fa-sun';
                    localStorage.setItem('archaeopoint_theme', 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    document.getElementById('theme-toggle').querySelector('i').className = 'fas fa-moon';
                    localStorage.setItem('archaeopoint_theme', 'light');
                }
            });
            
            // Обработчики для навигации
            document.querySelectorAll('nav a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.id.replace('nav-', '') + '-page';
                    showPage(pageId);
                });
            });
            
            // Обработчики для главной страницы
            document.getElementById('goto-map-btn').addEventListener('click', function() {
                showPage('map-page');
            });
            
            document.getElementById('quick-add-artifact').addEventListener('click', function() {
                showModal('artifact-modal');
            });
            
            // Обработчики для карты
            document.querySelectorAll('input[name="map-layer"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    // В реальном приложении здесь была бы смена слоев карты
                    console.log('Выбран слой:', this.value);
                });
            });
            
            document.querySelectorAll('input[name="artifact-type"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateArtifactsOnMap();
                });
            });
            
            document.getElementById('add-artifact-btn').addEventListener('click', function() {
                showModal('artifact-modal');
            });
            
            document.getElementById('center-map-btn').addEventListener('click', function() {
                if (artifacts.length > 0) {
                    const bounds = L.latLngBounds(artifacts.map(a => [a.lat, a.lng]));
                    map.fitBounds(bounds, { padding: [50, 50] });
                } else {
                    map.setView([44.948237, 34.100318], 16);
                }
            });
            
            document.getElementById('show-legend-btn').addEventListener('click', function() {
                const legend = document.getElementById('map-legend');
                if (legend) {
                    legend.style.display = legend.style.display === 'block' ? 'none' : 'block';
                }
            });
            
            // Тепловая карта
            document.getElementById('toggle-heatmap').addEventListener('click', function() {
                this.classList.toggle('active');
                
                if (this.classList.contains('active')) {
                    updateHeatmap();
                    document.getElementById('heatmap-legend').style.display = 'block';
                } else {
                    if (heatmapLayer) {
                        map.removeLayer(heatmapLayer);
                        heatmapLayer = null;
                    }
                    document.getElementById('heatmap-legend').style.display = 'none';
                }
            });
            
            // 3D вид
            document.getElementById('toggle-3d').addEventListener('click', function() {
                this.classList.toggle('active');
                const visualization = document.getElementById('visualization-3d');
                
                if (this.classList.contains('active')) {
                    visualization.style.display = 'block';
                    showAlert('3D визуализация включена. В реальном приложении здесь был бы трехмерный вид культурных слоев.', 'info');
                } else {
                    visualization.style.display = 'none';
                }
            });
            
            // Измерение расстояний
            document.getElementById('measure-distance').addEventListener('click', function() {
                isMeasuring = !isMeasuring;
                this.classList.toggle('active');
                
                if (isMeasuring) {
                    measurementPoints = [];
                    showAlert('Режим измерения расстояний включен. Кликните на две точки на карте.', 'info');
                } else {
                    showAlert('Режим измерения расстояний выключен.', 'info');
                }
            });
            
            // Обработчики для модальных окон
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    hideAllModals();
                });
            });
            
            document.getElementById('cancel-artifact-btn').addEventListener('click', function() {
                hideAllModals();
            });
            
            document.getElementById('cancel-user-btn').addEventListener('click', function() {
                hideAllModals();
            });
            
            document.getElementById('cancel-batch-btn').addEventListener('click', function() {
                hideAllModals();
            });
            
            // Определение координат по GPS
            document.getElementById('get-gps-location').addEventListener('click', function() {
                if (navigator.geolocation) {
                    showProgress('Определение координат...', 30);
                    
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            const accuracy = position.coords.accuracy; // в метрах
                            
                            // Преобразуем точность в градусы (приблизительно)
                            const accuracyDeg = accuracy / 111320; // 1 градус ≈ 111.32 км
                            
                            document.getElementById('artifact-coords-lat').value = lat.toFixed(6);
                            document.getElementById('artifact-coords-lng').value = lng.toFixed(6);
                            document.getElementById('artifact-coords-alt').value = position.coords.altitude ? 
                                position.coords.altitude.toFixed(1) : '0.0';
                            
                            // Показываем точность
                            document.getElementById('gps-accuracy-lat').textContent = `Точность: ±${accuracyDeg.toFixed(6)}° (${accuracy.toFixed(1)} м)`;
                            document.getElementById('gps-accuracy-lng').textContent = `Точность: ±${accuracyDeg.toFixed(6)}° (${accuracy.toFixed(1)} м)`;
                            document.getElementById('gps-accuracy-alt').textContent = position.coords.altitudeAccuracy ? 
                                `Точность: ±${position.coords.altitudeAccuracy.toFixed(1)} м` : 'Точность: неизвестна';
                            
                            // Центрируем карту на местоположении
                            map.setView([lat, lng], 18);
                            
                            // Добавляем маркер местоположения
                            L.marker([lat, lng], {
                                icon: L.divIcon({
                                    html: '<div style="background-color: #3498db; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white;"></div>',
                                    iconSize: [15, 15]
                                })
                            }).addTo(map).bindPopup('Ваше текущее местоположение').openPopup();
                            
                            hideProgress();
                            showAlert('Координаты успешно определены!', 'success');
                        },
                        function(error) {
                            hideProgress();
                            showAlert('Не удалось определить координаты. Пожалуйста, введите вручную.', 'danger');
                            console.error('Ошибка геолокации:', error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                } else {
                    showAlert('Геолокация не поддерживается вашим браузером.', 'danger');
                }
            });
            
            // Сохранение артефакта
            document.getElementById('save-artifact-btn').addEventListener('click', function() {
                saveArtifact();
            });
            
            // Сохранение артефакта в офлайн-режиме
            document.getElementById('save-offline-btn').addEventListener('click', function() {
                saveArtifact(true);
            });
            
            // Пакетная загрузка
            document.getElementById('batch-upload-btn').addEventListener('click', function() {
                showModal('batch-upload-modal');
            });
            
            document.querySelector('.batch-upload-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                showModal('batch-upload-modal');
            });
            
            // Голосовой ввод
            document.querySelectorAll('.voice-input-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const textarea = this.parentElement.querySelector('textarea, input[type="text"]');
                    
                    if (isListening) {
                        VOICE_RECOGNITION.stop();
                        this.classList.remove('listening');
                    } else {
                        VOICE_RECOGNITION.start(
                            function(transcript) {
                                textarea.value = transcript;
                                showAlert('Текст распознан успешно!', 'success');
                            },
                            function(error) {
                                showAlert('Ошибка распознавания голоса: ' + error, 'danger');
                            }
                        );
                        this.classList.add('listening');
                    }
                });
            });
            
            // AI распознавание изображений
            document.getElementById('photo-input').addEventListener('change', function(e) {
                const files = e.target.files;
                const preview = document.getElementById('photo-preview');
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        
                        const container = document.createElement('div');
                        container.style.position = 'relative';
                        container.appendChild(img);
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-photo';
                        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                        removeBtn.addEventListener('click', function() {
                            container.remove();
                        });
                        container.appendChild(removeBtn);
                        
                        preview.appendChild(container);
                        
                        // AI анализ изображения
                        if (document.getElementById('enable-ai-recognition').checked) {
                            setTimeout(() => {
                                const result = AI_RECOGNITION.recognizeImage(e.target.result);
                                if (result.confidence > CONFIG.AI_CONFIDENCE_THRESHOLD) {
                                    document.getElementById('ai-suggestion').style.display = 'block';
                                    document.getElementById('ai-suggested-type').textContent = 
                                        getArtifactTypeName(result.type);
                                    document.getElementById('ai-confidence').textContent = 
                                        `${result.confidence}%`;
                                    
                                    document.getElementById('apply-ai-suggestion').addEventListener('click', function() {
                                        document.getElementById('artifact-type').value = result.type;
                                        showAlert(`Тип установлен: ${getArtifactTypeName(result.type)}`, 'success');
                                    });
                                }
                            }, 1000);
                        }
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
            
            // Обработчики для панели управления
            document.getElementById('add-user-btn').addEventListener('click', function() {
                showModal('user-modal');
            });
            
            document.getElementById('manage-2fa-btn').addEventListener('click', function() {
                showModal('twofa-setup-modal');
            });
            
            document.getElementById('setup-2fa-btn').addEventListener('click', function() {
                showModal('twofa-setup-modal');
            });
            
            // Переключение методов 2FA
            document.querySelectorAll('input[name="twofa-method"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'sms') {
                        document.getElementById('twofa-sms-section').style.display = 'block';
                        document.getElementById('twofa-app-section').style.display = 'none';
                    } else {
                        document.getElementById('twofa-sms-section').style.display = 'none';
                        document.getElementById('twofa-app-section').style.display = 'block';
                    }
                });
            });
            
            document.getElementById('send-sms-code-btn').addEventListener('click', function() {
                const phone = document.getElementById('twofa-phone').value;
                if (phone) {
                    showAlert(`Код подтверждения отправлен на номер ${phone}`, 'success');
                } else {
                    showAlert('Введите номер телефона', 'danger');
                }
            });
            
            // Синхронизация данных
            document.getElementById('force-sync-btn').addEventListener('click', function() {
                syncPendingData(true);
            });
            
            document.getElementById('clear-cache-btn').addEventListener('click', function() {
                if (confirm('Вы уверены, что хотите очистить локальный кеш? Несинхронизированные данные будут утеряны.')) {
                    localStorage.clear();
                    OFFLINE_STORAGE.updatePendingSync();
                    updateStorageUsage();
                    showAlert('Локальный кеш очищен', 'success');
                }
            });
            
            // Экспорт данных
            document.getElementById('export-artifacts-btn').addEventListener('click', function() {
                showAlert('Функция экспорта будет доступна в полной версии системы', 'info');
            });
            
            document.getElementById('generate-report-btn').addEventListener('click', function() {
                showAlert('Отчет формируется...', 'info');
                setTimeout(() => {
                    showAlert('Отчет успешно создан и отправлен на ваш email', 'success');
                }, 2000);
            });
            
            // Обработчик выхода из системы
            document.getElementById('logout-btn').addEventListener('click', function() {
                logoutUser();
            });
            
            // Перетаскивание файлов для пакетной загрузки
            const batchDropArea = document.getElementById('batch-drop-area');
            const batchPhotoInput = document.getElementById('batch-photo-input');
            
            batchDropArea.addEventListener('click', function() {
                batchPhotoInput.click();
            });
            
            batchDropArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = 'var(--primary-color)';
                this.style.backgroundColor = 'rgba(139, 69, 19, 0.1)';
            });
            
            batchDropArea.addEventListener('dragleave', function() {
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = '';
            });
            
            batchDropArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '#ddd';
                this.style.backgroundColor = '';
                
                const files = e.dataTransfer.files;
                handleBatchFiles(files);
            });
            
            batchPhotoInput.addEventListener('change', function(e) {
                handleBatchFiles(e.target.files);
            });
            
            document.getElementById('process-batch-btn').addEventListener('click', function() {
                processBatchUpload();
            });
        }
        
        // Обработка файлов для пакетной загрузки
        function handleBatchFiles(files) {
            const filesList = document.getElementById('batch-files-list');
            filesList.innerHTML = '';
            
            for (let i = 0; i < Math.min(files.length, 100); i++) {
                const file = files[i];
                const fileItem = document.createElement('div');
                fileItem.className = 'batch-file-item';
                
                fileItem.innerHTML = `
                    <i class="fas fa-image" style="color: #666;"></i>
                    <div style="flex: 1;">
                        <div>${file.name}</div>
                        <div style="font-size: 0.8rem; color: #999;">${(file.size / 1024).toFixed(1)} KB</div>
                    </div>
                    <button class="btn btn-sm btn-danger remove-file" data-index="${i}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                filesList.appendChild(fileItem);
            }
            
            document.querySelector('#batch-preview h4').textContent = `Выбранные файлы (${Math.min(files.length, 100)})`;
            
            // Добавляем обработчики для кнопок удаления
            document.querySelectorAll('.remove-file').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.batch-file-item').remove();
                    const currentCount = document.querySelectorAll('.batch-file-item').length;
                    document.querySelector('#batch-preview h4').textContent = `Выбранные файлы (${currentCount})`;
                });
            });
        }
        
        // Обработка пакетной загрузки
        function processBatchUpload() {
            const fileCount = document.querySelectorAll('.batch-file-item').length;
            if (fileCount === 0) {
                showAlert('Выберите файлы для обработки', 'danger');
                return;
            }
            
            const defaultType = document.getElementById('batch-artifact-type').value;
            const defaultLayer = document.getElementById('batch-layer').value;
            
            showProgress('Обработка файлов...', 0);
            
            // Имитация обработки
            let processed = 0;
            const interval = setInterval(() => {
                processed++;
                const progress = Math.floor((processed / fileCount) * 100);
                updateProgress(progress);
                
                if (processed >= fileCount) {
                    clearInterval(interval);
                    hideProgress();
                    hideAllModals();
                    showAlert(`Обработано ${fileCount} файлов. Создано ${fileCount} записей артефактов.`, 'success');
                }
            }, 300);
        }
        
        // Проверка авторизации
        function checkAuth() {
            const savedUser = localStorage.getItem('archaeopoint_user');
            const savedTheme = localStorage.getItem('archaeopoint_theme');
            
            // Применяем тему
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-toggle').querySelector('i').className = 'fas fa-sun';
                document.getElementById('enable-dark-mode').checked = true;
            }
            
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showAuthenticatedUI();
                initMap(); // Инициализируем карту только после авторизации
                updateStorageUsage();
            }
        }
        
        // Показать интерфейс для авторизованного пользователя
        function showAuthenticatedUI() {
            document.getElementById('gatekeeper-page').style.display = 'none';
            document.getElementById('site-header').style.display = 'flex';
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('site-footer').style.display = 'block';
            
            // Обновление информации о пользователе
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'Начальник экспедиции' : 'Археолог';
            document.getElementById('user-avatar').textContent = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
            
            document.getElementById('profile-name').textContent = currentUser.name;
            document.getElementById('profile-role').textContent = currentUser.role === 'admin' ? 'Начальник экспедиции' : 'Археолог';
            document.getElementById('profile-avatar').textContent = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('profile-email').value = currentUser.email || '';
            document.getElementById('profile-phone').value = currentUser.phone || '';
            
            // Обновление статистики
            updateStatistics();
            updateUserList();
            updateUserArtifacts();
            updateChangeLog();
        }
        
        // Вход пользователя
        function loginUser(token, password, is2FA = false) {
            // В реальном приложении здесь был бы запрос к серверу
            // Для демо используем тестовых пользователей
            
            const testUsers = [
                { 
                    email: "admin@archaeopoint.ru", 
                    password: "admin123", 
                    name: "Александр Иванов", 
                    role: "admin", 
                    expedition: "Крым-2023",
                    phone: "+7 (900) 123-45-67",
                    twoFA: true
                },
                { 
                    email: "archaeologist@archaeopoint.ru", 
                    password: "arch123", 
                    name: "Иван Археологов", 
                    role: "archaeologist", 
                    expedition: "Крым-2023",
                    phone: "+7 (900) 987-65-43",
                    twoFA: false
                },
                { 
                    email: "assistant@archaeopoint.ru", 
                    password: "assist123", 
                    name: "Мария Петрова", 
                    role: "assistant", 
                    expedition: "Крым-2023",
                    phone: "+7 (900) 555-44-33",
                    twoFA: false
                }
            ];
            
            const user = testUsers.find(u => u.email === token || u.password === password);
            
            if (user) {
                // Если включена 2FA, проверяем, что пользователь использовал 2FA форму
                if (user.twoFA && !is2FA) {
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('two-factor-form').style.display = 'block';
                    showAlert('Для этого аккаунта требуется двухфакторная аутентификация', 'info');
                    return;
                }
                
                currentUser = user;
                localStorage.setItem('archaeopoint_user', JSON.stringify(user));
                showAuthenticatedUI();
                showAlert('Успешный вход в систему!', 'success');
            } else {
                showAlert('Неверный токен или пароль. Для демо используйте admin@archaeopoint.ru / admin123', 'danger');
            }
        }
        
        // Выход пользователя
        function logoutUser() {
            currentUser = null;
            localStorage.removeItem('archaeopoint_user');
            
            document.getElementById('site-header').style.display = 'none';
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('site-footer').style.display = 'none';
            document.getElementById('gatekeeper-page').style.display = 'block';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
            document.getElementById('two-factor-form').style.display = 'none';
            
            // Очистка полей входа
            document.getElementById('login-token').value = '';
            document.getElementById('login-password').value = '';
            
            showAlert('Вы вышли из системы', 'info');
        }
        
        // Показать страницу
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.getElementById(pageId).classList.add('active');
            
            // Обновление данных при переходе на страницу
            if (pageId === 'artifacts-page') {
                updateArtifactsTable();
                updateStratigraphy();
            } else if (pageId === 'dashboard-page' && currentUser.role === 'admin') {
                updateStatistics();
                updateUserList();
                updateChangeLog();
                updateStorageUsage();
            } else if (pageId === 'profile-page') {
                updateUserArtifacts();
            }
        }
        
        // Показать модальное окно
        function showModal(modalId) {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
            
            document.getElementById(modalId).classList.add('active');
            
            // Если открываем окно добавления артефакта, заполняем текущей датой
            if (modalId === 'artifact-modal') {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('artifact-date').value = today;
                document.getElementById('artifact-name').value = '';
                document.getElementById('artifact-context').value = '';
                document.getElementById('artifact-description').value = '';
                document.getElementById('artifact-depth').value = '';
                document.getElementById('photo-preview').innerHTML = '';
                document.getElementById('ai-suggestion').style.display = 'none';
                
                // Устанавливаем координаты центра карты
                const center = map.getCenter();
                document.getElementById('artifact-coords-lat').value = center.lat.toFixed(6);
                document.getElementById('artifact-coords-lng').value = center.lng.toFixed(6);
                document.getElementById('artifact-coords-alt').value = '125.5';
                
                // Если пользователь не админ, скрываем некоторые поля
                if (currentUser.role !== 'admin') {
                    // Ничего не скрываем в демо-версии
                }
            }
        }
        
        // Скрыть все модальные окна
        function hideAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }
        
        // Сохранение артефакта
        function saveArtifact(offlineOnly = false) {
            const name = document.getElementById('artifact-name').value;
            const type = document.getElementById('artifact-type').value;
            const date = document.getElementById('artifact-date').value;
            const depth = document.getElementById('artifact-depth').value;
            const lat = document.getElementById('artifact-coords-lat').value;
            const lng = document.getElementById('artifact-coords-lng').value;
            const alt = document.getElementById('artifact-coords-alt').value;
            const context = document.getElementById('artifact-context').value;
            const description = document.getElementById('artifact-description').value;
            const layer = document.getElementById('artifact-layer').value;
            
            if (!name || !type || !date || !lat || !lng || !context) {
                showAlert('Заполните все обязательные поля (отмечены *)', 'danger');
                return;
            }
            
            const newArtifact = {
                id: artifacts.length + 1,
                name: name,
                type: type,
                lat: parseFloat(lat),
                lng: parseFloat(lng),
                alt: parseFloat(alt) || 0,
                date: date,
                depth: depth ? parseInt(depth) : null,
                context: context,
                description: description,
                discoveredBy: currentUser.name,
                layer: layer,
                photos: [], // В реальном приложении здесь были бы загруженные фото
                synced: !offlineOnly && isOnline
            };
            
            if (offlineOnly || !isOnline) {
                // Сохраняем в локальное хранилище
                OFFLINE_STORAGE.save(`artifact_${Date.now()}`, newArtifact);
                showAlert('Артефакт сохранен локально. Будет синхронизирован при появлении соединения.', 'warning');
            } else {
                // Добавляем в основной массив
                artifacts.push(newArtifact);
                updateArtifactsOnMap();
                updateArtifactsTable();
                updateStatistics();
                showAlert('Артефакт успешно добавлен!', 'success');
            }
            
            // Добавление в историю изменений
            addToChangeLog('Добавлен артефакт: ' + name);
            
            // Закрытие модального окна
            hideAllModals();
            
            // Показ QR-кода, если не в офлайн-режиме
            if (!offlineOnly) {
                setTimeout(() => {
                    showArtifactQR(newArtifact);
                }, 500);
            }
        }
        
        // Показать QR-код артефакта
        function showArtifactQR(artifact) {
            document.getElementById('qr-artifact-name').textContent = artifact.name;
            document.getElementById('qr-artifact-id').textContent = `ID: AP-2023-${artifact.id.toString().padStart(3, '0')}`;
            showModal('qr-modal');
        }
        
        // Показать детали артефакта
        function showArtifactDetails(artifactId) {
            const artifact = artifacts.find(a => a.id === artifactId);
            if (artifact) {
                alert(`Детали артефакта:\n\nНазвание: ${artifact.name}\nТип: ${getArtifactTypeName(artifact.type)}\nДата находки: ${artifact.date}\nКоординаты: ${artifact.lat}, ${artifact.lng}, ${artifact.alt} м\nГлубина: ${artifact.depth} см\nСлой: ${getLayerName(artifact.layer)}\nКонтекст: ${artifact.context}\nОписание: ${artifact.description}\nНашел: ${artifact.discoveredBy}`);
            }
        }
        
        // Получить название слоя
        function getLayerName(layerId) {
            const layers = {
                layer1: 'Слой I (современный)',
                layer2: 'Слой II (средневековый)',
                layer3: 'Слой III (античный)'
            };
            return layers[layerId] || 'Не указан';
        }
        
        // Обновление таблицы артефактов
        function updateArtifactsTable() {
            const tbody = document.getElementById('artifacts-table-body');
            tbody.innerHTML = '';
            
            artifacts.forEach(artifact => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>AP-2023-${artifact.id.toString().padStart(3, '0')}</td>
                    <td>${artifact.name}</td>
                    <td><span style="background-color: ${getArtifactColor(artifact.type)}; color: ${artifact.type === 'bones' || artifact.type === 'metal' ? '#333' : 'white'}; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">${getArtifactTypeName(artifact.type)}</span></td>
                    <td>${artifact.date}</td>
                    <td>${artifact.lat.toFixed(6)}, ${artifact.lng.toFixed(6)}, ${artifact.alt} м</td>
                    <td>${artifact.discoveredBy}</td>
                    <td>${getLayerName(artifact.layer)}</td>
                    <td>
                        <button onclick="showArtifactDetails(${artifact.id})" class="btn btn-sm" title="Просмотр">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="showArtifactQR(${artifact})" class="btn btn-sm btn-secondary" title="QR-код">
                            <i class="fas fa-qrcode"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Получить цвет для типа артефакта
        function getArtifactColor(type) {
            const colors = {
                gold: '#FFD700',
                ceramic: '#8B4513',
                bones: '#F5F5DC',
                metal: '#C0C0C0',
                stone: '#808080',
                other: '#9370DB'
            };
            return colors[type] || '#9370DB';
        }
        
        // Обновление статистики
        function updateStatistics() {
            document.getElementById('total-artifacts').textContent = artifacts.length;
            document.getElementById('total-users').textContent = users.length;
            
            // Находки за сегодня
            const today = new Date().toISOString().split('T')[0];
            const todayArtifacts = artifacts.filter(a => a.date === today).length;
            document.getElementById('today-artifacts').textContent = todayArtifacts;
            
            // Находки за 7 дней
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const lastWeekArtifacts = artifacts.filter(a => new Date(a.date) >= weekAgo).length;
            document.getElementById('last-week').textContent = lastWeekArtifacts;
            
            // Статистика для личного кабинета
            if (currentUser) {
                const userArtifacts = artifacts.filter(a => a.discoveredBy === currentUser.name).length;
                document.getElementById('user-artifacts').textContent = userArtifacts;
                
                // Дни в экспедиции (примерные)
                const joinDate = new Date('2023-06-01');
                const todayDate = new Date();
                const daysInExpedition = Math.ceil((todayDate - joinDate) / (1000 * 60 * 60 * 24));
                document.getElementById('user-days').textContent = daysInExpedition;
                
                // Последняя находка
                const userLatest = artifacts.filter(a => a.discoveredBy === currentUser.name)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                document.getElementById('user-last').textContent = userLatest ? userLatest.date : '-';
            }
        }
        
        // Обновление использования хранилища
        function updateStorageUsage() {
            const usage = OFFLINE_STORAGE.getStorageUsage();
            document.getElementById('storage-usage').textContent = `${usage} MB`;
        }
        
        // Инициализация тестовых данных
        function initTestData() {
            // Тестовые пользователи
            users = [
                { id: 1, name: "Александр Иванов", email: "admin@archaeopoint.ru", role: "admin", expedition: "Крым-2023", joined: "2023-05-15", phone: "+7 (900) 123-45-67" },
                { id: 2, name: "Иван Археологов", email: "ivan@example.com", role: "archaeologist", expedition: "Крым-2023", joined: "2023-06-01", phone: "+7 (900) 987-65-43" },
                { id: 3, name: "Мария Петрова", email: "maria@example.com", role: "assistant", expedition: "Крым-2023", joined: "2023-06-05", phone: "+7 (900) 555-44-33" },
                { id: 4, name: "Алексей Смирнов", email: "alexey@example.com", role: "archaeologist", expedition: "Крым-2023", joined: "2023-06-03", phone: "+7 (900) 111-22-33" },
                { id: 5, name: "Екатерина Волкова", email: "ekaterina@example.com", role: "student", expedition: "Крым-2023", joined: "2023-06-10", phone: "+7 (900) 444-55-66" }
            ];
            
            // Тестовые экспедиции
            expeditions = [
                { id: 1, name: "Крым-2023", location: "Крым, Бахчисарайский район", startDate: "2023-06-01", endDate: "2023-08-31", director: "Александр Иванов" },
                { id: 2, name: "Великий Новгород-2023", location: "Новгородская область", startDate: "2023-07-15", endDate: "2023-09-30", director: "Петр Сидоров" }
            ];
            
            // Тестовые стратиграфические слои
            updateStratigraphy();
        }
        
        // Обновление стратиграфии
        function updateStratigraphy() {
            const layersList = document.getElementById('layers-list');
            if (!layersList) return;
            
            const layers = [
                { id: 'layer1', name: 'Слой I (современный)', depthFrom: 0, depthTo: 30, color: '#8B4513', artifacts: 5 },
                { id: 'layer2', name: 'Слой II (средневековый)', depthFrom: 30, depthTo: 80, color: '#D2691E', artifacts: 12 },
                { id: 'layer3', name: 'Слой III (античный)', depthFrom: 80, depthTo: 150, color: '#A0522D', artifacts: 8 }
            ];
            
            layersList.innerHTML = '';
            
            layers.forEach(layer => {
                const layerItem = document.createElement('div');
                layerItem.className = 'layer-item';
                layerItem.draggable = true;
                layerItem.dataset.layerId = layer.id;
                layerItem.style.borderLeftColor = layer.color;
                
                layerItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 500;">${layer.name}</div>
                            <div style="font-size: 0.8rem; color: #666;">Глубина: ${layer.depthFrom}-${layer.depthTo} см</div>
                        </div>
                        <div style="font-size: 0.8rem; background-color: ${layer.color}20; padding: 0.2rem 0.5rem; border-radius: 12px;">
                            ${layer.artifacts} артефактов
                        </div>
                    </div>
                `;
                
                layersList.appendChild(layerItem);
            });
        }
        
        // Обновление списка пользователей
        function updateUserList() {
            const userList = document.getElementById('expedition-users');
            if (!userList) return;
            
            userList.innerHTML = '';
            
            users.forEach(user => {
                const li = document.createElement('li');
                li.className = 'user-item';
                
                let roleClass = '';
                let roleText = '';
                
                switch(user.role) {
                    case 'admin':
                        roleClass = 'role-admin';
                        roleText = 'Начальник';
                        break;
                    case 'archaeologist':
                        roleClass = 'role-archaeologist';
                        roleText = 'Археолог';
                        break;
                    case 'assistant':
                        roleClass = 'role-assistant';
                        roleText = 'Помощник';
                        break;
                    default:
                        roleClass = '';
                        roleText = user.role;
                }
                
                li.innerHTML = `
                    <div>
                        <div style="font-weight: 500;">${user.name}</div>
                        <div style="font-size: 0.8rem; color: #666;">${user.email}</div>
                    </div>
                    <div>
                        <span class="user-role ${roleClass}">${roleText}</span>
                        ${currentUser && currentUser.role === 'admin' && user.id !== currentUser.id ? 
                          `<button onclick="removeUser(${user.id})" class="btn btn-danger btn-sm" style="margin-left: 0.5rem;">
                            <i class="fas fa-times"></i>
                          </button>` : ''}
                    </div>
                `;
                
                userList.appendChild(li);
            });
        }
        
        // Удаление пользователя
        function removeUser(userId) {
            if (confirm('Вы уверены, что хотите удалить этого участника экспедиции?')) {
                users = users.filter(u => u.id !== userId);
                updateUserList();
                addToChangeLog('Удален участник экспедиции (ID: ' + userId + ')');
                showAlert('Пользователь удален из экспедиции', 'success');
            }
        }
        
        // Обновление истории изменений
        function updateChangeLog() {
            const log = [
                { date: '2023-06-15 10:30', action: 'Добавлен артефакт "Бронзовое зеркало"', user: 'Иван Археологов' },
                { date: '2023-06-15 09:15', action: 'Экспорт данных в PDF', user: 'Александр Иванов' },
                { date: '2023-06-14 16:45', action: 'Добавлен участник экспедиции', user: 'Александр Иванов' },
                { date: '2023-06-14 14:20', action: 'Добавлен артефакт "Золотая подвеска"', user: 'Мария Петрова' },
                { date: '2023-06-13 11:10', action: 'Изменены настройки доступа', user: 'Александр Иванов' }
            ];
            
            const tbody = document.getElementById('change-log');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            log.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${entry.action}</td>
                    <td>${entry.user}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Добавление записи в историю изменений
        function addToChangeLog(action) {
            // В реальном приложении здесь была бы запись в базу данных
            console.log('Запись в историю изменений:', action);
        }
        
        // Обновление списка артефактов пользователя
        function updateUserArtifacts() {
            if (!currentUser) return;
            
            const userArtifacts = artifacts.filter(a => a.discoveredBy === currentUser.name)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5); // Показываем только последние 5 находок
            
            const tbody = document.getElementById('user-artifacts-list');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (userArtifacts.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" style="text-align: center; color: #666;">Вы еще не добавили ни одного артефакта</td>`;
                tbody.appendChild(row);
                return;
            }
            
            userArtifacts.forEach(artifact => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${artifact.name}</td>
                    <td>${getArtifactTypeName(artifact.type)}</td>
                    <td>${artifact.date}</td>
                    <td>${artifact.lat.toFixed(4)}, ${artifact.lng.toFixed(4)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Сохранение профиля
        function saveProfile() {
            const email = document.getElementById('profile-email').value;
            const phone = document.getElementById('profile-phone').value;
            const notifications = document.getElementById('profile-notifications').value;
            
            // Обновляем данные пользователя
            currentUser.email = email;
            currentUser.phone = phone;
            localStorage.setItem('archaeopoint_user', JSON.stringify(currentUser));
            
            showAlert('Настройки профиля сохранены', 'success');
        }
        
        // Синхронизация накопленных данных
        function syncPendingData(force = false) {
            if (!isOnline && !force) {
                console.log('Нет соединения с интернетом. Синхронизация отложена.');
                return;
            }
            
            const pending = OFFLINE_STORAGE.getAll().filter(item => !item.synced);
            
            if (pending.length === 0) {
                console.log('Нет данных для синхронизации');
                return;
            }
            
            console.log(`Начинаю синхронизацию ${pending.length} записей...`);
            
            // Имитация синхронизации
            showProgress('Синхронизация данных...', 0);
            
            let synced = 0;
            const interval = setInterval(() => {
                synced++;
                const progress = Math.floor((synced / pending.length) * 100);
                updateProgress(progress);
                
                if (synced >= pending.length) {
                    clearInterval(interval);
                    
                    // Помечаем все как синхронизированные
                    pending.forEach(item => {
                        const stored = JSON.parse(localStorage.getItem(item.key));
                        stored.synced = true;
                        localStorage.setItem(item.key, JSON.stringify(stored));
                        
                        // Добавляем в основной массив артефактов
                        if (item.key.startsWith('artifact_')) {
                            artifacts.push(item.data);
                        }
                    });
                    
                    // Обновляем UI
                    OFFLINE_STORAGE.updatePendingSync();
                    updateArtifactsOnMap();
                    updateArtifactsTable();
                    updateStatistics();
                    
                    hideProgress();
                    showAlert(`Успешно синхронизировано ${pending.length} записей`, 'success');
                }
            }, 500);
        }
        
        // Запуск службы синхронизации
        function startSyncService() {
            // Периодическая проверка и синхронизация
            setInterval(() => {
                if (isOnline && pendingSync.length > 0) {
                    syncPendingData();
                }
            }, CONFIG.SYNC_INTERVAL);
            
            // Проверка при загрузке страницы
            if (isOnline && pendingSync.length > 0) {
                setTimeout(() => {
                    syncPendingData();
                }, 5000);
            }
        }
        
        // Показать прогресс бар
        function showProgress(message, initialProgress) {
            document.getElementById('progress-bar').style.width = initialProgress + '%';
            document.getElementById('progress-bar').style.display = 'block';
        }
        
        function updateProgress(progress) {
            document.getElementById('progress-bar').style.width = progress + '%';
        }
        
        function hideProgress() {
            setTimeout(() => {
                document.getElementById('progress-bar').style.display = 'none';
                document.getElementById('progress-bar').style.width = '0%';
            }, 500);
        }
        
        // Показать уведомление
        function showAlert(message, type) {
            // Создаем элемент уведомления
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
            `;
            
            // Добавляем уведомление
            const main = document.querySelector('main');
            if (main) {
                main.insertBefore(alertDiv, main.firstChild);
            } else {
                document.body.appendChild(alertDiv);
            }
            
            // Удаляем уведомление через 5 секунд
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // Инициализация Service Worker для PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
        
        // Создаем манифест для PWA
        const manifest = {
            "name": "ArchaeoPoint",
            "short_name": "ArchaeoPoint",
            "description": "Профессиональная платформа для цифровой фиксации археологических данных",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#3E2723",
            "theme_color": "#8B4513",
            "icons": [
                {
                    "src": "icon-192x192.png",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "icon-512x512.png",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };
        
        // В реальном приложении манифест был бы в отдельном файле
        console.log('PWA манифест готов:', manifest);
    </script>
</body>
</html>
