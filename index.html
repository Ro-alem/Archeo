<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArchaeoPoint - От раскопа до карты в один клик</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#8B4513">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #8B4513;
            --secondary-color: #D2691E;
            --accent-color: #F4A460;
            --dark-color: #3E2723;
            --light-color: #FAF3E0;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
            transition: var(--transition);
        }

        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }

        .container {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #offline-notification {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #f39c12;
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 2000;
            display: none;
        }

        #offline-notification.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background-color: var(--primary-color);
            width: 0%;
            z-index: 2001;
            transition: width 0.3s ease;
        }

        header {
            background: linear-gradient(135deg, var(--dark-color), var(--primary-color));
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            z-index: 1000;
        }

        .dark-mode header {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .logo .tagline {
            font-size: 0.9rem;
            opacity: 0.9;
            font-style: italic;
        }

        .logo-icon {
            font-size: 2rem;
            color: var(--accent-color);
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 1rem;
        }

        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        nav a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            padding: 0.3rem 0.8rem;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .sync-status.syncing {
            color: #f39c12;
        }

        .sync-status.synced {
            color: #27ae60;
        }

        .sync-status.offline {
            color: #e74c3c;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .avatar {
            width: 40px;
            height: 40px;
            background-color: var(--accent-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        main {
            flex: 1;
            padding: 2rem;
        }

        .dark-mode main {
            background-color: #121212;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .gatekeeper {
            max-width: 500px;
            margin: 4rem auto;
            padding: 3rem;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .dark-mode .gatekeeper {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }

        .gatekeeper h2 {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .gatekeeper p {
            margin-bottom: 2rem;
            color: #666;
            line-height: 1.6;
        }

        .dark-mode .gatekeeper p {
            color: #aaa;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark-color);
        }

        .dark-mode .form-group label {
            color: #e0e0e0;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background-color: white;
            color: #333;
        }

        .dark-mode .form-control {
            background-color: #2d2d2d;
            border-color: #444;
            color: #e0e0e0;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon .form-control {
            padding-left: 3rem;
        }

        .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .two-factor-form {
            display: none;
        }

        .two-factor-code {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .two-factor-code input {
            width: 100%;
            height: 50px;
            text-align: center;
            font-size: 1.5rem;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
        }

        .two-factor-code input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .btn {
            display: inline-block;
            padding: 0.75rem 2rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
        }

        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-warning {
            background-color: var(--warning-color);
        }

        .btn-info {
            background-color: var(--info-color);
        }

        .btn-block {
            width: 100%;
        }

        .btn-sm {
            padding: 0.4rem 1rem;
            font-size: 0.9rem;
        }

        .link-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.9rem;
        }

        .dark-mode .link-btn {
            color: var(--accent-color);
        }

        .alert {
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .dark-mode .alert-success {
            background-color: #155724;
            color: #d4edda;
        }

        .dark-mode .alert-info {
            background-color: #0c5460;
            color: #d1ecf1;
        }

        .welcome-hero {
            text-align: center;
            padding: 3rem 2rem;
            background: linear-gradient(135deg, var(--light-color), #fff);
            border-radius: var(--border-radius);
            margin-bottom: 3rem;
            box-shadow: var(--shadow);
        }

        .dark-mode .welcome-hero {
            background: linear-gradient(135deg, #2d2d2d, #1e1e1e);
        }

        .welcome-hero h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .welcome-hero p {
            font-size: 1.2rem;
            color: #555;
            max-width: 800px;
            margin: 0 auto 2rem;
            line-height: 1.6;
        }

        .dark-mode .welcome-hero p {
            color: #aaa;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 3rem;
        }

        .feature-card {
            background-color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .dark-mode .feature-card {
            background-color: #1e1e1e;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .feature-card h3 {
            margin-bottom: 1rem;
            color: var(--dark-color);
        }

        .dark-mode .feature-card h3 {
            color: #e0e0e0;
        }

        #map-container {
            height: 600px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 300px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .dark-mode .map-controls {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }

        .map-controls h3 {
            margin-bottom: 1rem;
            color: var(--primary-color);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .map-controls-section {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .dark-mode .map-controls-section {
            border-bottom-color: #444;
        }

        .map-controls-section h4 {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }

        .dark-mode .map-controls-section h4 {
            color: #aaa;
        }

        .layer-control, .artifact-control {
            margin-bottom: 0.5rem;
        }

        .layer-control label, .artifact-control label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .color-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            border: 1px solid #ddd;
        }

        .artifact-gold { background-color: #FFD700; }
        .artifact-ceramic { background-color: #8B4513; }
        .artifact-bones { background-color: #F5F5DC; }
        .artifact-metal { background-color: #C0C0C0; }
        .artifact-stone { background-color: #808080; }
        .artifact-other { background-color: #9370DB; }

        .map-tools {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .map-tool-btn {
            padding: 0.5rem 1rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
        }

        .map-tool-btn:hover {
            background-color: var(--secondary-color);
        }

        .map-tool-btn.active {
            background-color: var(--secondary-color);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .map-measurement-result {
            position: absolute;
            background-color: white;
            padding: 0.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1000;
            display: none;
        }

        .dark-mode .map-measurement-result {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }

        .template-card {
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .template-card:hover {
            transform: translateY(-5px);
        }
        
        .template-card .use-template-btn {
            margin-top: 1rem;
            width: 100%;
        }
        
        #sketch-canvas {
            touch-action: none;
        }
        
        .recording {
            animation: pulse 1.5s infinite;
            color: #e74c3c !important;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .attachment-item {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
        }
        
        .attachment-item i {
            color: var(--primary-color);
        }
        
        .audio-player {
            width: 100%;
            margin-top: 0.5rem;
        }
        
        .visualizer {
            height: 50px;
            background-color: #f0f0f0;
            border-radius: var(--border-radius);
            margin-top: 1rem;
            position: relative;
            overflow: hidden;
        }
        
        .visualizer-bar {
            position: absolute;
            bottom: 0;
            width: 4px;
            background-color: var(--primary-color);
            border-radius: 2px 2px 0 0;
        }
        
        .voice-input-active {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 0.2rem rgba(139, 69, 19, 0.25);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .dashboard-card {
            background-color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .dark-mode .dashboard-card {
            background-color: #1e1e1e;
        }

        .dashboard-card h3 {
            margin-bottom: 1.5rem;
            color: var(--primary-color);
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light-color);
        }

        .dark-mode .dashboard-card h3 {
            border-bottom-color: #333;
        }

        .statistics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
        }

        .dark-mode .stat-item {
            background-color: #2d2d2d;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .dark-mode .stat-label {
            color: #aaa;
        }

        .user-list {
            list-style: none;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .dark-mode .user-item {
            border-bottom-color: #333;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-role {
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .role-admin { background-color: #d4edda; color: #155724; }
        .role-archaeologist { background-color: #d1ecf1; color: #0c5460; }
        .role-assistant { background-color: #fff3cd; color: #856404; }
        .role-stratigraphy { background-color: #d1ecf1; color: #0c5460; }
        .role-findings { background-color: #d4edda; color: #155724; }
        .role-weather { background-color: #cce5ff; color: #004085; }
        .role-observations { background-color: #fff3cd; color: #856404; }
        .role-planning { background-color: #e2e3e5; color: #383d41; }
        .role-problems { background-color: #f8d7da; color: #721c24; }

        .dark-mode .role-admin { background-color: #155724; color: #d4edda; }
        .dark-mode .role-archaeologist { background-color: #0c5460; color: #d1ecf1; }
        .dark-mode .role-assistant { background-color: #856404; color: #fff3cd; }
        .dark-mode .role-stratigraphy { background-color: #0c5460; color: #d1ecf1; }
        .dark-mode .role-findings { background-color: #155724; color: #d4edda; }
        .dark-mode .role-weather { background-color: #004085; color: #cce5ff; }
        .dark-mode .role-observations { background-color: #856404; color: #fff3cd; }
        .dark-mode .role-planning { background-color: #383d41; color: #e2e3e5; }
        .dark-mode .role-problems { background-color: #721c24; color: #f8d7da; }

        .artifact-form {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .dark-mode .artifact-form {
            background-color: #1e1e1e;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .form-full {
            grid-column: 1 / -1;
        }

        .coordinate-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        .coordinate-inputs .form-control {
            text-align: center;
            font-family: monospace;
        }

        .gps-accuracy {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .dark-mode .gps-accuracy {
            color: #aaa;
        }

        .photo-upload {
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .photo-upload:hover {
            border-color: var(--primary-color);
        }

        .photo-upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .batch-upload-btn {
            margin-top: 1rem;
        }

        .photo-preview {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .photo-preview img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: var(--border-radius);
            position: relative;
        }

        .photo-preview .remove-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-suggestion {
            background-color: #e8f4fd;
            border-left: 4px solid #3498db;
            padding: 0.75rem;
            margin-top: 0.5rem;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        .dark-mode .ai-suggestion {
            background-color: #0c3a5c;
        }

        .ai-suggestion p {
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }

        .dark-mode .ai-suggestion p {
            color: #e0e0e0;
        }

        .ai-confidence {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .voice-input-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .voice-input-btn.listening {
            color: #e74c3c;
            animation: pulse 1s infinite;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid #eee;
        }

        .dark-mode .profile-header {
            border-bottom-color: #333;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            background-color: var(--accent-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            font-weight: bold;
        }

        .profile-info h2 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .table-container {
            overflow-x: auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .dark-mode .table-container {
            background-color: #1e1e1e;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .dark-mode th, .dark-mode td {
            border-bottom-color: #333;
        }

        th {
            background-color: var(--light-color);
            color: var(--primary-color);
            font-weight: 600;
        }

        .dark-mode th {
            background-color: #2d2d2d;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .dark-mode tr:hover {
            background-color: #2d2d2d;
        }

        footer {
            background-color: var(--dark-color);
            color: white;
            padding: 2rem;
            text-align: center;
            margin-top: 3rem;
        }

        .dark-mode footer {
            background-color: #1a1a1a;
        }

        footer p {
            margin-bottom: 1rem;
            opacity: 0.8;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .footer-links a {
            color: white;
            text-decoration: none;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .footer-links a:hover {
            opacity: 1;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            nav ul {
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem;
            }

            .header-controls {
                flex-wrap: wrap;
                justify-content: center;
            }

            .map-controls {
                position: relative;
                top: 0;
                right: 0;
                width: 100%;
                margin-bottom: 1rem;
                max-height: 300px;
            }

            #map-container {
                height: 400px;
            }

            .welcome-hero h1 {
                font-size: 1.8rem;
            }

            .welcome-hero p {
                font-size: 1rem;
            }

            .gatekeeper {
                margin: 2rem auto;
                padding: 2rem 1.5rem;
            }

            .coordinate-inputs {
                grid-template-columns: 1fr;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
        }

        .dark-mode .modal-content {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .dark-mode .modal-header {
            border-bottom-color: #333;
        }

        .modal-header h3 {
            color: var(--primary-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .report-builder {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        .report-fields {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: var(--border-radius);
        }

        .dark-mode .report-fields {
            background-color: #2d2d2d;
        }

        .report-preview {
            padding: 1.5rem;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            min-height: 500px;
        }

        .dark-mode .report-preview {
            background-color: #1e1e1e;
        }

        .field-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .stratigraphy-visualization {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .stratigraphy-layers {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            max-height: 500px;
            overflow-y: auto;
        }

        .dark-mode .stratigraphy-layers {
            background-color: #2d2d2d;
        }

        .stratigraphy-canvas {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
            min-height: 500px;
        }

        .dark-mode .stratigraphy-canvas {
            background-color: #1e1e1e;
        }

        .layer-item {
            padding: 1rem;
            background-color: white;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            cursor: move;
            border-left: 4px solid #8B4513;
        }

        .dark-mode .layer-item {
            background-color: #2d2d2d;
        }

        .batch-upload {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .batch-files {
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .batch-preview {
            max-height: 400px;
            overflow-y: auto;
        }

        .batch-file-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
        }

        .dark-mode .batch-file-item {
            border-bottom-color: #333;
        }

        .visualization-3d {
            height: 500px;
            border-radius: var(--border-radius);
            overflow: hidden;
            background-color: #f0f0f0;
            position: relative;
        }

        .dark-mode .visualization-3d {
            background-color: #2d2d2d;
        }

        .visualization-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }

        .heatmap-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1000;
        }

        .dark-mode .heatmap-legend {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }

        .heatmap-gradient {
            width: 200px;
            height: 20px;
            background: linear-gradient(to right, blue, cyan, green, yellow, red);
            border-radius: 4px;
            margin: 0.5rem 0;
        }

        .qr-code-container {
            text-align: center;
            padding: 1.5rem;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .dark-mode .qr-code-container {
            background-color: #1e1e1e;
        }

        .qr-code {
            width: 200px;
            height: 200px;
            margin: 1rem auto;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #666;
            border: 1px dashed #ddd;
        }

        .dark-mode .qr-code {
            background-color: #2d2d2d;
            color: #aaa;
        }

        .leaflet-control-zoom {
            margin-top: 10px !important;
            margin-right: 10px !important;
        }

        .leaflet-control-layers {
            margin-top: 10px !important;
            margin-right: 10px !important;
        }

        .measurement-line {
            stroke: #ff0000;
            stroke-width: 3;
            stroke-dasharray: 10, 10;
        }

        .measurement-label {
            background-color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }

        .dark-mode .measurement-label {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="progress-bar" id="progress-bar"></div>
    
    <div id="offline-notification">
        <i class="fas fa-wifi-slash"></i> Вы работаете в офлайн-режиме. Данные будут синхронизированы при восстановлении соединения.
        <span id="pending-changes">0 изменений ожидают синхронизации</span>
    </div>
    
    <div class="container">
        <div id="gatekeeper-page" class="page active">
            <div class="gatekeeper">
                <div class="logo" style="justify-content: center; margin-bottom: 2rem;">
                    <div class="logo-icon">
                        <i class="fas fa-map-marked-alt"></i>
                    </div>
                    <div>
                        <h1>ArchaeoPoint</h1>
                        <div class="tagline">От раскопа до карты в один клик</div>
                    </div>
                </div>
                
                <h2>Защищенный доступ к данным</h2>
                <p>Введите токен экспедиции или данные для входа в систему. Доступ предоставляется только авторизованным участникам археологических исследований.</p>
                
                <div id="login-form">
                    <div class="form-group">
                        <label for="login-token">Токен экспедиции / Email</label>
                        <div class="input-with-icon">
                            <i class="fas fa-user input-icon"></i>
                            <input type="text" id="login-token" class="form-control" placeholder="Введите admin@archaeopoint.ru">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="login-password">Пароль</label>
                        <div class="input-with-icon">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="login-password" class="form-control" placeholder="Введите admin123">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="field-checkbox">
                            <input type="checkbox" id="remember-me">
                            <label for="remember-me">Запомнить меня</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button id="login-btn" class="btn btn-block">
                            <i class="fas fa-sign-in-alt"></i> Войти в систему
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <button id="enable-2fa" class="btn btn-secondary btn-block">
                            <i class="fas fa-shield-alt"></i> Войти с двухфакторной аутентификацией
                        </button>
                    </div>
                    
                    <div class="form-group" style="text-align: center;">
                        <button id="show-register" class="link-btn">Запросить доступ</button>
                    </div>
                </div>
                
                <div id="two-factor-form" class="two-factor-form">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> На ваш телефон отправлен код подтверждения. Введите 6-значный код для входа.
                    </div>
                    
                    <div class="form-group">
                        <label>Код подтверждения</label>
                        <div class="two-factor-code">
                            <input type="text" maxlength="1" pattern="[0-9]">
                            <input type="text" maxlength="1" pattern="[0-9]">
                            <input type="text" maxlength="1" pattern="[0-9]">
                            <input type="text" maxlength="1" pattern="[0-9]">
                            <input type="text" maxlength="1" pattern="[0-9]">
                            <input type="text" maxlength="1" pattern="[0-9]">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button id="verify-2fa-btn" class="btn btn-success btn-block">
                            <i class="fas fa-check"></i> Подтвердить
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <button id="resend-code-btn" class="btn btn-secondary btn-block">
                            <i class="fas fa-redo"></i> Отправить код повторно
                        </button>
                    </div>
                    
                    <div class="form-group" style="text-align: center;">
                        <button id="back-to-login" class="link-btn">Вернуться к обычному входу</button>
                    </div>
                </div>
                
                <div id="register-form" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Запрос доступа отправляется начальнику экспедиции. После подтверждения вам будет предоставлен доступ.
                    </div>
                    
                    <div class="form-group">
                        <label for="register-name">ФИО</label>
                        <input type="text" id="register-name" class="form-control" placeholder="Введите ваше полное имя">
                    </div>
                    
                    <div class="form-group">
                        <label for="register-email">Email</label>
                        <input type="email" id="register-email" class="form-control" placeholder="Введите ваш email">
                    </div>
                    
                    <div class="form-group">
                        <label for="register-phone">Телефон</label>
                        <input type="tel" id="register-phone" class="form-control" placeholder="+7 (XXX) XXX-XX-XX">
                    </div>
                    
                    <div class="form-group">
                        <label for="register-expedition">Название экспедиции</label>
                        <input type="text" id="register-expedition" class="form-control" placeholder="Введите название экспедиции">
                    </div>
                    
                    <div class="form-group">
                        <label for="register-role">Роль в экспедиции</label>
                        <select id="register-role" class="form-control">
                            <option value="archaeologist">Археолог</option>
                            <option value="assistant">Помощник</option>
                            <option value="student">Студент</option>
                            <option value="researcher">Исследователь</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="register-message">Дополнительная информация</label>
                        <textarea id="register-message" class="form-control" rows="3" placeholder="Расскажите о себе и причинах запроса доступа"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <div class="field-checkbox">
                            <input type="checkbox" id="enable-2fa-register">
                            <label for="enable-2fa-register">Включить двухфакторную аутентификацию для моего аккаунта</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button id="register-btn" class="btn btn-block btn-success">
                            <i class="fas fa-paper-plane"></i> Отправить запрос
                        </button>
                    </div>
                    
                    <div class="form-group" style="text-align: center;">
                        <button id="show-login" class="link-btn">Вернуться ко входу</button>
                    </div>
                </div>
            </div>
        </div>

        <header id="site-header" style="display: none;">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-map-marked-alt"></i>
                </div>
                <div>
                    <h1>ArchaeoPoint</h1>
                    <div class="tagline">От раскопа до карты в один клик</div>
                </div>
            </div>
            
            <nav>
                <ul>
                    <li><a href="#" id="nav-welcome">Главная</a></li>
                    <li><a href="#" id="nav-map">Карта раскопок</a></li>
                    <li><a href="#" id="nav-artifacts">Артефакты</a></li>
                    
                    <li><a href="#" id="nav-dashboard">Панель управления</a></li>
                    <li><a href="#" id="nav-profile">Личный кабинет</a></li>
                </ul>
            </nav>
            
            <div class="header-controls">
                <div class="sync-status" id="sync-status">
                    <i class="fas fa-sync"></i>
                    <span>Синхронизировано</span>
                </div>
                
                <button class="theme-toggle" id="theme-toggle" title="Сменить тему">
                    <i class="fas fa-moon"></i>
                </button>
                
                <div class="user-info">
                    <div class="avatar" id="user-avatar">ИИ</div>
                    <div>
                        <div id="user-name">Иван Археологов</div>
                        <div id="user-role" style="font-size: 0.8rem; opacity: 0.8;">Археолог</div>
                    </div>
                    <button id="logout-btn" class="btn btn-secondary" style="padding: 0.5rem 1rem; margin-left: 1rem;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <main id="main-content" style="display: none;">
            <div id="welcome-page" class="page active">
                <div class="welcome-hero">
                    <h1>Добро пожаловать в ArchaeoPoint</h1>
                    <p>Профессиональная платформа для цифровой фиксации и управления археологическими данными с точной ГИС-привязкой.</p>
                    <div class="map-tools" style="justify-content: center; margin-top: 2rem;">
                        <button id="goto-map-btn" class="btn">
                            <i class="fas fa-map-marked-alt"></i> Перейти к карте раскопок
                        </button>
                        <button id="quick-add-artifact" class="btn btn-success">
                            <i class="fas fa-plus-circle"></i> Быстро добавить артефакт
                        </button>
                    </div>
                </div>
                
                <div class="features">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-wifi-slash"></i>
                        </div>
                        <h3>Офлайн-режим</h3>
                        <p>Работайте без интернета. Данные сохраняются локально и автоматически синхронизируются при появлении соединения.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h3>AI распознавание</h3>
                        <p>Нейросеть анализирует фотографии и предлагает тип артефакта с указанием вероятности.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-microphone"></i>
                        </div>
                        <h3>Голосовой ввод</h3>
                        <p>Диктуйте описания голосом, когда руки заняты инструментами или испачканы землей.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <h3>3D фиксация</h3>
                        <p>Запись координат X, Y, Z для построения трехмерных моделей культурных слоев.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <h3>Тепловые карты</h3>
                        <p>Визуализация плотности находок для определения наиболее перспективных участков раскопа.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h3>Двухфакторная аутентификация</h3>
                        <p>Защита от неавторизованного доступа через SMS или приложение-аутентификатор.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-book-open"></i>
                        </div>
                        <h3>Полевой журнал</h3>
                        <p>Голосовые записи, AI-расшифровка речи и инструменты для создания чертежей.</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-paint-brush"></i>
                        </div>
                        <h3>Чертежи и схемы</h3>
                        <p>Профессиональные инструменты для создания археологических чертежей прямо на планшете.</p>
                    </div>
                </div>
            </div>

            <div id="map-page" class="page">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="color: var(--primary-color);">
                        <i class="fas fa-map-marked-alt"></i> Интерактивная карта раскопок
                    </h2>
                    <div class="map-tools">
                        <button id="toggle-heatmap" class="map-tool-btn">
                            <i class="fas fa-fire"></i> Тепловая карта
                        </button>
                        <button id="toggle-3d" class="map-tool-btn">
                            <i class="fas fa-cube"></i> 3D вид
                        </button>
                        <button id="measure-distance" class="map-tool-btn">
                            <i class="fas fa-ruler"></i> Измерить
                        </button>
                    </div>
                </div>
                
                <p style="margin-bottom: 1.5rem; color: #666;">Используйте карту для визуализации находок, добавления новых артефактов и анализа расположения объектов.</p>
                
                <div id="map-container">
                    <div id="map"></div>
                    
                    <div class="map-controls">
                        <h3><i class="fas fa-layer-group"></i> Управление картой</h3>
                        
                        <div class="map-controls-section">
                            <h4>Слои карты:</h4>
                            <div class="layer-control">
                                <label>
                                    <input type="radio" name="map-layer" value="osm" checked> 
                                    <span>Спутниковая карта</span>
                                </label>
                            </div>
                            <div class="layer-control">
                                <label>
                                    <input type="radio" name="map-layer" value="topo"> 
                                    <span>Топографическая карта</span>
                                </label>
                            </div>
                            <div class="layer-control">
                                <label>
                                    <input type="radio" name="map-layer" value="scheme"> 
                                    <span>Схема раскопа</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="map-controls-section">
                            <h4>Типы артефактов:</h4>
                            <div class="artifact-control">
                                <label>
                                    <input type="checkbox" name="artifact-type" value="gold" checked> 
                                    <span class="color-indicator artifact-gold"></span>
                                    <span>Золотые изделия</span>
                                </label>
                            </div>
                            <div class="artifact-control">
                                <label>
                                    <input type="checkbox" name="artifact-type" value="ceramic" checked> 
                                    <span class="color-indicator artifact-ceramic"></span>
                                    <span>Керамика</span>
                                </label>
                            </div>
                            <div class="artifact-control">
                                <label>
                                    <input type="checkbox" name="artifact-type" value="bones" checked> 
                                    <span class="color-indicator artifact-bones"></span>
                                    <span>Костные останки</span>
                                </label>
                            </div>
                            <div class="artifact-control">
                                <label>
                                    <input type="checkbox" name="artifact-type" value="metal" checked> 
                                    <span class="color-indicator artifact-metal"></span>
                                    <span>Металлические изделия</span>
                                </label>
                            </div>
                            <div class="artifact-control">
                                <label>
                                    <input type="checkbox" name="artifact-type" value="stone" checked> 
                                    <span class="color-indicator artifact-stone"></span>
                                    <span>Каменные изделия</span>
                                </label>
                            </div>
                            <div class="artifact-control">
                                <label>
                                    <input type="checkbox" name="artifact-type" value="other" checked> 
                                    <span class="color-indicator artifact-other"></span>
                                    <span>Прочие находки</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="map-controls-section">
                            <h4>Инструменты:</h4>
                            <div class="map-tools">
                                <button id="add-artifact-btn" class="map-tool-btn">
                                    <i class="fas fa-plus"></i> Добавить находку
                                </button>
                                <button id="center-map-btn" class="map-tool-btn">
                                    <i class="fas fa-crosshairs"></i> Центрировать
                                </button>
                                <button id="show-legend-btn" class="map-tool-btn">
                                    <i class="fas fa-info-circle"></i> Легенда
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="map-measurement-result" id="measurement-result"></div>
                    <div class="heatmap-legend" id="heatmap-legend" style="display: none;">
                        <h4>Плотность находок</h4>
                        <div class="heatmap-gradient"></div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                            <span>Низкая</span>
                            <span>Высокая</span>
                        </div>
                    </div>
                </div>
                
                <div class="visualization-3d" id="visualization-3d" style="display: none; margin-top: 2rem;">
                    <div style="position: absolute; top: 20px; left: 20px; color: #333; background-color: rgba(255,255,255,0.9); padding: 1rem; border-radius: var(--border-radius);">
                        <h4>3D визуализация культурных слоев</h4>
                        <p>Глубина отображена в метрах. Каждый цвет представляет разные типы артефактов.</p>
                    </div>
                    <div class="visualization-controls">
                        <button id="rotate-3d" class="btn btn-sm">
                            <i class="fas fa-sync"></i> Вращать
                        </button>
                        <button id="zoom-3d" class="btn btn-sm">
                            <i class="fas fa-search"></i> Приблизить
                        </button>
                        <button id="reset-3d" class="btn btn-sm">
                            <i class="fas fa-home"></i> Сброс
                        </button>
                    </div>
                </div>
            </div>

            <div id="artifacts-page" class="page">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="color: var(--primary-color);">
                        <i class="fas fa-history"></i> База артефактов
                    </h2>
                    <div class="map-tools">
                        <button id="new-artifact-btn" class="btn">
                            <i class="fas fa-plus"></i> Добавить артефакт
                        </button>
                        <button id="batch-upload-btn" class="btn btn-info">
                            <i class="fas fa-folder-plus"></i> Пакетная загрузка
                        </button>
                        <button id="export-artifacts-btn" class="btn btn-success">
                            <i class="fas fa-file-export"></i> Экспорт
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="artifacts-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Название</th>
                                <th>Тип</th>
                                <th>Дата находки</th>
                                <th>Координаты (X, Y, Z)</th>
                                <th>Нашедший</th>
                                <th>Слой</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="artifacts-table-body">
                        </tbody>
                    </table>
                </div>
                
                <div class="stratigraphy-visualization">
                    <div class="stratigraphy-layers">
                        <h3>Стратиграфические слои</h3>
                        <div id="layers-list">
                        </div>
                        <button id="add-layer-btn" class="btn btn-block" style="margin-top: 1rem;">
                            <i class="fas fa-plus"></i> Добавить слой
                        </button>
                    </div>
                    <div class="stratigraphy-canvas" id="stratigraphy-canvas">
                        <div style="position: absolute; top: 20px; left: 20px; color: #333; background-color: rgba(255,255,255,0.9); padding: 1rem; border-radius: var(--border-radius);">
                            <h4>Визуализация стратиграфии</h4>
                            <p>Перетащите артефакты на слои для привязки</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="field-journal-page" class="page">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="color: var(--primary-color);">
                        <i class="fas fa-book-open"></i> Полевой журнал
                    </h2>
                    <div class="map-tools">
                        <button id="new-journal-entry" class="btn">
                            <i class="fas fa-plus"></i> Новая запись
                        </button>
                        <button id="export-journal-btn" class="btn btn-success">
                            <i class="fas fa-file-export"></i> Экспорт журнала
                        </button>
                    </div>
                </div>

                <div class="dashboard" style="margin-bottom: 2rem;">
                    <div class="dashboard-card">
                        <h3><i class="fas fa-microphone"></i> Голосовой журнал</h3>
                        <div style="text-align: center; padding: 2rem;">
                            <div id="voice-recording-status" style="margin-bottom: 1.5rem;">
                                <div id="voice-status-icon" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;">
                                    <i class="fas fa-microphone"></i>
                                </div>
                                <div id="voice-status-text" style="color: #666; margin-bottom: 1rem;">
                                    Нажмите кнопку ниже, чтобы начать запись
                                </div>
                                <div id="recording-timer" style="font-size: 1.5rem; font-weight: bold; display: none;">
                                    00:00
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1.5rem;">
                                <button id="start-recording-btn" class="btn btn-success">
                                    <i class="fas fa-record-vinyl"></i> Начать запись
                                </button>
                                <button id="stop-recording-btn" class="btn btn-danger" style="display: none;">
                                    <i class="fas fa-stop"></i> Остановить
                                </button>
                                <button id="pause-recording-btn" class="btn btn-warning" style="display: none;">
                                    <i class="fas fa-pause"></i> Пауза
                                </button>
                            </div>

                            <div class="alert alert-info" style="text-align: left; margin-top: 1rem;">
                                <i class="fas fa-info-circle"></i> 
                                <strong>Советы:</strong> Говорите четко, в тихой обстановке. Можно описывать находки, 
                                стратиграфию, погодные условия, рабочие заметки.
                            </div>
                        </div>

                        <div id="transcription-results" style="margin-top: 2rem; display: none;">
                            <h4>Результат распознавания:</h4>
                            <div class="ai-suggestion" style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>Доверие AI:</strong> 
                                        <span id="transcription-confidence" style="color: var(--success-color);">95%</span>
                                    </div>
                                    <button id="apply-transcription-btn" class="btn btn-sm btn-success">
                                        <i class="fas fa-check"></i> Использовать текст
                                    </button>
                                </div>
                            </div>
                            <div id="transcription-text" style="background-color: #f8f9fa; padding: 1rem; border-radius: var(--border-radius); min-height: 100px; max-height: 300px; overflow-y: auto;">
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <h3><i class="fas fa-paint-brush"></i> Чертежи и схемы</h3>
                        <div id="sketch-tools" style="margin-bottom: 1.5rem;">
                            <div class="map-tools" style="justify-content: center;">
                                <button id="pencil-tool" class="map-tool-btn active" data-tool="pencil">
                                    <i class="fas fa-pencil-alt"></i> Карандаш
                                </button>
                                <button id="line-tool" class="map-tool-btn" data-tool="line">
                                    <i class="fas fa-slash"></i> Линия
                                </button>
                                <button id="rectangle-tool" class="map-tool-btn" data-tool="rectangle">
                                    <i class="fas fa-square"></i> Прямоугольник
                                </button>
                                <button id="circle-tool" class="map-tool-btn" data-tool="circle">
                                    <i class="fas fa-circle"></i> Круг
                                </button>
                                <button id="text-tool" class="map-tool-btn" data-tool="text">
                                    <i class="fas fa-font"></i> Текст
                                </button>
                                <button id="eraser-tool" class="map-tool-btn" data-tool="eraser">
                                    <i class="fas fa-eraser"></i> Ластик
                                </button>
                            </div>

                            <div style="display: flex; gap: 1rem; margin-top: 1rem; justify-content: center;">
                                <div>
                                    <label style="font-size: 0.9rem;">Цвет:</label>
                                    <input type="color" id="drawing-color" value="#000000" style="width: 40px; height: 40px; border: none; border-radius: 50%;">
                                </div>
                                <div>
                                    <label style="font-size: 0.9rem;">Толщина:</label>
                                    <input type="range" id="drawing-width" min="1" max="10" value="2" style="width: 100px;">
                                </div>
                                <div>
                                    <button id="clear-sketch-btn" class="btn btn-sm btn-danger">
                                        <i class="fas fa-trash"></i> Очистить
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="sketch-container" style="background-color: white; border: 2px solid #eee; border-radius: var(--border-radius); height: 400px; position: relative; overflow: hidden;">
                            <canvas id="sketch-canvas" width="800" height="400" style="cursor: crosshair; width: 100%; height: 100%;"></canvas>
                            <div id="sketch-background" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" fill="%23ffffff"/><path d="M0 0 L100 100" stroke="%23f0f0f0" stroke-width="1"/><path d="M100 0 L0 100" stroke="%23f0f0f0" stroke-width="1"/></svg>'); background-size: 20px 20px; pointer-events: none;"></div>
                        </div>

                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button id="save-sketch-btn" class="btn">
                                <i class="fas fa-save"></i> Сохранить чертеж
                            </button>
                            <button id="load-template-btn" class="btn btn-secondary">
                                <i class="fas fa-layer-group"></i> Шаблоны
                            </button>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3><i class="fas fa-edit"></i> Текстовый редактор журнала</h3>
                    <div class="form-group">
                        <label for="journal-title">Заголовок записи *</label>
                        <input type="text" id="journal-title" class="form-control" placeholder="Например: Стратиграфия квадрата 5А">
                    </div>

                    <div class="form-group">
                        <label for="journal-date">Дата записи *</label>
                        <input type="date" id="journal-date" class="form-control" value="2023-06-15">
                    </div>

                    <div class="form-group">
                        <label for="journal-category">Категория</label>
                        <select id="journal-category" class="form-control">
                            <option value="stratigraphy">Стратиграфия</option>
                            <option value="findings">Находки</option>
                            <option value="weather">Погодные условия</option>
                            <option value="observations">Наблюдения</option>
                            <option value="planning">Планирование работ</option>
                            <option value="problems">Проблемы и решения</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="journal-content">Содержание записи *</label>
                        <div class="input-with-icon">
                            <textarea id="journal-content" class="form-control" rows="10" placeholder="Опишите наблюдения, находки, стратиграфию..."></textarea>
                            <button class="voice-input-btn" type="button" title="Голосовой ввод" id="journal-voice-btn">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Прикрепленные материалы</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.5rem;">
                            <div id="attached-sketches" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
                            <div id="attached-audio" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button id="save-journal-btn" class="btn btn-success">
                            <i class="fas fa-save"></i> Сохранить запись
                        </button>
                        <button id="save-draft-btn" class="btn btn-secondary">
                            <i class="fas fa-file-alt"></i> Сохранить черновик
                        </button>
                        <button id="attach-sketch-btn" class="btn">
                            <i class="fas fa-paperclip"></i> Прикрепить чертеж
                        </button>
                        <button id="attach-audio-btn" class="btn">
                            <i class="fas fa-volume-up"></i> Прикрепить аудио
                        </button>
                    </div>
                </div>

                <div class="dashboard-card" style="margin-top: 2rem;">
                    <h3><i class="fas fa-history"></i> Архив записей журнала</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Дата</th>
                                    <th>Заголовок</th>
                                    <th>Категория</th>
                                    <th>Автор</th>
                                    <th>Прикрепления</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="journal-entries-list">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="dashboard-page" class="page">
                <h2 style="margin-bottom: 1.5rem; color: var(--primary-color);">
                    <i class="fas fa-tachometer-alt"></i> Панель управления экспедицией
                </h2>
                
                <div class="dashboard">
                    <div class="dashboard-card">
                        <h3>Статистика экспедиции</h3>
                        <div class="statistics">
                            <div class="stat-item">
                                <div class="stat-value" id="total-artifacts">0</div>
                                <div class="stat-label">Всего артефактов</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="total-users">0</div>
                                <div class="stat-label">Участников</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="today-artifacts">0</div>
                                <div class="stat-label">Находок сегодня</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="last-week">0</div>
                                <div class="stat-label">За 7 дней</div>
                            </div>
                        </div>
                        
                        <h4 style="margin-top: 1.5rem;">Офлайн-данные</h4>
                        <div style="margin-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Ожидающие синхронизации:</span>
                                <span id="pending-sync-count">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Локальное хранилище:</span>
                                <span id="storage-usage">0 MB</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Конструктор отчетов</h3>
                        <p style="margin-bottom: 1.5rem;">Сформируйте отчет для сдачи в институт археологии:</p>
                        
                        <div class="report-builder">
                            <div class="report-fields">
                                <h4>Поля отчета:</h4>
                                <div class="field-checkbox">
                                    <input type="checkbox" id="field-id" checked>
                                    <label for="field-id">ID артефакта</label>
                                </div>
                                <div class="field-checkbox">
                                    <input type="checkbox" id="field-name" checked>
                                    <label for="field-name">Название</label>
                                </div>
                                <div class="field-checkbox">
                                    <input type="checkbox" id="field-type" checked>
                                    <label for="field-type">Тип</label>
                                </div>
                                <div class="field-checkbox">
                                    <input type="checkbox" id="field-coords" checked>
                                    <label for="field-coords">Координаты</label>
                                </div>
                                <div class="field-checkbox">
                                    <input type="checkbox" id="field-depth" checked>
                                    <label for="field-depth">Глубина</label>
                                </div>
                                <div class="field-checkbox">
                                    <input type="checkbox" id="field-context">
                                    <label for="field-context">Контекст</label>
                                </div>
                                <div class="field-checkbox">
                                    <input type="checkbox" id="field-photos">
                                    <label for="field-photos">Фотографии</label>
                                </div>
                                <div class="field-checkbox">
                                    <input type="checkbox" id="field-layer">
                                    <label for="field-layer">Стратиграфический слой</label>
                                </div>
                                
                                <div style="margin-top: 1.5rem;">
                                    <label for="report-format">Формат:</label>
                                    <select id="report-format" class="form-control" style="margin-top: 0.5rem;">
                                        <option value="pdf">PDF</option>
                                        <option value="excel">Excel</option>
                                        <option value="shapefile">Shapefile</option>
                                        <option value="kml">KML (Google Earth)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="report-preview">
                                <h4>Предварительный просмотр</h4>
                                <div id="report-preview-content" style="margin-top: 1rem;">
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                            <button id="generate-report-btn" class="btn btn-success">
                                <i class="fas fa-file-export"></i> Создать отчет
                            </button>
                            <button id="preview-report-btn" class="btn">
                                <i class="fas fa-eye"></i> Предпросмотр
                            </button>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Участники экспедиции</h3>
                        <ul class="user-list" id="expedition-users">
                        </ul>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button id="add-user-btn" class="btn">
                                <i class="fas fa-user-plus"></i> Добавить участника
                            </button>
                            <button id="manage-2fa-btn" class="btn btn-secondary">
                                <i class="fas fa-shield-alt"></i> Управление 2FA
                            </button>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Журнал изменений</h3>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Дата</th>
                                        <th>Действие</th>
                                        <th>Пользователь</th>
                                    </tr>
                                </thead>
                                <tbody id="change-log">
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 1.5rem;">
                            <h4>Синхронизация данных</h4>
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <button id="force-sync-btn" class="btn btn-success">
                                    <i class="fas fa-sync"></i> Принудительная синхронизация
                                </button>
                                <button id="clear-cache-btn" class="btn btn-danger">
                                    <i class="fas fa-trash"></i> Очистить кеш
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="profile-page" class="page">
                <div class="profile-header">
                    <div class="profile-avatar" id="profile-avatar">ИИ</div>
                    <div class="profile-info">
                        <h2 id="profile-name">Иван Археологов</h2>
                        <div id="profile-role" style="margin-bottom: 0.5rem; color: var(--secondary-color); font-weight: 500;">Археолог</div>
                        <div id="profile-expedition" style="color: #666;">Экспедиция "Крым-2023"</div>
                    </div>
                </div>
                
                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="user-artifacts">0</div>
                        <div class="stat-label">Найденных артефактов</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="user-days">0</div>
                        <div class="stat-label">Дней в экспедиции</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="user-last">-</div>
                        <div class="stat-label">Последняя находка</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="user-joined">01.06.2023</div>
                        <div class="stat-label">Дата присоединения</div>
                    </div>
                </div>
                
                <div class="dashboard-card" style="margin-bottom: 2rem;">
                    <h3>Мои последние находки</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Артефакт</th>
                                    <th>Тип</th>
                                    <th>Дата</th>
                                    <th>Координаты</th>
                                </tr>
                            </thead>
                            <tbody id="user-artifacts-list">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h3>Настройки профиля</h3>
                    <div class="form-group">
                        <label for="profile-email">Email</label>
                        <input type="email" id="profile-email" class="form-control" value="ivan@example.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="profile-phone">Телефон (для 2FA)</label>
                        <input type="tel" id="profile-phone" class="form-control" placeholder="+7 (XXX) XXX-XX-XX">
                    </div>
                    
                    <div class="form-group">
                        <label for="profile-notifications">Уведомления</label>
                        <select id="profile-notifications" class="form-control">
                            <option value="all">Все уведомления</option>
                            <option value="important">Только важные</option>
                            <option value="none">Не получать</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <div class="field-checkbox">
                            <input type="checkbox" id="enable-dark-mode" checked>
                            <label for="enable-dark-mode">Темная тема (экономия заряда)</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="field-checkbox">
                            <input type="checkbox" id="enable-voice-input" checked>
                            <label for="enable-voice-input">Включить голосовой ввод</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="field-checkbox">
                            <input type="checkbox" id="enable-ai-recognition" checked>
                            <label for="enable-ai-recognition">Включить AI распознавание</label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button id="save-profile-btn" class="btn">
                            <i class="fas fa-save"></i> Сохранить изменения
                        </button>
                        <button id="setup-2fa-btn" class="btn btn-secondary">
                            <i class="fas fa-shield-alt"></i> Настроить 2FA
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <footer id="site-footer" style="display: none;">
            <p>&copy; 2023 ArchaeoPoint. Все права защищены.</p>
            <p>Система защиты археологических данных с точной ГИС-привязкой</p>
            <div class="footer-links">
                <a href="#"><i class="fas fa-shield-alt"></i> Политика конфиденциальности</a>
                <a href="#"><i class="fas fa-file-contract"></i> Пользовательское соглашение</a>
                <a href="#"><i class="fas fa-envelope"></i> Контакты</a>
                <a href="#" id="install-app-btn"><i class="fas fa-download"></i> Установить приложение</a>
            </div>
        </footer>
    </div>

    <div id="artifact-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Добавление нового артефакта</h3>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="artifact-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="artifact-name">Название артефакта *</label>
                        <div class="input-with-icon">
                            <input type="text" id="artifact-name" class="form-control" placeholder="Например: Бронзовое зеркало">
                            <button class="voice-input-btn" type="button" title="Голосовой ввод" id="artifact-voice-name">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="artifact-type">Тип артефакта *</label>
                        <select id="artifact-type" class="form-control">
                            <option value="">-- Выберите тип --</option>
                            <option value="gold">Золотые изделия</option>
                            <option value="ceramic">Керамика</option>
                            <option value="bones">Костные останки</option>
                            <option value="metal">Металлические изделия</option>
                            <option value="stone">Каменные изделия</option>
                            <option value="other">Прочие находки</option>
                        </select>
                        <div class="ai-suggestion" id="ai-suggestion" style="display: none;">
                            <p>AI предлагает: <strong id="ai-suggested-type">Керамика</strong></p>
                            <div class="ai-confidence">Доверие: <span id="ai-confidence">85%</span></div>
                            <button id="apply-ai-suggestion" class="btn btn-sm" style="margin-top: 0.5rem;">Применить предложение</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="artifact-date">Дата находки *</label>
                        <input type="date" id="artifact-date" class="form-control" value="2023-06-15">
                    </div>
                    
                    <div class="form-group">
                        <label for="artifact-layer">Стратиграфический слой</label>
                        <select id="artifact-layer" class="form-control">
                            <option value="">-- Выберите слой --</option>
                            <option value="layer1">Слой I (современный)</option>
                            <option value="layer2">Слой II (средневековый)</option>
                            <option value="layer3">Слой III (античный)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Координаты (WGS84) *</label>
                        <div class="coordinate-inputs">
                            <div>
                                <input type="text" id="artifact-coords-lat" class="form-control" placeholder="Широта" value="44.948237">
                                <div class="gps-accuracy" id="gps-accuracy-lat">Точность: ±0.000001°</div>
                            </div>
                            <div>
                                <input type="text" id="artifact-coords-lng" class="form-control" placeholder="Долгота" value="34.100318">
                                <div class="gps-accuracy" id="gps-accuracy-lng">Точность: ±0.000001°</div>
                            </div>
                            <div>
                                <input type="text" id="artifact-coords-alt" class="form-control" placeholder="Высота (Z)" value="125.5">
                                <div class="gps-accuracy" id="gps-accuracy-alt">Точность: ±0.1м</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="artifact-depth">Глубина (см)</label>
                        <input type="number" id="artifact-depth" class="form-control" placeholder="Например: 45" value="45">
                    </div>
                    
                    <div class="form-group">
                        <button id="get-gps-location" class="btn btn-block" style="margin-top: 1.5rem;">
                            <i class="fas fa-location-arrow"></i> Определить текущие координаты
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="artifact-context">Контекст находки *</label>
                    <div class="input-with-icon">
                        <textarea id="artifact-context" class="form-control" rows="3" placeholder="Описание слоя, квадрата раскопа, связанные находки..."></textarea>
                        <button class="voice-input-btn" type="button" title="Голосовой ввод" id="artifact-voice-context">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="artifact-description">Описание артефакта</label>
                    <div class="input-with-icon">
                        <textarea id="artifact-description" class="form-control" rows="3" placeholder="Подробное описание находки..."></textarea>
                        <button class="voice-input-btn" type="button" title="Голосовой ввод" id="artifact-voice-description">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Фотографии артефакта</label>
                    <div class="photo-upload" id="photo-upload-area">
                        <div class="photo-upload-area">
                            <i class="fas fa-camera" style="font-size: 2rem; color: #ccc; margin-bottom: 1rem;"></i>
                            <p>Нажмите для загрузки фотографий</p>
                            <p style="font-size: 0.8rem; color: #999;">Можно загрузить фото in situ и после очистки</p>
                            <button class="btn btn-secondary batch-upload-btn">
                                <i class="fas fa-folder-plus"></i> Пакетная загрузка
                            </button>
                        </div>
                    </div>
                    <div class="photo-preview" id="photo-preview"></div>
                    <input type="file" id="photo-input" accept="image/*" multiple style="display: none;">
                    <input type="file" id="batch-photo-input" accept="image/*" multiple style="display: none;">
                </div>
                
                <div class="form-group" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button id="save-artifact-btn" class="btn btn-success">
                        <i class="fas fa-save"></i> Сохранить артефакт
                    </button>
                    <button id="save-offline-btn" class="btn btn-warning">
                        <i class="fas fa-wifi-slash"></i> Сохранить локально
                    </button>
                    <button id="cancel-artifact-btn" class="btn btn-secondary">Отмена</button>
                </div>
            </div>
        </div>
    </div>

    <div id="batch-upload-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-folder-plus"></i> Пакетная загрузка артефактов</h3>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="batch-upload">
                <div class="batch-files" id="batch-drop-area">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
                    <p>Перетащите сюда фотографии или нажмите для выбора</p>
                    <p style="font-size: 0.8rem; color: #999; margin-top: 1rem;">Поддерживаются JPG, PNG, HEIC</p>
                    <p style="font-size: 0.8rem; color: #999;">Максимум 100 файлов за раз</p>
                </div>
                
                <div class="batch-preview" id="batch-preview">
                    <h4>Выбранные файлы (0)</h4>
                    <div id="batch-files-list"></div>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 2rem;">
                <label>Настройки пакетной обработки:</label>
                <div class="form-row">
                    <div class="form-group">
                        <label for="batch-artifact-type">Тип по умолчанию</label>
                        <select id="batch-artifact-type" class="form-control">
                            <option value="other">Прочие находки</option>
                            <option value="ceramic">Керамика</option>
                            <option value="stone">Каменные изделия</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="batch-layer">Слой по умолчанию</label>
                        <select id="batch-layer" class="form-control">
                            <option value="">-- Выберите слой --</option>
                            <option value="layer1">Слой I (современный)</option>
                            <option value="layer2">Слой II (средневековый)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button id="process-batch-btn" class="btn btn-success">
                    <i class="fas fa-play"></i> Начать обработку
                </button>
                <button id="cancel-batch-btn" class="btn btn-secondary">Отмена</button>
            </div>
        </div>
    </div>

    <div id="templates-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-layer-group"></i> Шаблоны чертежей</h3>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="features" style="margin-top: 1rem;">
                <div class="feature-card template-card" data-template="grid">
                    <div class="feature-icon">
                        <i class="fas fa-th"></i>
                    </div>
                    <h3>Координатная сетка</h3>
                    <p>Стандартная сетка для чертежей раскопов</p>
                    <button class="btn btn-sm use-template-btn" data-template="grid">Использовать</button>
                </div>
                
                <div class="feature-card template-card" data-template="stratigraphy">
                    <div class="feature-icon">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <h3>Стратиграфическая колонка</h3>
                    <p>Шаблон для стратиграфических описаний</p>
                    <button class="btn btn-sm use-template-btn" data-template="stratigraphy">Использовать</button>
                </div>
                
                <div class="feature-card template-card" data-template="plan">
                    <div class="feature-icon">
                        <i class="fas fa-map"></i>
                    </div>
                    <h3>План раскопа</h3>
                    <p>Шаблон для планов археологических раскопов</p>
                    <button class="btn btn-sm use-template-btn" data-template="plan">Использовать</button>
                </div>
                
                <div class="feature-card template-card" data-template="profile">
                    <div class="feature-icon">
                        <i class="fas fa-mountain"></i>
                    </div>
                    <h3>Профиль разреза</h3>
                    <p>Для черчения профилей стратиграфии</p>
                    <button class="btn btn-sm use-template-btn" data-template="profile">Использовать</button>
                </div>
            </div>
        </div>
    </div>

    <div id="twofa-setup-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-shield-alt"></i> Настройка двухфакторной аутентификации</h3>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="artifact-form">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Двухфакторная аутентификация добавляет дополнительный уровень безопасности к вашему аккаунту.
                </div>
                
                <div class="form-group">
                    <label>Способ аутентификации:</label>
                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="twofa-method" value="sms" checked>
                            <span>SMS</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="radio" name="twofa-method" value="app">
                            <span>Приложение (Google Authenticator)</span>
                        </label>
                    </div>
                </div>
                
                <div id="twofa-sms-section">
                    <div class="form-group">
                        <label for="twofa-phone">Номер телефона</label>
                        <input type="tel" id="twofa-phone" class="form-control" placeholder="+7 (XXX) XXX-XX-XX">
                    </div>
                    
                    <div class="form-group">
                        <button id="send-sms-code-btn" class="btn">
                            <i class="fas fa-sms"></i> Отправить код подтверждения
                        </button>
                    </div>
                </div>
                
                <div id="twofa-app-section" style="display: none;">
                    <div class="alert alert-info">
                        <p>1. Установите приложение Google Authenticator на ваш телефон</p>
                        <p>2. Отсканируйте QR-код ниже или введите код вручную</p>
                    </div>
                    
                    <div class="qr-code-container">
                        <div class="qr-code" id="twofa-qr-code">
                        </div>
                        <p style="margin-top: 1rem;">Секретный ключ: <code id="twofa-secret">JBSWY3DPEHPK3PXP</code></p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Код подтверждения</label>
                    <div class="two-factor-code">
                        <input type="text" maxlength="1" pattern="[0-9]">
                        <input type="text" maxlength="1" pattern="[0-9]">
                        <input type="text" maxlength="1" pattern="[0-9]">
                        <input type="text" maxlength="1" pattern="[0-9]">
                        <input type="text" maxlength="1" pattern="[0-9]">
                        <input type="text" maxlength="1" pattern="[0-9]">
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button id="verify-twofa-btn" class="btn btn-success">
                        <i class="fas fa-check"></i> Подтвердить и включить
                    </button>
                    <button id="disable-twofa-btn" class="btn btn-danger">
                        <i class="fas fa-ban"></i> Отключить 2FA
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="qr-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-qrcode"></i> QR-код артефакта</h3>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="qr-code-container">
                <p>QR-код для маркировки артефакта. Распечатайте и приклейте к бирке находки.</p>
                <div class="qr-code" id="qr-code-display">
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; color: #333;">QR</div>
                        <div style="font-size: 0.8rem;">ArchaeoPoint</div>
                    </div>
                </div>
                <p id="qr-artifact-name" style="font-weight: bold; margin-top: 1rem;">Бронзовое зеркало</p>
                <p id="qr-artifact-id" style="font-size: 0.9rem; color: #666;">ID: AP-2023-001</p>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: center;">
                    <button id="print-qr-btn" class="btn">
                        <i class="fas fa-print"></i> Распечатать
                    </button>
                    <button id="download-qr-btn" class="btn btn-success">
                        <i class="fas fa-download"></i> Скачать
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Добавление участника экспедиции</h3>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="artifact-form">
                <div class="form-group">
                    <label for="new-user-name">ФИО *</label>
                    <input type="text" id="new-user-name" class="form-control" placeholder="Введите полное имя">
                </div>
                
                <div class="form-group">
                    <label for="new-user-email">Email *</label>
                    <input type="email" id="new-user-email" class="form-control" placeholder="Введите email">
                </div>
                
                <div class="form-group">
                    <label for="new-user-phone">Телефон</label>
                    <input type="tel" id="new-user-phone" class="form-control" placeholder="+7 (XXX) XXX-XX-XX">
                </div>
                
                <div class="form-group">
                    <label for="new-user-role">Роль *</label>
                    <select id="new-user-role" class="form-control">
                        <option value="archaeologist">Археолог</option>
                        <option value="assistant">Помощник</option>
                        <option value="student">Студент</option>
                        <option value="admin">Администратор</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="new-user-expedition">Экспедиция *</label>
                    <input type="text" id="new-user-expedition" class="form-control" placeholder="Название экспедиции">
                </div>
                
                <div class="form-group">
                    <div class="field-checkbox">
                        <input type="checkbox" id="new-user-enable-2fa">
                        <label for="new-user-enable-2fa">Включить двухфакторную аутентификацию</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <button id="save-user-btn" class="btn btn-success">Добавить участника</button>
                    <button id="cancel-user-btn" class="btn btn-secondary">Отмена</button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-journal-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="view-journal-title">Просмотр записи журнала</h3>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="artifact-form">
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; color: #666;">
                        <span id="view-journal-date">Дата: 2023-06-15</span>
                        <span id="view-journal-author">Автор: Иван Археологов</span>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <span class="user-role role-archaeologist" id="view-journal-category">Категория: Стратиграфия</span>
                    </div>
                </div>
                
                <div id="view-journal-content" style="background-color: #f8f9fa; padding: 1.5rem; border-radius: var(--border-radius); min-height: 200px; margin-bottom: 1.5rem;">
                </div>
                
                <div id="view-journal-attachments">
                    <h4>Прикрепленные материалы:</h4>
                    <div id="view-attachments-list"></div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button id="edit-journal-btn" class="btn">
                        <i class="fas fa-edit"></i> Редактировать
                    </button>
                    <button id="delete-journal-btn" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Удалить
                    </button>
                    <button id="print-journal-btn" class="btn btn-secondary">
                        <i class="fas fa-print"></i> Печать
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script>
        let currentUser = null;
        let map = null;
        let markersCluster = null;
        let heatmapLayer = null;
        let artifactMarkers = [];
        let artifacts = [];
        let pendingSync = [];
        let users = [];
        let expeditions = [];
        let isOnline = navigator.onLine;
        let isMeasuring = false;
        let measurementPoints = [];
        let isListening = false;
        let recognition = null;
        
        let journalEntries = [];
        let isRecording = false;
        let isPaused = false;
        let recordingStartTime = null;
        let recordingTimer = null;
        let audioChunks = [];
        let mediaRecorder = null;
        let audioContext = null;
        let analyser = null;
        let currentSketch = null;
        let currentTool = 'pencil';
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let canvas = null;
        let ctx = null;
        
        const CONFIG = {
            OFFLINE_STORAGE_KEY: 'archaeopoint_offline_data',
            SYNC_INTERVAL: 30000,
            MAX_OFFLINE_STORAGE: 50 * 1024 * 1024,
            GPS_ACCURACY_THRESHOLD: 10,
            AI_CONFIDENCE_THRESHOLD: 70
        };
        
        const OFFLINE_STORAGE = {
            save: function(key, data) {
                try {
                    const item = {
                        data: data,
                        timestamp: new Date().toISOString(),
                        synced: false
                    };
                    localStorage.setItem(key, JSON.stringify(item));
                    this.updatePendingSync();
                    return true;
                } catch (e) {
                    console.error('Ошибка сохранения:', e);
                    return false;
                }
            },
            
            load: function(key) {
                try {
                    const item = JSON.parse(localStorage.getItem(key));
                    return item ? item.data : null;
                } catch (e) {
                    console.error('Ошибка загрузки:', e);
                    return null;
                }
            },
            
            remove: function(key) {
                localStorage.removeItem(key);
                this.updatePendingSync();
            },
            
            getAll: function() {
                const items = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('artifact_') || key.startsWith('journal_') || key.startsWith('pending_')) {
                        try {
                            const item = JSON.parse(localStorage.getItem(key));
                            items.push({ key, ...item });
                        } catch (e) {
                            console.error('Ошибка парсинга:', key, e);
                        }
                    }
                }
                return items;
            },
            
            updatePendingSync: function() {
                const pending = this.getAll().filter(item => !item.synced);
                pendingSync = pending;
                
                const pendingCount = pending.length;
                document.getElementById('pending-changes').textContent = `${pendingCount} изменений ожидают синхронизации`;
                document.getElementById('pending-sync-count').textContent = pendingCount;
                
                if (pendingCount > 0) {
                    document.getElementById('sync-status').className = 'sync-status syncing';
                    document.getElementById('sync-status').innerHTML = `<i class="fas fa-sync fa-spin"></i> ${pendingCount} ожидают`;
                } else {
                    document.getElementById('sync-status').className = 'sync-status synced';
                    document.getElementById('sync-status').innerHTML = `<i class="fas fa-check"></i> Синхронизировано`;
                }
            },
            
            getStorageUsage: function() {
                let total = 0;
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    total += key.length + value.length;
                }
                return (total / 1024 / 1024).toFixed(2);
            }
        };
        
        function initMap() {
            const mapCenter = [44.948237, 34.100318];
            
            map = L.map('map').setView(mapCenter, 16);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            markersCluster = L.markerClusterGroup({
                maxClusterRadius: 50,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = 'small';
                    if (count > 20) size = 'large';
                    else if (count > 10) size = 'medium';
                    
                    return L.divIcon({
                        html: `<div><span>${count}</span></div>`,
                        className: `marker-cluster marker-cluster-${size}`,
                        iconSize: L.point(40, 40)
                    });
                }
            });
            
            map.addLayer(markersCluster);
            
            addSampleArtifacts();
            
            map.on('click', function(e) {
                if (isMeasuring) {
                    measurementPoints.push(e.latlng);
                    
                    if (measurementPoints.length === 1) {
                        L.marker(e.latlng, {
                            icon: L.divIcon({
                                html: '<div style="background-color: red; width: 10px; height: 10px; border-radius: 50%;"></div>',
                                iconSize: [10, 10]
                            })
                        }).addTo(map);
                    } else if (measurementPoints.length === 2) {
                        const p1 = measurementPoints[0];
                        const p2 = measurementPoints[1];
                        
                        const line = L.polyline([p1, p2], {
                            color: 'red',
                            dashArray: '10, 10',
                            weight: 3
                        }).addTo(map);
                        
                        const distance = map.distance(p1, p2);
                        const midpoint = L.latLng(
                            (p1.lat + p2.lat) / 2,
                            (p1.lng + p2.lng) / 2
                        );
                        
                        L.marker(midpoint, {
                            icon: L.divIcon({
                                html: `<div class="measurement-label">${distance.toFixed(2)} м</div>`,
                                iconSize: [100, 30],
                                className: 'measurement-label'
                            })
                        }).addTo(map);
                        
                        document.getElementById('measurement-result').innerHTML = 
                            `Расстояние: <strong>${distance.toFixed(2)} метров</strong>`;
                        document.getElementById('measurement-result').style.display = 'block';
                        
                        isMeasuring = false;
                        measurementPoints = [];
                        
                        setTimeout(() => {
                            document.getElementById('measurement-result').style.display = 'none';
                            map.removeLayer(line);
                        }, 5000);
                    }
                }
            });
        }
        
        function initFieldJournal() {
            canvas = document.getElementById('sketch-canvas');
            if (!canvas) return;
            
            ctx = canvas.getContext('2d');
            setupCanvas();
            loadJournalEntries();
            initVoiceRecognition();
            initDrawingTools();
        }
        
        function setupCanvas() {
            if (!canvas) return;
            
            const container = document.getElementById('sketch-container');
            if (!container) return;
            
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.fillStyle = 'transparent';
        }
        
        function loadJournalEntries() {
            const savedEntries = OFFLINE_STORAGE.getAll().filter(item => 
                item.key.startsWith('journal_') && !item.key.includes('draft') && !item.key.includes('journal_sketch')
            );
            
            if (savedEntries.length > 0) {
                journalEntries = savedEntries.map(item => item.data);
                journalEntries.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            } else {
                journalEntries = [
                    {
                        id: 1,
                        title: "Стратиграфия квадрата 5А",
                        date: "2023-06-10",
                        category: "stratigraphy",
                        content: "Квадрат 5А. Верхний слой (0-30 см) - современный грунт с включениями строительного мусора. Второй слой (30-80 см) - средневековый культурный слой с находками керамики. Третий слой (80-150 см) - античный слой с фрагментами амфор.",
                        author: "Иван Археологов",
                        attachments: [
                            { type: 'sketch', name: 'Стратиграфия.png' },
                            { type: 'audio', name: 'Запись.wav' }
                        ],
                        createdAt: "2023-06-10T09:30:00Z"
                    },
                    {
                        id: 2,
                        title: "Находка бронзового зеркала",
                        date: "2023-06-12",
                        category: "findings",
                        content: "В квадрате 5Б на глубине 45 см обнаружено бронзовое зеркало с орнаментом по краю. Размеры: диаметр 12 см, толщина 0.3 см. Сохранность хорошая, небольшие следы коррозии.",
                        author: "Мария Петрова",
                        attachments: [
                            { type: 'sketch', name: 'Чертеж зеркала.png' }
                        ],
                        createdAt: "2023-06-12T14:20:00Z"
                    }
                ];
                
                journalEntries.forEach(entry => {
                    OFFLINE_STORAGE.save(`journal_${entry.id}`, entry);
                });
            }
            
            updateJournalEntriesList();
        }
        
        function initVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                const voiceStatus = document.getElementById('voice-recording-status');
                if (voiceStatus) {
                    voiceStatus.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            Ваш браузер не поддерживает голосовой ввод.
                        </div>
                    `;
                }
                return;
            }
        }
        
        function initDrawingTools() {
            if (!canvas) return;
            
            setActiveTool('pencil');
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', handleTouchEnd);
            
            const colorInput = document.getElementById('drawing-color');
            const widthInput = document.getElementById('drawing-width');
            
            if (colorInput) {
                colorInput.addEventListener('change', function() {
                    ctx.strokeStyle = this.value;
                });
            }
            
            if (widthInput) {
                widthInput.addEventListener('input', function() {
                    ctx.lineWidth = this.value;
                });
            }
        }
        
        function setActiveTool(tool) {
            currentTool = tool;
            
            document.querySelectorAll('#sketch-tools .map-tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`[data-tool="${tool}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            if (!canvas) return;
            
            switch(tool) {
                case 'pencil':
                case 'line':
                case 'rectangle':
                case 'circle':
                    canvas.style.cursor = 'crosshair';
                    break;
                case 'eraser':
                    canvas.style.cursor = 'cell';
                    break;
                case 'text':
                    canvas.style.cursor = 'text';
                    break;
            }
        }
        
        function startDrawing(e) {
            if (!canvas || !ctx) return;
            
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
            
            if (currentTool === 'text') {
                showTextInput(e.clientX - rect.left, e.clientY - rect.top);
                isDrawing = false;
            }
        }
        
        function draw(e) {
            if (!isDrawing || !canvas || !ctx) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            switch(currentTool) {
                case 'pencil':
                    drawPencil(x, y);
                    break;
                case 'line':
                    drawLine(x, y);
                    break;
                case 'rectangle':
                    drawRectangle(x, y);
                    break;
                case 'circle':
                    drawCircle(x, y);
                    break;
                case 'eraser':
                    erase(x, y);
                    break;
            }
            
            lastX = x;
            lastY = y;
        }
        
        function stopDrawing() {
            if (!ctx) return;
            
            isDrawing = false;
            ctx.beginPath();
            
            if (currentTool !== 'pencil' && currentTool !== 'eraser') {
                saveCanvasState();
            }
        }
        
        function drawPencil(x, y) {
            const widthInput = document.getElementById('drawing-width');
            const colorInput = document.getElementById('drawing-color');
            
            ctx.lineWidth = widthInput ? widthInput.value : 2;
            ctx.strokeStyle = colorInput ? colorInput.value : '#000000';
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
        }
        
        function drawLine(x, y) {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            tempCtx.drawImage(canvas, 0, 0);
            
            tempCtx.beginPath();
            tempCtx.moveTo(lastX, lastY);
            tempCtx.lineTo(x, y);
            tempCtx.strokeStyle = ctx.strokeStyle;
            tempCtx.lineWidth = ctx.lineWidth;
            tempCtx.stroke();
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(tempCanvas, 0, 0);
        }
        
        function drawRectangle(x, y) {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            tempCtx.drawImage(canvas, 0, 0);
            
            const width = x - lastX;
            const height = y - lastY;
            
            tempCtx.beginPath();
            tempCtx.rect(lastX, lastY, width, height);
            tempCtx.strokeStyle = ctx.strokeStyle;
            tempCtx.lineWidth = ctx.lineWidth;
            tempCtx.stroke();
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(tempCanvas, 0, 0);
        }
        
        function drawCircle(x, y) {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            tempCtx.drawImage(canvas, 0, 0);
            
            const radius = Math.sqrt(Math.pow(x - lastX, 2) + Math.pow(y - lastY, 2));
            
            tempCtx.beginPath();
            tempCtx.arc(lastX, lastY, radius, 0, Math.PI * 2);
            tempCtx.strokeStyle = ctx.strokeStyle;
            tempCtx.lineWidth = ctx.lineWidth;
            tempCtx.stroke();
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(tempCanvas, 0, 0);
        }
        
        function erase(x, y) {
            ctx.save();
            ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath();
            ctx.arc(x, y, ctx.lineWidth * 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }
        
        function showTextInput(x, y) {
            const input = document.createElement('input');
            input.type = 'text';
            input.style.position = 'absolute';
            input.style.left = (canvas.offsetLeft + x) + 'px';
            input.style.top = (canvas.offsetTop + y) + 'px';
            input.style.border = '1px solid #000';
            input.style.padding = '2px';
            input.style.fontSize = '14px';
            input.style.fontFamily = 'Arial';
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    drawText(x, y, this.value);
                    this.remove();
                }
            });
            
            input.addEventListener('blur', function() {
                if (this.value) {
                    drawText(x, y, this.value);
                }
                this.remove();
            });
            
            const container = document.getElementById('sketch-container');
            if (container) {
                container.appendChild(input);
                input.focus();
            }
        }
        
        function drawText(x, y, text) {
            ctx.font = '16px Arial';
            ctx.fillStyle = ctx.strokeStyle;
            ctx.fillText(text, x, y);
        }
        
        function saveCanvasState() {
            if (canvas) {
                currentSketch = canvas.toDataURL('image/png');
            }
        }
        
        function clearCanvas() {
            if (ctx && canvas) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                currentSketch = null;
            }
        }
        
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }
        
        function handleTouchEnd(e) {
            e.preventDefault();
            const mouseEvent = new MouseEvent('mouseup', {});
            canvas.dispatchEvent(mouseEvent);
        }
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = function(event) {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = function() {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    processAudioRecording(audioUrl, audioBlob);
                    
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                document.getElementById('start-recording-btn').style.display = 'none';
                document.getElementById('stop-recording-btn').style.display = 'inline-block';
                document.getElementById('pause-recording-btn').style.display = 'inline-block';
                
                const voiceStatusIcon = document.getElementById('voice-status-icon');
                const voiceStatusText = document.getElementById('voice-status-text');
                
                if (voiceStatusIcon) {
                    voiceStatusIcon.innerHTML = '<i class="fas fa-microphone recording"></i>';
                }
                
                if (voiceStatusText) {
                    voiceStatusText.textContent = 'Идет запись...';
                    voiceStatusText.style.color = '#e74c3c';
                }
                
                startRecordingTimer();
                startAudioVisualization(stream);
                
            } catch (error) {
                console.error('Error accessing microphone:', error);
                showAlert('Не удалось получить доступ к микрофону.', 'danger');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                document.getElementById('start-recording-btn').style.display = 'inline-block';
                document.getElementById('stop-recording-btn').style.display = 'none';
                document.getElementById('pause-recording-btn').style.display = 'none';
                
                const voiceStatusIcon = document.getElementById('voice-status-icon');
                const voiceStatusText = document.getElementById('voice-status-text');
                
                if (voiceStatusIcon) {
                    voiceStatusIcon.innerHTML = '<i class="fas fa-microphone"></i>';
                }
                
                if (voiceStatusText) {
                    voiceStatusText.textContent = 'Запись завершена';
                    voiceStatusText.style.color = '#27ae60';
                }
                
                stopRecordingTimer();
                stopAudioVisualization();
            }
        }
        
        function togglePauseRecording() {
            if (!mediaRecorder) return;
            
            if (isPaused) {
                mediaRecorder.resume();
                isPaused = false;
                document.getElementById('pause-recording-btn').innerHTML = '<i class="fas fa-pause"></i> Пауза';
                resumeRecordingTimer();
            } else {
                mediaRecorder.pause();
                isPaused = true;
                document.getElementById('pause-recording-btn').innerHTML = '<i class="fas fa-play"></i> Продолжить';
                pauseRecordingTimer();
            }
        }
        
        function startRecordingTimer() {
            recordingStartTime = new Date();
            const timerElement = document.getElementById('recording-timer');
            if (timerElement) {
                timerElement.style.display = 'block';
            }
            
            recordingTimer = setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - recordingStartTime) / 1000);
                const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
                const seconds = (diff % 60).toString().padStart(2, '0');
                
                const timerElement = document.getElementById('recording-timer');
                if (timerElement) {
                    timerElement.textContent = `${minutes}:${seconds}`;
                }
            }, 1000);
        }
        
        function pauseRecordingTimer() {
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
        }
        
        function resumeRecordingTimer() {
            if (!recordingTimer) {
                startRecordingTimer();
            }
        }
        
        function stopRecordingTimer() {
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            
            const timerElement = document.getElementById('recording-timer');
            if (timerElement) {
                timerElement.style.display = 'none';
                timerElement.textContent = '00:00';
            }
        }
        
        function startAudioVisualization(stream) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const source = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            
            source.connect(analyser);
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            const visualizer = document.createElement('div');
            visualizer.className = 'visualizer';
            visualizer.id = 'audio-visualizer';
            
            for (let i = 0; i < bufferLength; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                bar.style.left = `${(i / bufferLength) * 100}%`;
                bar.style.height = '0px';
                visualizer.appendChild(bar);
            }
            
            const voiceStatus = document.getElementById('voice-recording-status');
            if (voiceStatus) {
                voiceStatus.appendChild(visualizer);
            }
            
            function updateVisualization() {
                if (!isRecording || !analyser) return;
                
                analyser.getByteFrequencyData(dataArray);
                const bars = visualizer.querySelectorAll('.visualizer-bar');
                
                bars.forEach((bar, i) => {
                    const value = dataArray[i];
                    bar.style.height = `${value / 2}px`;
                });
                
                requestAnimationFrame(updateVisualization);
            }
            
            updateVisualization();
        }
        
        function stopAudioVisualization() {
            const visualizer = document.getElementById('audio-visualizer');
            if (visualizer) {
                visualizer.remove();
            }
            analyser = null;
        }
        
        function processAudioRecording(audioUrl, audioBlob) {
            const audioPlayer = `
                <div class="attachment-item">
                    <i class="fas fa-volume-up"></i>
                    <span>Аудиозапись ${formatTime(new Date() - recordingStartTime)}</span>
                    <audio controls class="audio-player">
                        <source src="${audioUrl}" type="audio/wav">
                        Ваш браузер не поддерживает аудио элементы.
                    </audio>
                </div>
            `;
            
            const attachedAudio = document.getElementById('attached-audio');
            if (attachedAudio) {
                attachedAudio.innerHTML = audioPlayer;
            }
            
            simulateSpeechRecognition();
        }
        
        function simulateSpeechRecognition() {
            setTimeout(() => {
                const sampleTexts = [
                    "Квадрат пять А. Глубина сорок пять сантиметров. Находка - фрагменты керамики. Диаметр примерно пятнадцать сантиметров. Орнамент линейный.",
                    "Погодные условия: утро плюс восемнадцать градусов, ясно. Ветер слабый. Дневная температура плюс двадцать пять. Кратковременный дождь в четырнадцать тридцать.",
                    "Стратиграфия: верхний слой темно-серый суглинок мощностью тридцать сантиметров. Второй слой коричневый суглинок с включениями угля. Третий слой светло-желтый песок."
                ];
                
                const randomText = sampleTexts[Math.floor(Math.random() * sampleTexts.length)];
                const confidence = Math.floor(Math.random() * 20) + 80;
                
                const transcriptionResults = document.getElementById('transcription-results');
                const transcriptionText = document.getElementById('transcription-text');
                const transcriptionConfidence = document.getElementById('transcription-confidence');
                
                if (transcriptionResults) {
                    transcriptionResults.style.display = 'block';
                }
                
                if (transcriptionText) {
                    transcriptionText.textContent = randomText;
                }
                
                if (transcriptionConfidence) {
                    transcriptionConfidence.textContent = `${confidence}%`;
                    
                    if (confidence >= 90) {
                        transcriptionConfidence.style.color = '#27ae60';
                    } else if (confidence >= 80) {
                        transcriptionConfidence.style.color = '#f39c12';
                    } else {
                        transcriptionConfidence.style.color = '#e74c3c';
                    }
                }
                
            }, 1500);
        }
        
        function formatTime(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        function loadTemplate(templateType) {
            clearCanvas();
            
            switch(templateType) {
                case 'grid':
                    drawGridTemplate();
                    break;
                case 'stratigraphy':
                    drawStratigraphyTemplate();
                    break;
                case 'plan':
                    drawPlanTemplate();
                    break;
                case 'profile':
                    drawProfileTemplate();
                    break;
            }
            
            showAlert(`Шаблон "${getTemplateName(templateType)}" загружен`, 'success');
        }
        
        function getTemplateName(templateType) {
            const names = {
                grid: 'Координатная сетка',
                stratigraphy: 'Стратиграфическая колонка',
                plan: 'План раскопа',
                profile: 'Профиль разреза'
            };
            return names[templateType] || 'Шаблон';
        }
        
        function drawGridTemplate() {
            if (!ctx) return;
            
            ctx.strokeStyle = '#cccccc';
            ctx.lineWidth = 1;
            
            for (let x = 50; x < canvas.width; x += 50) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
                
                ctx.fillStyle = '#666666';
                ctx.font = '12px Arial';
                ctx.fillText(`${x/10}m`, x-10, 20);
            }
            
            for (let y = 50; y < canvas.height; y += 50) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
                
                ctx.fillStyle = '#666666';
                ctx.font = '12px Arial';
                ctx.fillText(`${y/10}m`, 10, y+5);
            }
            
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(canvas.width/2, 0);
            ctx.lineTo(canvas.width/2, canvas.height);
            ctx.moveTo(0, canvas.height/2);
            ctx.lineTo(canvas.width, canvas.height/2);
            ctx.stroke();
            
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 16px Arial';
            ctx.fillText('Координатная сетка раскопа', canvas.width/2 - 100, 40);
            
            saveCanvasState();
        }
        
        function drawStratigraphyTemplate() {
            if (!ctx) return;
            
            const colWidth = 100;
            const colX = canvas.width/2 - colWidth/2;
            const colHeight = canvas.height - 100;
            const colY = 50;
            
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3;
            ctx.strokeRect(colX, colY, colWidth, colHeight);
            
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 16px Arial';
            ctx.fillText('Стратиграфическая колонка', canvas.width/2 - 80, 30);
            
            ctx.strokeStyle = '#666666';
            ctx.lineWidth = 1;
            ctx.font = '12px Arial';
            
            for (let depth = 0; depth <= 5; depth++) {
                const y = colY + (depth/5) * colHeight;
                ctx.beginPath();
                ctx.moveTo(colX - 10, y);
                ctx.lineTo(colX, y);
                ctx.stroke();
                ctx.fillText(`${depth * 100} см`, colX - 50, y + 4);
            }
            
            const layers = [
                { name: 'Современный слой', depth: 0.3, color: '#8B4513' },
                { name: 'Средневековый слой', depth: 0.8, color: '#D2691E' },
                { name: 'Античный слой', depth: 1.5, color: '#A0522D' }
            ];
            
            let currentY = colY;
            layers.forEach((layer, index) => {
                const layerHeight = (layer.depth / 5) * colHeight;
                ctx.fillStyle = layer.color;
                ctx.fillRect(colX, currentY, colWidth, layerHeight);
                
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '12px Arial';
                ctx.save();
                ctx.translate(colX + 10, currentY + layerHeight/2);
                ctx.rotate(-Math.PI/2);
                ctx.fillText(layer.name, 0, 0);
                ctx.restore();
                
                currentY += layerHeight;
            });
            
            saveCanvasState();
        }
        
        function drawPlanTemplate() {
            if (!ctx) return;
            
            const squareSize = 300;
            const squareX = canvas.width/2 - squareSize/2;
            const squareY = canvas.height/2 - squareSize/2;
            
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3;
            ctx.strokeRect(squareX, squareY, squareSize, squareSize);
            
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 16px Arial';
            ctx.fillText('План археологического раскопа', canvas.width/2 - 120, 40);
            
            ctx.strokeStyle = '#666666';
            ctx.lineWidth = 1;
            
            const gridSize = squareSize / 5;
            for (let i = 1; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(squareX + i * gridSize, squareY);
                ctx.lineTo(squareX + i * gridSize, squareY + squareSize);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(squareX, squareY + i * gridSize);
                ctx.lineTo(squareX + squareSize, squareY + i * gridSize);
                ctx.stroke();
            }
            
            ctx.fillStyle = '#000000';
            ctx.font = '14px Arial';
            
            for (let i = 0; i <= 5; i++) {
                const x = squareX + i * gridSize;
                ctx.fillText(`${i}`, x - 5, squareY + squareSize + 20);
            }
            ctx.fillText('Ось X (м)', canvas.width/2 - 30, squareY + squareSize + 40);
            
            for (let i = 0; i <= 5; i++) {
                const y = squareY + i * gridSize;
                ctx.fillText(`${5-i}`, squareX - 20, y + 5);
            }
            ctx.save();
            ctx.translate(squareX - 40, canvas.height/2);
            ctx.rotate(-Math.PI/2);
            ctx.fillText('Ось Y (м)', 0, 0);
            ctx.restore();
            
            drawNorthArrow(squareX + squareSize - 50, squareY + 30);
            
            saveCanvasState();
        }
        
        function drawProfileTemplate() {
            if (!ctx) return;
            
            const profileY = canvas.height - 100;
            const profileHeight = 200;
            
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.moveTo(50, profileY);
            ctx.lineTo(canvas.width - 50, profileY);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(50, profileY);
            ctx.lineTo(50, profileY - profileHeight);
            ctx.stroke();
            
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 16px Arial';
            ctx.fillText('Профиль археологического разреза', canvas.width/2 - 120, 40);
            
            ctx.fillStyle = '#666666';
            ctx.font = '12px Arial';
            for (let i = 0; i <= 10; i++) {
                const x = 50 + (i/10) * (canvas.width - 100);
                ctx.beginPath();
                ctx.moveTo(x, profileY);
                ctx.lineTo(x, profileY + 10);
                ctx.stroke();
                ctx.fillText(`${i}m`, x - 5, profileY + 25);
            }
            
            for (let i = 0; i <= 4; i++) {
                const y = profileY - (i/4) * profileHeight;
                ctx.beginPath();
                ctx.moveTo(45, y);
                ctx.lineTo(50, y);
                ctx.stroke();
                ctx.fillText(`${i * 50}см`, 20, y + 4);
            }
            
            ctx.strokeStyle = '#8B4513';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(50, profileY - 50);
            
            const points = [];
            for (let i = 0; i <= 10; i++) {
                const x = 50 + (i/10) * (canvas.width - 100);
                const y = profileY - 50 - Math.random() * 100;
                points.push({x, y});
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            const layers = [
                { name: 'Гумус', yOffset: 30 },
                { name: 'Суглинок', yOffset: 80 },
                { name: 'Песок', yOffset: 140 }
            ];
            
            layers.forEach(layer => {
                ctx.fillStyle = '#000000';
                ctx.font = '12px Arial';
                ctx.fillText(layer.name, 60, profileY - layer.yOffset);
            });
            
            ctx.fillStyle = '#000000';
            ctx.fillText('Расстояние (м)', canvas.width/2 - 40, profileY + 50);
            
            ctx.save();
            ctx.translate(20, canvas.height/2);
            ctx.rotate(-Math.PI/2);
            ctx.fillText('Глубина (см)', 0, 0);
            ctx.restore();
            
            saveCanvasState();
        }
        
        function drawNorthArrow(x, y) {
            ctx.fillStyle = '#000000';
            
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x - 10, y + 20);
            ctx.lineTo(x + 10, y + 20);
            ctx.closePath();
            ctx.fill();
            
            ctx.font = 'bold 14px Arial';
            ctx.fillText('N', x - 4, y + 40);
        }
        
        function saveSketch() {
            if (!canvas) {
                showAlert('Нет чертежа для сохранения', 'danger');
                return;
            }
            
            const dataURL = canvas.toDataURL('image/png');
            const sketchId = 'journal_sketch_' + Date.now();
            
            OFFLINE_STORAGE.save(sketchId, {
                dataURL: dataURL,
                name: `Чертеж ${new Date().toLocaleDateString()}`,
                timestamp: new Date().toISOString(),
                tool: currentTool
            });
            
            const attachedSketches = document.getElementById('attached-sketches');
            if (attachedSketches) {
                const sketchItem = document.createElement('div');
                sketchItem.className = 'attachment-item';
                sketchItem.innerHTML = `
                    <i class="fas fa-drafting-compass"></i>
                    <span>Чертеж ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    <button class="btn btn-sm btn-danger remove-attachment" data-id="${sketchId}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                attachedSketches.appendChild(sketchItem);
                
                sketchItem.querySelector('.remove-attachment').addEventListener('click', function() {
                    OFFLINE_STORAGE.remove(this.dataset.id);
                    this.closest('.attachment-item').remove();
                });
            }
            
            showAlert('Чертеж сохранен и прикреплен к записи', 'success');
        }
        
        function attachSketch() {
            const attachedSketches = document.getElementById('attached-sketches');
            if (!attachedSketches) return;
            
            if (!currentSketch) {
                showAlert('Сначала создайте чертеж', 'warning');
                return;
            }
            
            const sketchId = 'journal_sketch_' + Date.now();
            const sketchItem = document.createElement('div');
            sketchItem.className = 'attachment-item';
            sketchItem.innerHTML = `
                <i class="fas fa-drafting-compass"></i>
                <span>Чертеж ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                <button class="btn btn-sm btn-danger remove-attachment" data-id="${sketchId}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            attachedSketches.appendChild(sketchItem);
            
            OFFLINE_STORAGE.save(sketchId, {
                dataURL: currentSketch,
                name: `Чертеж ${new Date().toLocaleDateString()}`,
                timestamp: new Date().toISOString()
            });
            
            sketchItem.querySelector('.remove-attachment').addEventListener('click', function() {
                OFFLINE_STORAGE.remove(this.dataset.id);
                this.closest('.attachment-item').remove();
            });
            
            showAlert('Чертеж прикреплен к записи', 'success');
        }
        
        function attachAudio() {
            const attachedAudio = document.getElementById('attached-audio');
            if (!attachedAudio) return;
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'audio/*';
            input.style.display = 'none';
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const audioId = 'audio_' + Date.now();
                        const audioUrl = e.target.result;
                        
                        const audioItem = document.createElement('div');
                        audioItem.className = 'attachment-item';
                        audioItem.innerHTML = `
                            <i class="fas fa-volume-up"></i>
                            <span>${file.name}</span>
                            <audio controls class="audio-player">
                                <source src="${audioUrl}" type="${file.type}">
                            </audio>
                            <button class="btn btn-sm btn-danger remove-attachment" data-id="${audioId}">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        attachedAudio.appendChild(audioItem);
                        
                        OFFLINE_STORAGE.save(audioId, {
                            dataURL: audioUrl,
                            name: file.name,
                            timestamp: new Date().toISOString(),
                            type: file.type
                        });
                        
                        audioItem.querySelector('.remove-attachment').addEventListener('click', function() {
                            OFFLINE_STORAGE.remove(this.dataset.id);
                            this.closest('.attachment-item').remove();
                        });
                        
                        showAlert('Аудиофайл прикреплен к записи', 'success');
                    };
                    reader.readAsDataURL(file);
                }
                document.body.removeChild(input);
            });
            
            document.body.appendChild(input);
            input.click();
        }
        
        function saveJournalEntry() {
            const title = document.getElementById('journal-title').value;
            const date = document.getElementById('journal-date').value;
            const category = document.getElementById('journal-category').value;
            const content = document.getElementById('journal-content').value;
            
            if (!title || !content) {
                showAlert('Заполните обязательные поля: заголовок и содержание', 'danger');
                return;
            }
            
            const attachments = [];
            
            const sketchAttachments = document.querySelectorAll('#attached-sketches .attachment-item');
            sketchAttachments.forEach(item => {
                const name = item.querySelector('span').textContent;
                attachments.push({ type: 'sketch', name: name });
            });
            
            const audioAttachments = document.querySelectorAll('#attached-audio .attachment-item');
            audioAttachments.forEach(item => {
                const name = item.querySelector('span').textContent;
                attachments.push({ type: 'audio', name: name });
            });
            
            const newId = journalEntries.length > 0 
                ? Math.max(...journalEntries.map(e => e.id)) + 1 
                : 1;
            
            const entry = {
                id: newId,
                title: title,
                date: date,
                category: category,
                content: content,
                author: currentUser ? currentUser.name : 'Неизвестный пользователь',
                attachments: attachments,
                createdAt: new Date().toISOString()
            };
            
            journalEntries.unshift(entry);
            
            OFFLINE_STORAGE.save(`journal_${entry.id}`, entry);
            
            updateJournalEntriesList();
            
            clearJournalForm();
            
            showAlert('Запись журнала сохранена', 'success');
        }
        
        function saveJournalDraft() {
            const title = document.getElementById('journal-title').value || 'Черновик';
            const content = document.getElementById('journal-content').value;
            
            if (!content) {
                showAlert('Нет содержания для сохранения', 'warning');
                return;
            }
            
            const draft = {
                title: title,
                content: content,
                savedAt: new Date().toLocaleString()
            };
            
            OFFLINE_STORAGE.save('journal_draft', draft);
            showAlert('Черновик сохранен локально', 'success');
        }
        
        function newJournalEntry() {
            clearJournalForm();
            
            const draft = OFFLINE_STORAGE.load('journal_draft');
            if (draft) {
                document.getElementById('journal-title').value = draft.title;
                document.getElementById('journal-content').value = draft.content;
                showAlert('Загружен последний черновик', 'info');
            }
        }
        
        function clearJournalForm() {
            document.getElementById('journal-title').value = '';
            document.getElementById('journal-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('journal-content').value = '';
            
            document.getElementById('attached-sketches').innerHTML = '';
            document.getElementById('attached-audio').innerHTML = '';
            
            const transcriptionResults = document.getElementById('transcription-results');
            if (transcriptionResults) {
                transcriptionResults.style.display = 'none';
            }
        }
        
        function updateJournalEntriesList() {
            const entriesList = document.getElementById('journal-entries-list');
            if (!entriesList) return;
            
            entriesList.innerHTML = '';
            
            if (journalEntries.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="6" style="text-align: center; padding: 2rem; color: #666;">
                        <i class="fas fa-book-open" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                        <p>Записей журнала пока нет</p>
                        <button id="create-first-entry" class="btn btn-sm" style="margin-top: 1rem;">
                            <i class="fas fa-plus"></i> Создать первую запись
                        </button>
                    </td>
                `;
                entriesList.appendChild(emptyRow);
                
                document.getElementById('create-first-entry').addEventListener('click', function() {
                    newJournalEntry();
                    document.getElementById('journal-title').focus();
                });
                
                return;
            }
            
            journalEntries.forEach(entry => {
                const row = document.createElement('tr');
                
                const entryDate = new Date(entry.date);
                const formattedDate = entryDate.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                
                let attachmentsHTML = '';
                if (entry.attachments && entry.attachments.length > 0) {
                    entry.attachments.forEach(attach => {
                        if (attach.type === 'sketch') {
                            attachmentsHTML += '<i class="fas fa-drafting-compass" title="Чертеж"></i> ';
                        } else if (attach.type === 'audio') {
                            attachmentsHTML += '<i class="fas fa-volume-up" title="Аудиозапись"></i> ';
                        }
                    });
                }
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td><strong>${entry.title}</strong></td>
                    <td><span class="user-role role-${entry.category}">${getCategoryName(entry.category)}</span></td>
                    <td>${entry.author}</td>
                    <td>${attachmentsHTML || '-'}</td>
                    <td>
                        <button class="btn btn-sm" onclick="viewJournalEntry(${entry.id})" title="Просмотр">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="editJournalEntry(${entry.id})" title="Редактировать">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteJournalEntry(${entry.id})" title="Удалить">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                entriesList.appendChild(row);
            });
        }
        
        function getCategoryName(category) {
            const categories = {
                stratigraphy: 'Стратиграфия',
                findings: 'Находки',
                weather: 'Погодные условия',
                observations: 'Наблюдения',
                planning: 'Планирование работ',
                problems: 'Проблемы и решения'
            };
            return categories[category] || category;
        }
        
        window.viewJournalEntry = function(id) {
            const entry = journalEntries.find(e => e.id === id);
            if (!entry) return;
            
            document.getElementById('view-journal-title').textContent = entry.title;
            document.getElementById('view-journal-date').textContent = `Дата: ${entry.date}`;
            document.getElementById('view-journal-author').textContent = `Автор: ${entry.author}`;
            document.getElementById('view-journal-category').textContent = `Категория: ${getCategoryName(entry.category)}`;
            document.getElementById('view-journal-content').innerHTML = `<p style="white-space: pre-wrap;">${entry.content}</p>`;
            
            const attachmentsList = document.getElementById('view-attachments-list');
            if (attachmentsList) {
                attachmentsList.innerHTML = '';
                
                if (entry.attachments.length === 0) {
                    attachmentsList.innerHTML = '<p>Нет прикрепленных материалов</p>';
                } else {
                    entry.attachments.forEach(attach => {
                        const attachItem = document.createElement('div');
                        attachItem.className = 'attachment-item';
                        
                        if (attach.type === 'sketch') {
                            attachItem.innerHTML = `<i class="fas fa-drafting-compass"></i> ${attach.name}`;
                        } else if (attach.type === 'audio') {
                            attachItem.innerHTML = `<i class="fas fa-volume-up"></i> ${attach.name}`;
                        }
                        
                        attachmentsList.appendChild(attachItem);
                    });
                }
            }
            
            document.getElementById('edit-journal-btn').onclick = function() {
                hideAllModals();
                editJournalEntry(id);
            };
            
            document.getElementById('delete-journal-btn').onclick = function() {
                if (confirm('Вы уверены, что хотите удалить эту запись?')) {
                    deleteJournalEntry(id);
                    hideAllModals();
                }
            };
            
            document.getElementById('print-journal-btn').onclick = function() {
                printJournalEntry(entry);
            };
            
            showModal('view-journal-modal');
        };
        
        window.editJournalEntry = function(id) {
            const entry = journalEntries.find(e => e.id === id);
            if (!entry) return;
            
            showPage('field-journal-page');
            
            setTimeout(() => {
                document.getElementById('journal-title').value = entry.title;
                document.getElementById('journal-date').value = entry.date;
                document.getElementById('journal-category').value = entry.category;
                document.getElementById('journal-content').value = entry.content;
                
                document.getElementById('journal-title').scrollIntoView({ behavior: 'smooth' });
                
                showAlert('Запись загружена для редактирования', 'info');
            }, 100);
        };
        
        window.deleteJournalEntry = function(id) {
            if (confirm('Вы уверены, что хотите удалить эту запись?')) {
                const index = journalEntries.findIndex(e => e.id === id);
                if (index !== -1) {
                    journalEntries.splice(index, 1);
                    OFFLINE_STORAGE.remove(`journal_${id}`);
                    updateJournalEntriesList();
                    showAlert('Запись удалена', 'success');
                }
            }
        };
        
        function printJournalEntry(entry) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>${entry.title} - ArchaeoPoint</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #8B4513; }
                        .meta { color: #666; margin-bottom: 20px; }
                        .content { margin-top: 20px; white-space: pre-wrap; }
                        .footer { margin-top: 40px; font-size: 12px; color: #999; }
                    </style>
                </head>
                <body>
                    <h1>${entry.title}</h1>
                    <div class="meta">
                        <p><strong>Дата:</strong> ${entry.date}</p>
                        <p><strong>Автор:</strong> ${entry.author}</p>
                        <p><strong>Категория:</strong> ${getCategoryName(entry.category)}</p>
                    </div>
                    <div class="content">${entry.content}</div>
                    <div class="footer">
                        <p>Распечатано из ArchaeoPoint: ${new Date().toLocaleString()}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        function exportJournal() {
            if (journalEntries.length === 0) {
                showAlert('Нет записей для экспорта', 'warning');
                return;
            }
            
            const exportData = {
                exportedAt: new Date().toISOString(),
                expedition: "Экспедиция Крым-2023",
                totalEntries: journalEntries.length,
                entries: journalEntries
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `archaeopoint-journal-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert('Журнал экспортирован в JSON файл', 'success');
        }
        
        function addSampleArtifacts() {
            const sampleArtifacts = [
                {
                    id: 1,
                    name: "Бронзовое зеркало",
                    type: "metal",
                    lat: 44.948237,
                    lng: 34.100318,
                    alt: 125.5,
                    date: "2023-06-10",
                    depth: 45,
                    context: "Квадрат 5А, культурный слой III",
                    description: "Бронзовое зеркало с орнаментом по краю",
                    discoveredBy: "Иван Археологов",
                    layer: "layer3",
                    photos: [],
                    synced: true
                },
                {
                    id: 2,
                    name: "Золотая подвеска",
                    type: "gold",
                    lat: 44.948537,
                    lng: 34.100618,
                    alt: 126.2,
                    date: "2023-06-12",
                    depth: 32,
                    context: "Квадрат 5Б, погребение №3",
                    description: "Золотая подвеска с изображением орла",
                    discoveredBy: "Мария Петрова",
                    layer: "layer2",
                    photos: [],
                    synced: true
                },
                {
                    id: 3,
                    name: "Керамический сосуд",
                    type: "ceramic",
                    lat: 44.947937,
                    lng: 34.100018,
                    alt: 124.8,
                    date: "2023-06-08",
                    depth: 58,
                    context: "Квадрат 4В, жилой слой",
                    description: "Фрагменты керамического сосуда",
                    discoveredBy: "Алексей Смирнов",
                    layer: "layer3",
                    photos: [],
                    synced: true
                }
            ];
            
            artifacts = sampleArtifacts;
            updateArtifactsOnMap();
            updateArtifactsTable();
            updateStatistics();
            
            artifacts.forEach(artifact => {
                OFFLINE_STORAGE.save(`artifact_${artifact.id}`, artifact);
            });
            
            OFFLINE_STORAGE.updatePendingSync();
        }
        
        function updateArtifactsOnMap() {
            if (!markersCluster) return;
            
            markersCluster.clearLayers();
            artifactMarkers = [];
            
            const selectedTypes = [];
            document.querySelectorAll('input[name="artifact-type"]:checked').forEach(checkbox => {
                selectedTypes.push(checkbox.value);
            });
            
            const artifactColors = {
                gold: '#FFD700',
                ceramic: '#8B4513',
                bones: '#F5F5DC',
                metal: '#C0C0C0',
                stone: '#808080',
                other: '#9370DB'
            };
            
            artifacts.forEach(artifact => {
                if (selectedTypes.includes(artifact.type)) {
                    const icon = L.divIcon({
                        html: `<div style="background-color: ${artifactColors[artifact.type]}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`,
                        className: 'artifact-marker',
                        iconSize: [24, 24]
                    });
                    
                    const marker = L.marker([artifact.lat, artifact.lng], { icon });
                    
                    const popupContent = `
                        <div class="artifact-popup">
                            <h3>${artifact.name}</h3>
                            <div style="background-color: ${artifactColors[artifact.type]}; display: inline-block; padding: 0.2rem 0.5rem; border-radius: 12px; color: ${artifact.type === 'bones' || artifact.type === 'metal' ? '#333' : 'white'}; font-size: 0.8rem;">
                                ${getArtifactTypeName(artifact.type)}
                            </div>
                            <p><strong>Дата:</strong> ${artifact.date}</p>
                            <p><strong>Глубина:</strong> ${artifact.depth} см</p>
                            <p><strong>Высота (Z):</strong> ${artifact.alt} м</p>
                            <p><strong>Нашел:</strong> ${artifact.discoveredBy}</p>
                            <p>${artifact.context}</p>
                            <button onclick="showArtifactDetails(${artifact.id})" class="btn" style="width: 100%; padding: 0.25rem; font-size: 0.8rem;">
                                <i class="fas fa-info-circle"></i> Подробнее
                            </button>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    artifactMarkers.push(marker);
                    markersCluster.addLayer(marker);
                }
            });
            
            map.addLayer(markersCluster);
            
            if (document.getElementById('toggle-heatmap') && document.getElementById('toggle-heatmap').classList.contains('active')) {
                updateHeatmap();
            }
        }
        
        function updateHeatmap() {
            if (!map) return;
            
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
            }
            
            const heatPoints = artifacts.map(artifact => [artifact.lat, artifact.lng, 1]);
            
            heatmapLayer = L.heatLayer(heatPoints, {
                radius: 25,
                blur: 15,
                maxZoom: 17,
                gradient: {0.4: 'blue', 0.6: 'cyan', 0.7: 'lime', 0.8: 'yellow', 1.0: 'red'}
            });
            
            map.addLayer(heatmapLayer);
            
            const legend = document.getElementById('heatmap-legend');
            if (legend) {
                legend.style.display = 'block';
            }
        }
        
        function getArtifactTypeName(type) {
            const typeNames = {
                gold: "Золотые изделия",
                ceramic: "Керамика",
                bones: "Костные останки",
                metal: "Металлические изделия",
                stone: "Каменные изделия",
                other: "Прочие находки"
            };
            return typeNames[type] || "Неизвестный тип";
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            initNetworkMonitoring();
            initPWA();
            initEventHandlers();
            initTestData();
            startSyncService();
        });
        
        function initNetworkMonitoring() {
            updateOnlineStatus();
            
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
        }
        
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            
            if (isOnline) {
                document.getElementById('offline-notification').classList.remove('show');
                document.getElementById('sync-status').classList.remove('offline');
                
                syncPendingData();
            } else {
                document.getElementById('offline-notification').classList.add('show');
                document.getElementById('sync-status').className = 'sync-status offline';
                document.getElementById('sync-status').innerHTML = `<i class="fas fa-wifi-slash"></i> Офлайн`;
            }
        }
        
        function initPWA() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(error => {
                    console.log('Ошибка регистрации Service Worker:', error);
                });
                
                let deferredPrompt;
                
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    
                    const installBtn = document.getElementById('install-app-btn');
                    if (installBtn) {
                        installBtn.style.display = 'inline-block';
                        
                        installBtn.addEventListener('click', () => {
                            deferredPrompt.prompt();
                            
                            deferredPrompt.userChoice.then((choiceResult) => {
                                if (choiceResult.outcome === 'accepted') {
                                    console.log('Пользователь установил приложение');
                                }
                                deferredPrompt = null;
                            });
                        });
                    }
                });
                
                window.addEventListener('appinstalled', () => {
                    console.log('Приложение установлено');
                    const installBtn = document.getElementById('install-app-btn');
                    if (installBtn) {
                        installBtn.style.display = 'none';
                    }
                });
            }
            
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                console.log('Приложение запущено в standalone режиме');
            }
        }
        
        function initEventHandlers() {
            document.getElementById('show-register').addEventListener('click', function() {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
            });
            
            document.getElementById('show-login').addEventListener('click', function() {
                document.getElementById('register-form').style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
            });
            
            document.getElementById('enable-2fa').addEventListener('click', function() {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('two-factor-form').style.display = 'block';
            });
            
            document.getElementById('back-to-login').addEventListener('click', function() {
                document.getElementById('two-factor-form').style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
            });
            
            document.getElementById('login-btn').addEventListener('click', function() {
                const token = document.getElementById('login-token').value;
                const password = document.getElementById('login-password').value;
                
                if (token && password) {
                    loginUser(token, password);
                } else {
                    showAlert('Заполните все поля для входа', 'danger');
                }
            });
            
            document.getElementById('verify-2fa-btn').addEventListener('click', function() {
                const code = Array.from(document.querySelectorAll('.two-factor-code input'))
                    .map(input => input.value)
                    .join('');
                
                if (code.length === 6) {
                    loginUser('admin@archaeopoint.ru', 'admin123', true);
                } else {
                    showAlert('Введите полный 6-значный код', 'danger');
                }
            });
            
            document.getElementById('register-btn').addEventListener('click', function() {
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const expedition = document.getElementById('register-expedition').value;
                
                if (name && email && expedition) {
                    showAlert('Запрос доступа отправлен начальнику экспедиции. Вы получите уведомление на email после подтверждения.', 'success');
                    document.getElementById('register-form').style.display = 'none';
                    document.getElementById('login-form').style.display = 'block';
                    
                    document.getElementById('register-name').value = '';
                    document.getElementById('register-email').value = '';
                    document.getElementById('register-expedition').value = '';
                    document.getElementById('register-message').value = '';
                } else {
                    showAlert('Заполните обязательные поля: ФИО, Email и Название экспедиции', 'danger');
                }
            });
            
            document.getElementById('theme-toggle').addEventListener('click', function() {
                const isDarkMode = document.body.classList.toggle('dark-mode');
                const icon = this.querySelector('i');
                
                if (isDarkMode) {
                    icon.className = 'fas fa-sun';
                    localStorage.setItem('archaeopoint_theme', 'dark');
                } else {
                    icon.className = 'fas fa-moon';
                    localStorage.setItem('archaeopoint_theme', 'light');
                }
            });
            
            document.getElementById('enable-dark-mode').addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-mode');
                    const themeIcon = document.querySelector('#theme-toggle i');
                    if (themeIcon) {
                        themeIcon.className = 'fas fa-sun';
                    }
                    localStorage.setItem('archaeopoint_theme', 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    const themeIcon = document.querySelector('#theme-toggle i');
                    if (themeIcon) {
                        themeIcon.className = 'fas fa-moon';
                    }
                    localStorage.setItem('archaeopoint_theme', 'light');
                }
            });
            
            document.querySelectorAll('nav a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.id.replace('nav-', '') + '-page';
                    showPage(pageId);
                    
                    if (pageId === 'field-journal-page') {
                        setTimeout(initFieldJournal, 100);
                    }
                });
            });
            
            document.getElementById('goto-map-btn').addEventListener('click', function() {
                showPage('map-page');
            });
            
            document.getElementById('quick-add-artifact').addEventListener('click', function() {
                showModal('artifact-modal');
            });
            
            document.querySelectorAll('input[name="map-layer"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    console.log('Выбран слой:', this.value);
                });
            });
            
            document.querySelectorAll('input[name="artifact-type"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateArtifactsOnMap();
                });
            });
            
            document.getElementById('add-artifact-btn').addEventListener('click', function() {
                showModal('artifact-modal');
            });
            
            document.getElementById('center-map-btn').addEventListener('click', function() {
                if (artifacts.length > 0 && map) {
                    const bounds = L.latLngBounds(artifacts.map(a => [a.lat, a.lng]));
                    map.fitBounds(bounds, { padding: [50, 50] });
                } else if (map) {
                    map.setView([44.948237, 34.100318], 16);
                }
            });
            
            document.getElementById('show-legend-btn').addEventListener('click', function() {
                const legend = document.getElementById('map-legend');
                if (legend) {
                    legend.style.display = legend.style.display === 'block' ? 'none' : 'block';
                }
            });
            
            document.getElementById('toggle-heatmap').addEventListener('click', function() {
                this.classList.toggle('active');
                
                if (this.classList.contains('active')) {
                    updateHeatmap();
                    const legend = document.getElementById('heatmap-legend');
                    if (legend) {
                        legend.style.display = 'block';
                    }
                } else {
                    if (heatmapLayer && map) {
                        map.removeLayer(heatmapLayer);
                        heatmapLayer = null;
                    }
                    const legend = document.getElementById('heatmap-legend');
                    if (legend) {
                        legend.style.display = 'none';
                    }
                }
            });
            
            document.getElementById('toggle-3d').addEventListener('click', function() {
                this.classList.toggle('active');
                const visualization = document.getElementById('visualization-3d');
                
                if (this.classList.contains('active')) {
                    visualization.style.display = 'block';
                    showAlert('3D визуализация включена.', 'info');
                } else {
                    visualization.style.display = 'none';
                }
            });
            
            document.getElementById('measure-distance').addEventListener('click', function() {
                isMeasuring = !isMeasuring;
                this.classList.toggle('active');
                
                if (isMeasuring) {
                    measurementPoints = [];
                    showAlert('Режим измерения расстояний включен. Кликните на две точки на карте.', 'info');
                } else {
                    showAlert('Режим измерения расстояний выключен.', 'info');
                }
            });
            
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    hideAllModals();
                });
            });
            
            document.getElementById('cancel-artifact-btn').addEventListener('click', function() {
                hideAllModals();
            });
            
            document.getElementById('cancel-user-btn').addEventListener('click', function() {
                hideAllModals();
            });
            
            document.getElementById('cancel-batch-btn').addEventListener('click', function() {
                hideAllModals();
            });
            
            document.getElementById('get-gps-location').addEventListener('click', function() {
                if (navigator.geolocation) {
                    showProgress('Определение координат...', 30);
                    
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            const accuracy = position.coords.accuracy;
                            
                            const accuracyDeg = accuracy / 111320;
                            
                            document.getElementById('artifact-coords-lat').value = lat.toFixed(6);
                            document.getElementById('artifact-coords-lng').value = lng.toFixed(6);
                            document.getElementById('artifact-coords-alt').value = position.coords.altitude ? 
                                position.coords.altitude.toFixed(1) : '0.0';
                            
                            document.getElementById('gps-accuracy-lat').textContent = `Точность: ±${accuracyDeg.toFixed(6)}° (${accuracy.toFixed(1)} м)`;
                            document.getElementById('gps-accuracy-lng').textContent = `Точность: ±${accuracyDeg.toFixed(6)}° (${accuracy.toFixed(1)} м)`;
                            document.getElementById('gps-accuracy-alt').textContent = position.coords.altitudeAccuracy ? 
                                `Точность: ±${position.coords.altitudeAccuracy.toFixed(1)} м` : 'Точность: неизвестна';
                            
                            if (map) {
                                map.setView([lat, lng], 18);
                                
                                L.marker([lat, lng], {
                                    icon: L.divIcon({
                                        html: '<div style="background-color: #3498db; width: 15px; height: 15px; border-radius: 50%; border: 2px solid white;"></div>',
                                        iconSize: [15, 15]
                                    })
                                }).addTo(map).bindPopup('Ваше текущее местоположение').openPopup();
                            }
                            
                            hideProgress();
                            showAlert('Координаты успешно определены!', 'success');
                        },
                        function(error) {
                            hideProgress();
                            showAlert('Не удалось определить координаты. Пожалуйста, введите вручную.', 'danger');
                            console.error('Ошибка геолокации:', error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                } else {
                    showAlert('Геолокация не поддерживается вашим браузером.', 'danger');
                }
            });
            
            document.getElementById('save-artifact-btn').addEventListener('click', function() {
                saveArtifact();
            });
            
            document.getElementById('save-offline-btn').addEventListener('click', function() {
                saveArtifact(true);
            });
            
            document.getElementById('batch-upload-btn').addEventListener('click', function() {
                showModal('batch-upload-modal');
            });
            
            document.querySelector('.batch-upload-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                showModal('batch-upload-modal');
            });
            
            document.getElementById('artifact-voice-name').addEventListener('click', function() {
                startVoiceInput('artifact-name');
            });
            
            document.getElementById('artifact-voice-context').addEventListener('click', function() {
                startVoiceInput('artifact-context');
            });
            
            document.getElementById('artifact-voice-description').addEventListener('click', function() {
                startVoiceInput('artifact-description');
            });
            
            document.getElementById('photo-input').addEventListener('change', function(e) {
                const files = e.target.files;
                const preview = document.getElementById('photo-preview');
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        
                        const container = document.createElement('div');
                        container.style.position = 'relative';
                        container.appendChild(img);
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-photo';
                        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                        removeBtn.addEventListener('click', function() {
                            container.remove();
                        });
                        container.appendChild(removeBtn);
                        
                        preview.appendChild(container);
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
            
            setupJournalEventHandlers();
            
            document.getElementById('add-user-btn').addEventListener('click', function() {
                showModal('user-modal');
            });
            
            document.getElementById('manage-2fa-btn').addEventListener('click', function() {
                showModal('twofa-setup-modal');
            });
            
            document.getElementById('setup-2fa-btn').addEventListener('click', function() {
                showModal('twofa-setup-modal');
            });
            
            document.querySelectorAll('input[name="twofa-method"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'sms') {
                        document.getElementById('twofa-sms-section').style.display = 'block';
                        document.getElementById('twofa-app-section').style.display = 'none';
                    } else {
                        document.getElementById('twofa-sms-section').style.display = 'none';
                        document.getElementById('twofa-app-section').style.display = 'block';
                    }
                });
            });
            
            document.getElementById('send-sms-code-btn').addEventListener('click', function() {
                const phone = document.getElementById('twofa-phone').value;
                if (phone) {
                    showAlert(`Код подтверждения отправлен на номер ${phone}`, 'success');
                } else {
                    showAlert('Введите номер телефона', 'danger');
                }
            });
            
            document.getElementById('force-sync-btn').addEventListener('click', function() {
                syncPendingData(true);
            });
            
            document.getElementById('clear-cache-btn').addEventListener('click', function() {
                if (confirm('Вы уверены, что хотите очистить локальный кеш? Несинхронизированные данные будут утеряны.')) {
                    localStorage.clear();
                    OFFLINE_STORAGE.updatePendingSync();
                    updateStorageUsage();
                    showAlert('Локальный кеш очищен', 'success');
                }
            });
            
            document.getElementById('export-artifacts-btn').addEventListener('click', function() {
                showAlert('Функция экспорта будет доступна в полной версии системы', 'info');
            });
            
            document.getElementById('generate-report-btn').addEventListener('click', function() {
                showAlert('Отчет формируется...', 'info');
                setTimeout(() => {
                    showAlert('Отчет успешно создан и отправлен на ваш email', 'success');
                }, 2000);
            });
            
            document.getElementById('logout-btn').addEventListener('click', function() {
                logoutUser();
            });
            
            const batchDropArea = document.getElementById('batch-drop-area');
            const batchPhotoInput = document.getElementById('batch-photo-input');
            
            if (batchDropArea) {
                batchDropArea.addEventListener('click', function() {
                    if (batchPhotoInput) batchPhotoInput.click();
                });
                
                batchDropArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.style.borderColor = 'var(--primary-color)';
                    this.style.backgroundColor = 'rgba(139, 69, 19, 0.1)';
                });
                
                batchDropArea.addEventListener('dragleave', function() {
                    this.style.borderColor = '#ddd';
                    this.style.backgroundColor = '';
                });
                
                batchDropArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.borderColor = '#ddd';
                    this.style.backgroundColor = '';
                    
                    const files = e.dataTransfer.files;
                    handleBatchFiles(files);
                });
            }
            
            if (batchPhotoInput) {
                batchPhotoInput.addEventListener('change', function(e) {
                    handleBatchFiles(e.target.files);
                });
            }
            
            document.getElementById('process-batch-btn').addEventListener('click', function() {
                processBatchUpload();
            });
        }
        
        function setupJournalEventHandlers() {
            document.getElementById('start-recording-btn').addEventListener('click', startRecording);
            document.getElementById('stop-recording-btn').addEventListener('click', stopRecording);
            document.getElementById('pause-recording-btn').addEventListener('click', togglePauseRecording);
            
            document.querySelectorAll('#sketch-tools .map-tool-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    setActiveTool(this.dataset.tool);
                });
            });
            
            document.getElementById('clear-sketch-btn').addEventListener('click', clearCanvas);
            document.getElementById('save-sketch-btn').addEventListener('click', saveSketch);
            document.getElementById('load-template-btn').addEventListener('click', function() {
                showModal('templates-modal');
            });
            
            document.querySelectorAll('.use-template-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    loadTemplate(this.dataset.template);
                    hideAllModals();
                });
            });
            
            document.getElementById('save-journal-btn').addEventListener('click', saveJournalEntry);
            document.getElementById('save-draft-btn').addEventListener('click', saveJournalDraft);
            document.getElementById('new-journal-entry').addEventListener('click', newJournalEntry);
            
            document.getElementById('attach-sketch-btn').addEventListener('click', attachSketch);
            document.getElementById('attach-audio-btn').addEventListener('click', attachAudio);
            
            document.getElementById('journal-voice-btn').addEventListener('click', function() {
                startVoiceInput('journal-content');
            });
            
            document.getElementById('export-journal-btn').addEventListener('click', exportJournal);
            
            document.getElementById('apply-transcription-btn').addEventListener('click', function() {
                const transcription = document.getElementById('transcription-text').textContent;
                const journalContent = document.getElementById('journal-content');
                if (journalContent && transcription) {
                    journalContent.value += (journalContent.value ? '\n\n' : '') + transcription;
                    showAlert('Текст добавлен в запись журнала', 'success');
                }
            });
        }
        
        function handleBatchFiles(files) {
            const filesList = document.getElementById('batch-files-list');
            if (!filesList) return;
            
            filesList.innerHTML = '';
            
            for (let i = 0; i < Math.min(files.length, 100); i++) {
                const file = files[i];
                const fileItem = document.createElement('div');
                fileItem.className = 'batch-file-item';
                
                fileItem.innerHTML = `
                    <i class="fas fa-image" style="color: #666;"></i>
                    <div style="flex: 1;">
                        <div>${file.name}</div>
                        <div style="font-size: 0.8rem; color: #999;">${(file.size / 1024).toFixed(1)} KB</div>
                    </div>
                    <button class="btn btn-sm btn-danger remove-file" data-index="${i}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                filesList.appendChild(fileItem);
            }
            
            const previewTitle = document.querySelector('#batch-preview h4');
            if (previewTitle) {
                previewTitle.textContent = `Выбранные файлы (${Math.min(files.length, 100)})`;
            }
            
            document.querySelectorAll('.remove-file').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.batch-file-item').remove();
                    const currentCount = document.querySelectorAll('.batch-file-item').length;
                    const previewTitle = document.querySelector('#batch-preview h4');
                    if (previewTitle) {
                        previewTitle.textContent = `Выбранные файлы (${currentCount})`;
                    }
                });
            });
        }
        
        function processBatchUpload() {
            const fileCount = document.querySelectorAll('.batch-file-item').length;
            if (fileCount === 0) {
                showAlert('Выберите файлы для обработки', 'danger');
                return;
            }
            
            showProgress('Обработка файлов...', 0);
            
            let processed = 0;
            const interval = setInterval(() => {
                processed++;
                const progress = Math.floor((processed / fileCount) * 100);
                updateProgress(progress);
                
                if (processed >= fileCount) {
                    clearInterval(interval);
                    hideProgress();
                    hideAllModals();
                    showAlert(`Обработано ${fileCount} файлов. Создано ${fileCount} записей артефактов.`, 'success');
                }
            }, 300);
        }
        
        function checkAuth() {
            const savedUser = localStorage.getItem('archaeopoint_user');
            const savedTheme = localStorage.getItem('archaeopoint_theme');
            
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                const themeIcon = document.querySelector('#theme-toggle i');
                if (themeIcon) {
                    themeIcon.className = 'fas fa-sun';
                }
            }
            
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showMainApp();
                } catch (e) {
                    console.error('Ошибка загрузки пользователя:', e);
                    showGatekeeper();
                }
            } else {
                showGatekeeper();
            }
        }
        
        function showGatekeeper() {
            document.getElementById('gatekeeper-page').classList.add('active');
            document.getElementById('site-header').style.display = 'none';
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('site-footer').style.display = 'none';
        }
        
        function showMainApp() {
            document.getElementById('gatekeeper-page').classList.remove('active');
            document.getElementById('site-header').style.display = 'flex';
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('site-footer').style.display = 'block';
            
            updateUserInfo();
            
            if (!map) {
                initMap();
            }
            
            updateStatistics();
            updateExpeditionUsers();
            updateStorageUsage();
        }
        
        function loginUser(token, password, use2fa = false) {
            showProgress('Вход в систему...', 50);
            
            setTimeout(() => {
                hideProgress();
                
                if ((token === 'admin@archaeopoint.ru' && password === 'admin123') || 
                    (token === 'expedition_token_2023' && password === 'archaeo2023')) {
                    
                    currentUser = {
                        id: 1,
                        name: 'Иван Археологов',
                        email: 'admin@archaeopoint.ru',
                        role: 'archaeologist',
                        expedition: 'Крым-2023',
                        avatar: 'ИИ',
                        uses2fa: use2fa
                    };
                    
                    localStorage.setItem('archaeopoint_user', JSON.stringify(currentUser));
                    
                    showMainApp();
                    
                    showAlert('Вход выполнен успешно! Добро пожаловать в ArchaeoPoint!', 'success');
                } else {
                    showAlert('Неверный токен или пароль. Используйте: admin@archaeopoint.ru / admin123', 'danger');
                }
            }, 1500);
        }
        
        function logoutUser() {
            if (confirm('Вы уверены, что хотите выйти из системы?')) {
                currentUser = null;
                localStorage.removeItem('archaeopoint_user');
                showGatekeeper();
                showAlert('Вы вышли из системы', 'info');
            }
        }
        
        function updateUserInfo() {
            if (!currentUser) return;
            
            const userName = document.getElementById('user-name');
            const userRole = document.getElementById('user-role');
            const userAvatar = document.getElementById('user-avatar');
            const profileName = document.getElementById('profile-name');
            const profileRole = document.getElementById('profile-role');
            const profileAvatar = document.getElementById('profile-avatar');
            
            if (userName) userName.textContent = currentUser.name;
            if (userRole) userRole.textContent = getRoleName(currentUser.role);
            if (userAvatar) userAvatar.textContent = currentUser.avatar;
            if (profileName) profileName.textContent = currentUser.name;
            if (profileRole) profileRole.textContent = getRoleName(currentUser.role);
            if (profileAvatar) profileAvatar.textContent = currentUser.avatar;
        }
        
        function getRoleName(role) {
            const roles = {
                admin: 'Администратор',
                archaeologist: 'Археолог',
                assistant: 'Помощник',
                student: 'Студент',
                researcher: 'Исследователь'
            };
            return roles[role] || role;
        }
        
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            const page = document.getElementById(pageId);
            if (page) {
                page.classList.add('active');
                
                updateNavigation(pageId);
                
                window.scrollTo(0, 0);
                
                if (pageId === 'map-page' && map) {
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 100);
                }
                
                if (pageId === 'field-journal-page') {
                    setTimeout(() => {
                        initFieldJournal();
                        updateJournalEntriesList();
                    }, 100);
                }
            }
        }
        
        function updateNavigation(activePageId) {
            const navLinks = document.querySelectorAll('nav a');
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.id === 'nav-' + activePageId.replace('-page', '')) {
                    link.classList.add('active');
                }
            });
        }
        
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }
        
        function hideAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
            document.body.style.overflow = '';
        }
        
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
                <button class="close-alert" style="float: right; background: none; border: none; font-size: 1rem;">&times;</button>
            `;
            
            const main = document.getElementById('main-content');
            if (main) {
                main.insertBefore(alertDiv, main.firstChild);
                
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.style.opacity = '0';
                        alertDiv.style.transition = 'opacity 0.5s';
                        setTimeout(() => {
                            if (alertDiv.parentNode) {
                                alertDiv.parentNode.removeChild(alertDiv);
                            }
                        }, 500);
                    }
                }, 5000);
                
                alertDiv.querySelector('.close-alert').addEventListener('click', function() {
                    alertDiv.style.opacity = '0';
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.parentNode.removeChild(alertDiv);
                        }
                    }, 500);
                });
            }
        }
        
        function showProgress(message, initialValue = 0) {
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.width = initialValue + '%';
                progressBar.style.display = 'block';
            }
        }
        
        function updateProgress(value) {
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.width = value + '%';
            }
        }
        
        function hideProgress() {
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.display = 'none';
                progressBar.style.width = '0%';
            }
        }
        
        function saveArtifact(offlineOnly = false) {
            const name = document.getElementById('artifact-name').value;
            const type = document.getElementById('artifact-type').value;
            const date = document.getElementById('artifact-date').value;
            const layer = document.getElementById('artifact-layer').value;
            const lat = parseFloat(document.getElementById('artifact-coords-lat').value);
            const lng = parseFloat(document.getElementById('artifact-coords-lng').value);
            const alt = parseFloat(document.getElementById('artifact-coords-alt').value);
            const depth = document.getElementById('artifact-depth').value;
            const context = document.getElementById('artifact-context').value;
            const description = document.getElementById('artifact-description').value;
            
            if (!name || !type || !date) {
                showAlert('Заполните обязательные поля: название, тип и дата', 'danger');
                return;
            }
            
            if (isNaN(lat) || isNaN(lng)) {
                showAlert('Введите корректные координаты', 'danger');
                return;
            }
            
            const artifact = {
                id: artifacts.length + 1,
                name: name,
                type: type,
                lat: lat,
                lng: lng,
                alt: alt || 0,
                date: date,
                depth: depth || 0,
                context: context,
                description: description,
                discoveredBy: currentUser ? currentUser.name : 'Неизвестный пользователь',
                layer: layer || '',
                photos: [],
                synced: !offlineOnly && isOnline,
                createdAt: new Date().toISOString()
            };
            
            artifacts.push(artifact);
            
            updateArtifactsOnMap();
            updateArtifactsTable();
            updateStatistics();
            
            OFFLINE_STORAGE.save(`artifact_${artifact.id}`, artifact);
            
            if (offlineOnly) {
                showAlert('Артефакт сохранен локально. Будет синхронизирован при появлении сети.', 'warning');
            } else {
                showAlert('Артефакт успешно сохранен и синхронизирован', 'success');
            }
            
            hideAllModals();
            clearArtifactForm();
        }
        
        function clearArtifactForm() {
            document.getElementById('artifact-name').value = '';
            document.getElementById('artifact-type').value = '';
            document.getElementById('artifact-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('artifact-layer').value = '';
            document.getElementById('artifact-coords-lat').value = '44.948237';
            document.getElementById('artifact-coords-lng').value = '34.100318';
            document.getElementById('artifact-coords-alt').value = '125.5';
            document.getElementById('artifact-depth').value = '';
            document.getElementById('artifact-context').value = '';
            document.getElementById('artifact-description').value = '';
            document.getElementById('photo-preview').innerHTML = '';
            document.getElementById('ai-suggestion').style.display = 'none';
        }
        
        function updateArtifactsTable() {
            const tableBody = document.getElementById('artifacts-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            artifacts.forEach(artifact => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>AP-${artifact.id.toString().padStart(3, '0')}</td>
                    <td>${artifact.name}</td>
                    <td>
                        <span class="color-indicator artifact-${artifact.type}"></span>
                        ${getArtifactTypeName(artifact.type)}
                    </td>
                    <td>${artifact.date}</td>
                    <td>${artifact.lat.toFixed(6)}, ${artifact.lng.toFixed(6)}, ${artifact.alt ? artifact.alt.toFixed(1) : '0.0'}м</td>
                    <td>${artifact.discoveredBy}</td>
                    <td>${artifact.layer ? artifact.layer.replace('layer', 'Слой ') : 'Не указан'}</td>
                    <td>
                        <button class="btn btn-sm" onclick="showArtifactDetails(${artifact.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="editArtifact(${artifact.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-info" onclick="generateArtifactQR(${artifact.id})">
                            <i class="fas fa-qrcode"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        window.showArtifactDetails = function(id) {
            const artifact = artifacts.find(a => a.id === id);
            if (!artifact) return;
            
            const details = `
                <h3>${artifact.name}</h3>
                <p><strong>Тип:</strong> ${getArtifactTypeName(artifact.type)}</p>
                <p><strong>Дата находки:</strong> ${artifact.date}</p>
                <p><strong>Координаты:</strong> ${artifact.lat.toFixed(6)}°, ${artifact.lng.toFixed(6)}°</p>
                <p><strong>Высота (Z):</strong> ${artifact.alt ? artifact.alt.toFixed(1) + ' м' : 'Не указана'}</p>
                <p><strong>Глубина:</strong> ${artifact.depth ? artifact.depth + ' см' : 'Не указана'}</p>
                <p><strong>Слой:</strong> ${artifact.layer ? artifact.layer.replace('layer', 'Слой ') : 'Не указан'}</p>
                <p><strong>Контекст:</strong> ${artifact.context || 'Не указан'}</p>
                <p><strong>Описание:</strong> ${artifact.description || 'Не указано'}</p>
                <p><strong>Нашел:</strong> ${artifact.discoveredBy}</p>
                <p><strong>Статус:</strong> ${artifact.synced ? 'Синхронизирован' : 'Только локально'}</p>
            `;
            
            showAlert(details, 'info');
        };
        
        window.editArtifact = function(id) {
            const artifact = artifacts.find(a => a.id === id);
            if (!artifact) return;
            
            document.getElementById('artifact-name').value = artifact.name;
            document.getElementById('artifact-type').value = artifact.type;
            document.getElementById('artifact-date').value = artifact.date;
            document.getElementById('artifact-layer').value = artifact.layer;
            document.getElementById('artifact-coords-lat').value = artifact.lat;
            document.getElementById('artifact-coords-lng').value = artifact.lng;
            document.getElementById('artifact-coords-alt').value = artifact.alt;
            document.getElementById('artifact-depth').value = artifact.depth;
            document.getElementById('artifact-context').value = artifact.context;
            document.getElementById('artifact-description').value = artifact.description;
            
            showModal('artifact-modal');
            
            const saveBtn = document.getElementById('save-artifact-btn');
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Обновить артефакт';
                saveBtn.onclick = function() {
                    updateArtifact(id);
                };
            }
        };
        
        function updateArtifact(id) {
            const artifact = artifacts.find(a => a.id === id);
            if (!artifact) return;
            
            artifact.name = document.getElementById('artifact-name').value;
            artifact.type = document.getElementById('artifact-type').value;
            artifact.date = document.getElementById('artifact-date').value;
            artifact.layer = document.getElementById('artifact-layer').value;
            artifact.lat = parseFloat(document.getElementById('artifact-coords-lat').value);
            artifact.lng = parseFloat(document.getElementById('artifact-coords-lng').value);
            artifact.alt = parseFloat(document.getElementById('artifact-coords-alt').value);
            artifact.depth = document.getElementById('artifact-depth').value;
            artifact.context = document.getElementById('artifact-context').value;
            artifact.description = document.getElementById('artifact-description').value;
            
            OFFLINE_STORAGE.save(`artifact_${id}`, artifact);
            
            updateArtifactsOnMap();
            updateArtifactsTable();
            
            clearArtifactForm();
            const saveBtn = document.getElementById('save-artifact-btn');
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Сохранить артефакт';
                saveBtn.onclick = function() {
                    saveArtifact();
                };
            }
            
            hideAllModals();
            showAlert('Артефакт обновлен', 'success');
        }
        
        window.generateArtifactQR = function(id) {
            const artifact = artifacts.find(a => a.id === id);
            if (!artifact) return;
            
            document.getElementById('qr-artifact-name').textContent = artifact.name;
            document.getElementById('qr-artifact-id').textContent = `ID: AP-${artifact.id.toString().padStart(3, '0')}`;
            
            const qrDisplay = document.getElementById('qr-code-display');
            if (qrDisplay) {
                qrDisplay.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; color: #333;">QR</div>
                        <div style="font-size: 0.8rem;">ArchaeoPoint</div>
                        <div style="font-size: 0.7rem; margin-top: 0.5rem;">AP-${artifact.id.toString().padStart(3, '0')}</div>
                    </div>
                `;
            }
            
            showModal('qr-modal');
        };
        
        function updateStatistics() {
            document.getElementById('total-artifacts').textContent = artifacts.length;
            document.getElementById('today-artifacts').textContent = getTodayArtifactsCount();
            document.getElementById('last-week').textContent = getLastWeekArtifactsCount();
            
            if (currentUser) {
                const userArtifacts = artifacts.filter(a => a.discoveredBy === currentUser.name);
                document.getElementById('user-artifacts').textContent = userArtifacts.length;
                
                updateUserArtifactsList(userArtifacts);
            }
        }
        
        function getTodayArtifactsCount() {
            const today = new Date().toISOString().split('T')[0];
            return artifacts.filter(a => a.date === today).length;
        }
        
        function getLastWeekArtifactsCount() {
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const oneWeekAgoStr = oneWeekAgo.toISOString().split('T')[0];
            
            return artifacts.filter(a => a.date >= oneWeekAgoStr).length;
        }
        
        function updateUserArtifactsList(userArtifacts) {
            const list = document.getElementById('user-artifacts-list');
            if (!list) return;
            
            list.innerHTML = '';
            
            const recentArtifacts = userArtifacts.slice(-5).reverse();
            
            recentArtifacts.forEach(artifact => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${artifact.name}</td>
                    <td>${getArtifactTypeName(artifact.type)}</td>
                    <td>${artifact.date}</td>
                    <td>${artifact.lat.toFixed(4)}°, ${artifact.lng.toFixed(4)}°</td>
                `;
                list.appendChild(row);
            });
        }
        
        function initTestData() {
            users = [
                { id: 1, name: 'Иван Археологов', role: 'archaeologist', expedition: 'Крым-2023', email: 'ivan@example.com' },
                { id: 2, name: 'Мария Петрова', role: 'archaeologist', expedition: 'Крым-2023', email: 'maria@example.com' },
                { id: 3, name: 'Алексей Смирнов', role: 'assistant', expedition: 'Крым-2023', email: 'alex@example.com' },
                { id: 4, name: 'Екатерина Волкова', role: 'student', expedition: 'Крым-2023', email: 'ekaterina@example.com' },
                { id: 5, name: 'Дмитрий Козлов', role: 'researcher', expedition: 'Крым-2023', email: 'dmitry@example.com' }
            ];
            
            expeditions = [
                { id: 1, name: 'Крым-2023', location: 'Крым, Бахчисарайский район', startDate: '2023-06-01', endDate: '2023-08-31' },
                { id: 2, name: 'Великий Новгород-2023', location: 'Новгородская область', startDate: '2023-07-15', endDate: '2023-09-15' }
            ];
            
            const changeLog = [
                { date: '2023-06-15 10:30', action: 'Добавлен артефакт "Бронзовое зеркало"', user: 'Иван Археологов' },
                { date: '2023-06-15 11:45', action: 'Обновлена карта раскопок', user: 'Мария Петрова' },
                { date: '2023-06-14 09:20', action: 'Добавлена запись в полевой журнал', user: 'Алексей Смирнов' },
                { date: '2023-06-14 16:10', action: 'Экспортированы данные артефактов', user: 'Иван Археологов' }
            ];
            
            const changeLogBody = document.getElementById('change-log');
            if (changeLogBody) {
                changeLogBody.innerHTML = '';
                changeLog.forEach(log => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${log.date}</td>
                        <td>${log.action}</td>
                        <td>${log.user}</td>
                    `;
                    changeLogBody.appendChild(row);
                });
            }
        }
        
        function updateExpeditionUsers() {
            const usersList = document.getElementById('expedition-users');
            if (!usersList) return;
            
            usersList.innerHTML = '';
            
            users.forEach(user => {
                const li = document.createElement('li');
                li.className = 'user-item';
                li.innerHTML = `
                    <div>
                        <strong>${user.name}</strong>
                        <div style="font-size: 0.8rem; color: #666;">${user.email}</div>
                    </div>
                    <span class="user-role role-${user.role}">${getRoleName(user.role)}</span>
                `;
                usersList.appendChild(li);
            });
            
            document.getElementById('total-users').textContent = users.length;
        }
        
        function updateStorageUsage() {
            const storageUsage = OFFLINE_STORAGE.getStorageUsage();
            document.getElementById('storage-usage').textContent = `${storageUsage} MB`;
        }
        
        function startVoiceInput(targetId) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showAlert('Голосовой ввод не поддерживается вашим браузером', 'warning');
                return;
            }
            
            const targetElement = document.getElementById(targetId);
            const voiceButton = document.querySelector(`#${targetId.replace('-', '-voice-')}`);
            
            if (!targetElement) return;
            
            if (voiceButton) {
                voiceButton.classList.add('listening');
                voiceButton.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            }
            
            targetElement.classList.add('voice-input-active');
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'ru-RU';
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                
                if (targetElement.tagName === 'TEXTAREA') {
                    targetElement.value += (targetElement.value ? ' ' : '') + transcript;
                } else {
                    targetElement.value = transcript;
                }
                
                resetVoiceInputUI(targetId, voiceButton, targetElement);
                
                showAlert('Текст распознан и добавлен', 'success');
            };
            
            recognition.onerror = function(event) {
                resetVoiceInputUI(targetId, voiceButton, targetElement);
                
                if (event.error === 'not-allowed') {
                    showAlert('Доступ к микрофону запрещен. Разрешите доступ в настройках браузера.', 'danger');
                } else {
                    showAlert('Ошибка распознавания речи. Попробуйте еще раз.', 'danger');
                }
            };
            
            recognition.start();
            isListening = true;
            
            setTimeout(() => {
                if (isListening) {
                    recognition.stop();
                    resetVoiceInputUI(targetId, voiceButton, targetElement);
                }
            }, 10000);
        }
        
        function resetVoiceInputUI(targetId, voiceButton, targetElement) {
            isListening = false;
            
            if (voiceButton) {
                voiceButton.classList.remove('listening');
                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
            }
            
            if (targetElement) {
                targetElement.classList.remove('voice-input-active');
            }
        }
        
        function startSyncService() {
            setInterval(() => {
                if (isOnline && pendingSync.length > 0) {
                    syncPendingData();
                }
            }, CONFIG.SYNC_INTERVAL);
        }
        
        function syncPendingData(force = false) {
            if (!isOnline || pendingSync.length === 0) return;
            
            if (force) {
                showProgress('Синхронизация данных...', 0);
            }
            
            let syncedCount = 0;
            const totalCount = pendingSync.length;
            
            const syncInterval = setInterval(() => {
                syncedCount++;
                const progress = Math.floor((syncedCount / totalCount) * 100);
                
                if (force) {
                    updateProgress(progress);
                }
                
                if (syncedCount >= totalCount) {
                    clearInterval(syncInterval);
                    
                    pendingSync.forEach(item => {
                        const data = OFFLINE_STORAGE.load(item.key);
                        if (data) {
                            data.synced = true;
                            OFFLINE_STORAGE.save(item.key, data);
                        }
                    });
                    
                    OFFLINE_STORAGE.updatePendingSync();
                    
                    if (force) {
                        hideProgress();
                        showAlert(`Синхронизировано ${totalCount} записей`, 'success');
                    }
                    
                    updateArtifactsOnMap();
                }
            }, 200);
        }
        
        window.addEventListener('resize', function() {
            if (map) {
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
            
            if (canvas) {
                setupCanvas();
            }
        });
        
        window.addEventListener('load', function() {
            const firstVisit = !localStorage.getItem('archaeopoint_first_visit');
            if (firstVisit && currentUser) {
                setTimeout(() => {
                    showAlert('Добро пожаловать в ArchaeoPoint! Для начала работы перейдите на карту раскопок или добавьте первый артефакт.', 'info');
                    localStorage.setItem('archaeopoint_first_visit', 'true');
                }, 1000);
            }
        });
    </script>
</body>
</html>
